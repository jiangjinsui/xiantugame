<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»™é€”Â·é€†å‘½å½•</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080f;--panel:#101020;--card:#161630;--border:#252550;--gold:#d4a843;--cyan:#5ce0d8;--pink:#e87ca0;--text:#c8c8e0;--dim:#6a6a8a;--danger:#e85050;--green:#50c878;--purple:#a070e0}
body{font-family:'Microsoft YaHei','PingFang SC',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
button{cursor:pointer;font-family:inherit}input,textarea,select{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;height:48px}
.topbar .logo{display:flex;align-items:center;gap:8px}
.topbar .logo h1{font-size:16px;color:var(--gold);text-shadow:0 0 15px rgba(212,168,67,.3)}
.topbar .pinfo{display:flex;align-items:center;gap:12px;font-size:11px}
.topbar .pinfo .pn{color:var(--cyan);font-weight:bold;font-size:13px}
.topbar .pinfo .pr{color:var(--gold)}
.mini-bars{display:flex;gap:8px;align-items:center}
.mini-bar{width:60px;height:4px;background:#1a1a2e;border-radius:2px;overflow:hidden}
.mini-bar .mf{height:100%;border-radius:2px;transition:width .5s}
.sf-hp{background:linear-gradient(90deg,#e85050,#ff7070)}
.sf-mp{background:linear-gradient(90deg,#5070e8,#70a0ff)}
.sf-exp{background:linear-gradient(90deg,#d4a843,#f0d060)}
.main-content{flex:1;overflow:hidden;position:relative}
.page{display:none;flex-direction:column;height:100%;position:absolute;inset:0}.page.active{display:flex}
.page-hd{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;align-items:center;justify-content:space-between}
.page-hd h2{font-size:16px;color:var(--gold);display:flex;align-items:center;gap:6px}
.page-bd{flex:1;overflow-y:auto;padding:16px}
.bottomnav{display:flex;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0;height:56px}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:none;border:none;color:var(--dim);font-size:9px;transition:all .2s;position:relative}
.nb .ni{font-size:18px}
.nb:hover{color:var(--text);background:rgba(92,224,216,.03)}
.nb.active{color:var(--cyan)}
.nb.active::after{content:'';position:absolute;top:0;left:25%;right:25%;height:2px;background:var(--cyan);border-radius:0 0 2px 2px}
.chat-header{padding:10px 16px;border-bottom:1px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:space-between}
.chat-header .ch-name{font-size:14px;color:var(--cyan);font-weight:bold}
.chat-header .ch-info{font-size:10px;color:var(--dim);margin-left:8px}
.chat-header select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:6px;font-size:11px}
.msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:78%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.75;white-space:pre-wrap;word-break:break-word;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.sys{align-self:center;max-width:90%;background:rgba(212,168,67,.08);border:1px solid rgba(212,168,67,.15);color:var(--gold);font-size:11px;text-align:center;border-radius:8px}
.msg.user{align-self:flex-end;background:linear-gradient(135deg,rgba(92,224,216,.12),rgba(92,224,216,.06));border:1px solid rgba(92,224,216,.12)}
.msg.ai{align-self:flex-start;background:var(--card);border:1px solid var(--border)}
.msg .ms{font-size:10px;color:var(--dim);margin-bottom:3px}
.msg-remote{border-left:2px solid var(--purple)!important}
.chat-actions{padding:4px 12px;background:var(--panel);border-top:1px solid var(--border);display:flex;gap:4px;flex-wrap:wrap;justify-content:center}
.abtn{padding:4px 10px;border:1px solid var(--border);background:none;color:var(--pink);border-radius:12px;font-size:10px;transition:all .2s;white-space:nowrap}
.abtn:hover{border-color:var(--pink);background:rgba(232,124,160,.08)}
.abtn.cyan{color:var(--cyan)}.abtn.cyan:hover{border-color:var(--cyan);background:rgba(92,224,216,.08)}
.chat-input{padding:10px 14px;border-top:1px solid var(--border);background:var(--panel);display:flex;gap:8px;align-items:flex-end}
.chat-input textarea{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;resize:none;font-size:13px;min-height:38px;max-height:90px}
.chat-input textarea:focus{outline:0;border-color:var(--cyan)}
.sbtn{padding:8px 16px;background:linear-gradient(135deg,var(--cyan),#40b0a8);border:none;color:var(--bg);font-weight:bold;border-radius:10px;font-size:12px;white-space:nowrap}
.sbtn:disabled{opacity:.35;cursor:not-allowed}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .25s}
.card:hover{border-color:rgba(92,224,216,.4);transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.card .cn{font-size:14px;font-weight:bold;color:var(--cyan)}
.card .cr{font-size:10px;color:var(--gold);margin-top:2px}
.card .cd{font-size:11px;color:var(--dim);margin-top:5px;line-height:1.5;max-height:44px;overflow:hidden}
.card .ctags{display:flex;flex-wrap:wrap;gap:3px;margin-top:6px}
.tag{padding:1px 6px;border-radius:6px;font-size:9px}
.tag-p{background:rgba(232,124,160,.1);color:var(--pink)}.tag-c{background:rgba(92,224,216,.1);color:var(--cyan)}.tag-g{background:rgba(80,200,120,.1);color:var(--green)}.tag-u{background:rgba(160,112,224,.1);color:var(--purple)}
.card .cbtns{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.card .cbtns button{padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text);font-size:10px;transition:all .2s}
.card .cbtns button:hover{border-color:var(--cyan);color:var(--cyan)}
.card .cbtns .bdel:hover{border-color:var(--danger);color:var(--danger)}
.rel-bar{height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;margin-top:3px}
.rel-fill{height:100%;background:linear-gradient(90deg,var(--pink),#ff70a0);border-radius:3px;transition:width .3s}
.cult-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.cult-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;text-align:center;transition:all .3s;position:relative;overflow:hidden}
.cult-card::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 120%,rgba(92,224,216,.05),transparent);pointer-events:none}
.cult-card:hover{border-color:rgba(92,224,216,.3);transform:translateY(-3px)}
.cult-card .ci{font-size:36px;margin-bottom:8px}
.cult-card .ct{font-size:14px;font-weight:bold;color:var(--gold)}
.cult-card .cdesc{font-size:10px;color:var(--dim);margin-top:5px;line-height:1.5}
.cult-card .cbtn{margin-top:12px;padding:7px 20px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(135deg,rgba(92,224,216,.1),rgba(92,224,216,.02));color:var(--cyan);font-size:11px;font-weight:bold;transition:all .2s}
.cult-card .cbtn:hover{background:linear-gradient(135deg,rgba(92,224,216,.2),rgba(92,224,216,.05));border-color:var(--cyan)}
.cult-card .cbtn:disabled{opacity:.3;cursor:not-allowed}
.cult-result{margin-top:10px;padding:8px;background:rgba(212,168,67,.06);border:1px solid rgba(212,168,67,.12);border-radius:8px;font-size:10px;color:var(--gold);line-height:1.6;display:none;text-align:left}
.realm-banner{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;position:relative;overflow:hidden}
.realm-banner::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(160,112,224,.06),rgba(92,224,216,.04));pointer-events:none}
.realm-banner h3{color:var(--purple);font-size:15px}
.realm-banner p{color:var(--dim);font-size:11px;margin-top:4px}
.realm-select{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.realm-select button{padding:5px 12px;border:1px solid var(--border);background:none;color:var(--text);border-radius:8px;font-size:11px;transition:all .2s}
.realm-select button:hover{border-color:var(--purple);color:var(--purple);background:rgba(160,112,224,.08)}
.realm-select button:disabled{opacity:.4;cursor:not-allowed}
.realm-log{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;max-height:300px;overflow-y:auto;font-size:12px;line-height:1.7}
.fg{margin-bottom:12px}
.fg label{display:block;font-size:11px;color:var(--dim);margin-bottom:3px}
.fg input,.fg textarea,.fg select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:8px;font-size:12px}
.fg textarea{min-height:70px;resize:vertical}
.fg input:focus,.fg textarea:focus,.fg select:focus{outline:0;border-color:var(--cyan)}
.fg .row{display:flex;gap:8px}.fg .row>*{flex:1}
.fbtn{padding:7px 20px;border:none;font-weight:bold;border-radius:8px;font-size:12px;transition:all .2s}
.fbtn:hover{opacity:.85}
.fbtn-gold{background:linear-gradient(135deg,var(--gold),#c09030);color:var(--bg)}
.fbtn-cyan{background:linear-gradient(135deg,var(--cyan),#40b0a8);color:var(--bg)}
.fbtn-danger{background:linear-gradient(135deg,var(--danger),#c04040);color:#fff}
.modal-mask{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal-mask.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;width:92%;max-width:480px;max-height:82vh;overflow-y:auto}
.modal h3{color:var(--gold);margin-bottom:14px;font-size:15px}
.modal .mclose{float:right;background:none;border:0;color:var(--dim);font-size:18px}
.empty{text-align:center;color:var(--dim);padding:30px;font-size:12px}
.settings-wrap{max-width:540px;margin:0 auto}
.settings-section{margin-bottom:16px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.settings-section h3{font-size:13px;color:var(--cyan);margin-bottom:10px}
.model-list{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.model-tag{padding:3px 8px;border:1px solid var(--border);border-radius:6px;font-size:10px;color:var(--dim);cursor:pointer;transition:all .2s;background:none}
.model-tag:hover,.model-tag.active{border-color:var(--cyan);color:var(--cyan)}
.fetch-btn{padding:3px 10px;border:1px solid var(--border);background:none;color:var(--cyan);border-radius:6px;font-size:10px;margin-left:6px}
.fetch-btn:hover{background:rgba(92,224,216,.08)}
@media(max-width:600px){.cards,.cult-grid{grid-template-columns:1fr}.mini-bars{display:none}}
</style>
</head>
<body>
<div class="topbar">
  <div class="logo"><h1>ğŸŒ™ ä»™é€”Â·é€†å‘½å½•</h1></div>
  <div class="pinfo">
    <span class="pn" id="pName">æ— åæ•£ä¿®</span>
    <span class="pr" id="pRealm">å‡¡äºº</span>
    <div class="mini-bars">
      <div class="mini-bar" title="æ°”è¡€"><div class="mf sf-hp" id="hpBar" style="width:100%"></div></div>
      <div class="mini-bar" title="çµåŠ›"><div class="mf sf-mp" id="mpBar" style="width:100%"></div></div>
      <div class="mini-bar" title="ä¿®ä¸º"><div class="mf sf-exp" id="expBar" style="width:0%"></div></div>
    </div>
  </div>
</div>
<div class="main-content">
  <!-- å¯¹è¯ -->
  <div class="page active" id="pg-chat">
    <div class="chat-header"><div><select id="chatSelect"><option value="">é€‰æ‹©å¯¹è¯å¯¹è±¡</option></select><span class="ch-info" id="chatInfo"></span></div></div>
    <div class="msgs" id="msgBox"><div class="msg sys">æ¬¢è¿æ¥åˆ°ä»™é€”Â·é€†å‘½å½• âœ¨ å…ˆå»âš™ï¸è®¾ç½®é…APIï¼Œå†åˆ›å»ºNPC~</div></div>
    <div class="chat-actions">
      <button class="abtn" data-act="è°ƒæƒ…">ğŸ’—è°ƒæƒ…</button><button class="abtn" data-act="åŒä¿®">âœ¨åŒä¿®</button>
      <button class="abtn" data-act="å¼ºåˆ¶æ’­ç§">ğŸŒ±æ’­ç§</button><button class="abtn" data-act="æŸ¥çœ‹èº«ä½“çŠ¶å†µ">ğŸ”æŸ¥çœ‹</button>
      <button class="abtn" data-act="æ‹¥å…¥æ€€ä¸­">ğŸ¤—æ‹¥æŠ±</button><button class="abtn" data-act="åˆ‡ç£‹">âš”ï¸åˆ‡ç£‹</button>
      <button class="abtn cyan" data-act="å–‚ä¸¹è¯">ğŸ’Šå–‚ä¸¹</button>
    </div>
    <div class="chat-input"><textarea id="chatInput" placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦ï¼ˆShift+Enteræ¢è¡Œï¼‰" rows="1"></textarea><button class="sbtn" id="sendBtn">å‘é€</button></div>
  </div>
  <!-- ä¼ è®¯ -->
  <div class="page" id="pg-msg">
    <div class="chat-header"><div><select id="msgSelect"><option value="">é€‰æ‹©ä¼ è®¯å¯¹è±¡</option></select><span class="ch-info" id="msgInfo">è¿œç¨‹ä¼ è®¯</span></div></div>
    <div class="msgs" id="msgMsgBox"><div class="msg sys">ğŸ“¨ ä¼ è®¯ç³»ç»Ÿï¼šè¿œç¨‹è”ç»œï¼Œå¯¹æ–¹æœ‰æ¦‚ç‡èµ¶æ¥~</div></div>
    <div class="chat-actions">
      <button class="abtn" data-msg-act="æƒ³ä½ äº†">ğŸ’•æƒ³ä½ </button><button class="abtn" data-msg-act="é€Ÿæ¥">ğŸƒé€Ÿæ¥</button>
      <button class="abtn" data-msg-act="æŠ¥å¹³å®‰">âœ…å¹³å®‰</button><button class="abtn cyan" data-msg-act="é‚€è¯·é—¯ç§˜å¢ƒ">ğŸŒ€é‚€ç§˜å¢ƒ</button>
    </div>
    <div class="chat-input"><textarea id="msgInput" placeholder="ä¼ è®¯å†…å®¹â€¦" rows="1"></textarea><button class="sbtn" id="msgSendBtn">ä¼ è®¯</button></div>
  </div>
  <!-- ä¿®ç‚¼ -->
  <div class="page" id="pg-cult">
    <div class="page-hd"><h2>ğŸ§˜ ä¿®ç‚¼æ´åºœ</h2></div>
    <div class="page-bd"><div class="cult-grid">
      <div class="cult-card"><div class="ci">ğŸ§˜</div><div class="ct">æ‰“åä¿®ç‚¼</div><div class="cdesc">å¸æ”¶çµæ°”ï¼Œæå‡ä¿®ä¸º</div><button class="cbtn" onclick="doCult('meditate')">å¼€å§‹ä¿®ç‚¼</button><div class="cult-result" id="res-meditate"></div></div>
      <div class="cult-card"><div class="ci">âš—ï¸</div><div class="ct">ç‚¼ä¸¹</div><div class="cdesc">ç‚¼åˆ¶ä¸¹è¯ï¼ŒæˆåŠŸç‡çœ‹å¢ƒç•Œ</div><button class="cbtn" onclick="doCult('alchemy')">å¼€ç‚‰ç‚¼ä¸¹</button><div class="cult-result" id="res-alchemy"></div></div>
      <div class="cult-card"><div class="ci">ğŸ’</div><div class="ct">åŒä¿®</div><div class="cdesc">ä¸é“ä¾£åŒä¿®ï¼Œæå‡ä¿®ä¸ºå¢è¿›æ„Ÿæƒ…</div><select id="dualSelect" style="margin-top:6px;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:6px;font-size:10px;width:100%"><option value="">é€‰æ‹©å¯¹è±¡</option></select><button class="cbtn" onclick="doCult('dual')">å¼€å§‹åŒä¿®</button><div class="cult-result" id="res-dual"></div></div>
      <div class="cult-card"><div class="ci">ğŸŒ±</div><div class="ct">æ’­ç§æœ¯</div><div class="cdesc">æ¶ˆè€—çµåŠ›ï¼Œå¼ºåˆ¶ä½¿ç›®æ ‡å—å­•</div><select id="seedSelect" style="margin-top:6px;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:6px;font-size:10px;width:100%"><option value="">é€‰æ‹©ç›®æ ‡</option></select><button class="cbtn" onclick="doCult('seed')">æ–½å±•æ’­ç§æœ¯</button><div class="cult-result" id="res-seed"></div></div>
      <div class="cult-card"><div class="ci">ğŸ’Š</div><div class="ct">ä¸¹è¯èƒŒåŒ…</div><div class="cdesc">ä½¿ç”¨å·²ç‚¼åˆ¶çš„ä¸¹è¯</div><div id="pillList" style="margin-top:6px;font-size:10px;color:var(--dim)">æš‚æ— </div><div class="cult-result" id="res-pill"></div></div>
      <div class="cult-card"><div class="ci">ğŸ“–</div><div class="ct">å‚æ‚ŸåŠŸæ³•</div><div class="cdesc">ç ”è¯»ç§˜ç±ï¼Œæ¦‚ç‡çªç ´</div><button class="cbtn" onclick="doCult('study')">å¼€å§‹å‚æ‚Ÿ</button><div class="cult-result" id="res-study"></div></div>
    </div></div>
  </div>
  <!-- ç§˜å¢ƒ -->
  <div class="page" id="pg-realm">
    <div class="page-hd"><h2>ğŸŒ€ ç§˜å¢ƒæ¢ç´¢</h2></div>
    <div class="page-bd">
      <div class="realm-banner"><h3>ğŸŒ€ é€‰æ‹©ç§˜å¢ƒ</h3><p>æºå¸¦é“ä¾£é—¯è¡ï¼Œå±é™©ä¸æœºç¼˜å¹¶å­˜ï¼</p>
        <div style="margin-top:8px"><label style="font-size:10px;color:var(--dim)">åŒä¼´ï¼š</label><select id="realmCompanion" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:6px;font-size:10px;margin-top:3px"><option value="">ç‹¬è‡ªå‰å¾€</option></select></div>
        <div class="realm-select" id="realmBtns"></div>
      </div>
      <div class="realm-log" id="realmLog" style="display:none"></div>
    </div>
  </div>
  <!-- NPC -->
  <div class="page" id="pg-npc">
    <div class="page-hd"><h2>ğŸ‘¥ è§’è‰²ç®¡ç†</h2><button class="fbtn fbtn-cyan" onclick="openNpcModal()" style="font-size:10px;padding:5px 12px">âœ¨æ–°å»º</button></div>
    <div class="page-bd"><div class="cards" id="npcCards"></div><div class="empty" id="npcEmpty">è¿˜æ²¡æœ‰è§’è‰²~</div></div>
  </div>
  <!-- å…³ç³» -->
  <div class="page" id="pg-rel">
    <div class="page-hd"><h2>ğŸ’• å…³ç³»æ€»è§ˆ</h2></div>
    <div class="page-bd"><div class="cards" id="relCards"></div><div class="empty" id="relEmpty">æš‚æ— </div></div>
  </div>
  <!-- äº‹ä»¶ -->
  <div class="page" id="pg-event">
    <div class="page-hd"><h2>ğŸ“œ ä¸–ç•Œäº‹ä»¶</h2></div>
    <div class="page-bd"><div id="eventLog"></div><div class="empty" id="eventEmpty">å¤©åœ°å¯‚é™â€¦</div></div>
  </div>
  <!-- è®¾ç½® -->
  <div class="page" id="pg-set">
    <div class="page-hd"><h2>âš™ï¸ è®¾ç½®</h2></div>
    <div class="page-bd"><div class="settings-wrap">
      <div class="settings-section"><h3>ğŸ”‘ AIæ¥å£</h3>
        <div class="fg"><label>APIåœ°å€</label><input id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions"></div>
        <div class="fg"><label>API Key</label><input id="apiKey" type="password" placeholder="sk-..."></div>
        <div class="fg"><label>æ¨¡å‹ <button class="fetch-btn" onclick="fetchModels()">ğŸ”„æ‹‰å–åˆ—è¡¨</button></label><input id="apiModel" placeholder="gpt-4o"><div class="model-list" id="modelList"></div></div>
        <div class="fg"><label>æœ€å¤§Token</label><input id="apiMaxTokens" type="number" value="2048"></div>
      </div>
      <div class="settings-section"><h3>ğŸ­ ä¸»æ§äººè®¾</h3>
        <div class="fg"><div class="row"><div><label>åå·</label><input id="pcName" placeholder="è§’è‰²å"></div><div><label>æ€§åˆ«</label><select id="pcGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select></div></div></div>
        <div class="fg"><label>å¢ƒç•Œ</label><select id="pcRealm"><option>å‡¡äºº</option><option>ç»ƒæ°”æœŸ</option><option>ç­‘åŸºæœŸ</option><option>é‡‘ä¸¹æœŸ</option><option>å…ƒå©´æœŸ</option><option>åŒ–ç¥æœŸ</option><option>åˆä½“æœŸ</option><option>å¤§ä¹˜æœŸ</option><option>æ¸¡åŠ«æœŸ</option><option>ä»™äºº</option></select></div>
        <div class="fg"><label>äººè®¾æè¿°</label><textarea id="pcDesc" placeholder="æ€§æ ¼ã€å¤–è²Œã€èƒ½åŠ›â€¦"></textarea></div>
      </div>
      <div class="settings-section"><h3>ğŸŒ ä¸–ç•Œè§‚è¡¥å……</h3><div class="fg"><textarea id="worldSetting" placeholder="é¢å¤–è®¾å®šâ€¦"></textarea></div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="fbtn fbtn-gold" onclick="saveSettings()">ğŸ’¾ä¿å­˜</button>
        <button class="fbtn fbtn-danger" onclick="if(confirm('æ¸…é™¤æ‰€æœ‰ï¼Ÿ')){localStorage.clear();location.reload()}">ğŸ—‘ï¸é‡ç½®</button>
        <span id="saveMsg" style="color:var(--green);font-size:11px"></span>
      </div>
    </div></div>
  </div>
</div>
<div class="bottomnav">
  <button class="nb active" data-page="chat"><span class="ni">ğŸ’¬</span>å¯¹è¯</button>
  <button class="nb" data-page="msg"><span class="ni">ğŸ“¨</span>ä¼ è®¯</button>
  <button class="nb" data-page="cult"><span class="ni">ğŸ§˜</span>ä¿®ç‚¼</button>
  <button class="nb" data-page="realm"><span class="ni">ğŸŒ€</span>ç§˜å¢ƒ</button>
  <button class="nb" data-page="npc"><span class="ni">ğŸ‘¥</span>è§’è‰²</button>
  <button class="nb" data-page="rel"><span class="ni">ğŸ’•</span>å…³ç³»</button>
  <button class="nb" data-page="event"><span class="ni">ğŸ“œ</span>äº‹ä»¶</button>
  <button class="nb" data-page="set"><span class="ni">âš™ï¸</span>è®¾ç½®</button>
</div>
<!-- NPCæ¨¡æ€æ¡† -->
<div class="modal-mask" id="npcModal"><div class="modal">
  <button class="mclose" onclick="closeNpcModal()">âœ•</button>
  <h3 id="npcModalTitle">âœ¨ æ–°å»ºè§’è‰²</h3><input type="hidden" id="editNpcId">
  <div class="fg"><div class="row"><div><label>åå­—</label><input id="npcName"></div><div><label>æ€§åˆ«</label><select id="npcGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select></div></div></div>
  <div class="fg"><div class="row"><div><label>å¢ƒç•Œ</label><select id="npcRealm"><option>ç»ƒæ°”æœŸ</option><option>ç­‘åŸºæœŸ</option><option>é‡‘ä¸¹æœŸ</option><option>å…ƒå©´æœŸ</option><option>åŒ–ç¥æœŸ</option><option>åˆä½“æœŸ</option><option>å¤§ä¹˜æœŸ</option><option>æ¸¡åŠ«æœŸ</option><option>ä»™äºº</option></select></div><div><label>èº«ä»½</label><input id="npcRole" placeholder="é­”é“åœ£å­â€¦"></div></div></div>
  <div class="fg"><label>æ€§æ ¼ä¸å¤–è²Œ</label><textarea id="npcPersonality" placeholder="è¯¦ç»†æè¿°â€¦"></textarea></div>
  <div class="fg"><div class="row"><div><label>åˆå§‹å…³ç³»</label><select id="npcRelType"><option value="é™Œç”Ÿäºº">é™Œç”Ÿäºº</option><option value="åŒé—¨">åŒé—¨</option><option value="å®¿æ•Œ">å®¿æ•Œ</option><option value="æš§æ˜§">æš§æ˜§</option><option value="é“ä¾£">é“ä¾£</option><option value="ä»†ä»">ä»†ä»</option></select></div><div><label>æ¨¡å¼</label><select id="npcRelMode"><option value="å¯æ”»ç•¥">æµ·ç‹</option><option value="ä¸“æƒ…">ä¸“æƒ…1v1</option></select></div></div></div>
  <div class="fg"><label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input id="npcTags" placeholder="å‚²å¨‡,æ˜“å­•ä½“è´¨,å¿ çŠ¬"></div>
  <div class="fg"><label>é¢å¤–AIæŒ‡ä»¤</label><textarea id="npcSysPrompt" placeholder="ç»™AIçš„é¢å¤–æŒ‡ä»¤â€¦"></textarea></div>
  <button class="fbtn fbtn-gold" onclick="saveNpc()">ğŸ’¾ä¿å­˜</button>
</div></div>
<!-- NPCå†…å¿ƒæ¨¡æ€æ¡† -->
<div class="modal-mask" id="statusModal"><div class="modal">
  <button class="mclose" onclick="document.getElementById('statusModal').classList.remove('show')">âœ•</button>
  <h3>ğŸ”® <span id="statusNpcName"></span> çš„å†…å¿ƒ</h3>
  <div id="statusContent" style="font-size:12px;line-height:1.8"></div>
</div></div>
<!-- æŸ¥å²—æ¨¡æ€æ¡† -->
<div class="modal-mask" id="checkModal"><div class="modal">
  <button class="mclose" onclick="document.getElementById('checkModal').classList.remove('show')">âœ•</button>
  <h3 id="checkTitle">ğŸ” æŸ¥å²—</h3>
  <div id="checkContent" style="font-size:12px;line-height:1.8"></div>
</div></div>

<script>
// ========== æ•°æ® ==========
const D={get(k,d){try{return JSON.parse(localStorage.getItem('xt_'+k))||d}catch{return d}},set(k,v){localStorage.setItem('xt_'+k,JSON.stringify(v))}};
const REALMS=['å‡¡äºº','ç»ƒæ°”æœŸ','ç­‘åŸºæœŸ','é‡‘ä¸¹æœŸ','å…ƒå©´æœŸ','åŒ–ç¥æœŸ','åˆä½“æœŸ','å¤§ä¹˜æœŸ','æ¸¡åŠ«æœŸ','ä»™äºº'];
const PILLS_DB=[{name:'å›æ°”ä¸¹',desc:'æ¢å¤30çµåŠ›',effect:'mp',val:30,rate:.8},{name:'åŸ¹å…ƒä¸¹',desc:'æ¢å¤50æ°”è¡€',effect:'hp',val:50,rate:.75},{name:'ç­‘åŸºä¸¹',desc:'å¤§é‡ä¿®ä¸º',effect:'exp',val:60,rate:.5},{name:'åŠ©å­•ä¸¹',desc:'æé«˜æ’­ç§ç‡',effect:'fertility',val:1,rate:.4},{name:'åˆæ¬¢æ•£',desc:'å¥½æ„Ÿ+20',effect:'love',val:20,rate:.35},{name:'ç ´å¢ƒä¸¹',desc:'æ¦‚ç‡çªç ´',effect:'breakthrough',val:1,rate:.2}];
const REALMS_DB=[{name:'è½éœç§˜å¢ƒ',level:0,desc:'å…¥é—¨ï¼Œçµè‰éåœ°',rewards:['çµè‰','ä½é˜¶çµçŸ³','æ®‹é¡µåŠŸæ³•']},{name:'å¹½å†¥æ´çªŸ',level:2,desc:'é˜´æ°”æ£®æ£®',rewards:['å†¥é“','ä¸­é˜¶çµçŸ³','é˜´å±æ€§åŠŸæ³•']},{name:'å¤©ç«ç†”ç‚‰',level:4,desc:'æå±é™©',rewards:['å¤©ç«ç²¾å','é«˜é˜¶çµçŸ³','ç‚¼å™¨ç§˜æ³•']},{name:'åŒä¿®ç§˜å¢ƒ',level:3,desc:'é¡»æºä¼´ä¾£',rewards:['åˆæ¬¢èŠ±','åŒä¿®åŠŸæ³•','äº²å¯†åº¦å¤§å¢']},{name:'æ··æ²Œè™šç©º',level:6,desc:'ä»™äººä¹‹ä¸‹è«å…¥',rewards:['æ··æ²Œçµæ¶²','ä»™é˜¶åŠŸæ³•','é€†å¤©é€ åŒ–']}];

let state=D.get('state',{player:{name:'æ— åæ•£ä¿®',gender:'ç”·',realm:'å‡¡äºº',desc:'',hp:100,maxHp:100,mp:50,maxMp:50,exp:0,maxExp:100},api:{url:'',key:'',model:'gpt-4o',maxTokens:2048},worldSetting:'',npcs:[],relations:{},chatHistories:{},msgHistories:{},events:[],pregnancies:{},pills:[],lastTalkTo:null});
function save(){D.set('state',state)}

// ========== æç¤ºè¯ ==========
function buildSys(npc,mode){
  const p=state.player,rel=state.relations[npc.id]||{type:'é™Œç”Ÿäºº',love:0},preg=state.pregnancies[npc.id];
  let ps='';if(preg?.active)ps=`\nã€çŠ¶æ€ã€‘${npc.name}å·²æ€€å­•ï¼Œ${preg.stage}ï¼Œç¬¬${preg.days}å¤©ã€‚`;
  let ms='';
  if(mode==='remote')ms=`\nã€åœºæ™¯ã€‘è¿œç¨‹ä¼ è®¯ã€‚å¯å†³å®šæ˜¯å¦èµ¶æ¥ï¼Œå†³å®šèµ¶æ¥æœ«å°¾åŠ ã€èµ¶æ¥ã€‘ã€‚`;
  else if(mode==='realm')ms=`\nã€åœºæ™¯ã€‘ä¸€èµ·é—¯ç§˜å¢ƒï¼Œæå†™ç¯å¢ƒé­é‡æˆ˜æ–—äº’åŠ¨ã€‚`;
  else if(mode==='status')ms=`\nã€ä»»åŠ¡ã€‘ç¬¬ä¸‰äººç§°æè¿°${npc.name}æ­¤åˆ»å†…å¿ƒæƒ³æ³•ã€å¯¹${p.name}çš„çœŸå®æ„Ÿå—ã€èº«ä½“çŠ¶æ€ã€åœ¨åšä»€ä¹ˆã€‚åŒ…å«ï¼š1.å¥½æ„Ÿåˆ†æ 2.å†…å¿ƒç‹¬ç™½ 3.èº«ä½“çŠ¶å†µ 4.æ­£åœ¨åšä»€ä¹ˆ 5.æ€€å­•åˆ™æè¿°å­•æœŸæ„Ÿå—ã€‚ä¸è¦å¯¹è¯æ ¼å¼ï¼Œç›´æ¥æå†™ã€‚300å­—ã€‚`;
  else if(mode==='npc-check')ms=`\nã€åœºæ™¯ã€‘${npc.name}å› ä¸ºåƒé†‹/æ‹…å¿ƒ/æƒ³å¿µï¼Œçªç„¶å‡ºç°åœ¨${p.name}é¢å‰æŸ¥å²—ï¼æ ¹æ®å¥½æ„Ÿå’Œæ€§æ ¼å†³å®šæ˜¯è´¨é—®/æ’’å¨‡/ç”Ÿæ°”/å§”å±ˆã€‚è¦æœ‰æˆå‰§æ€§å’Œç»†èŠ‚ã€‚`;
  else if(mode==='user-check')ms=`\nã€åœºæ™¯ã€‘${p.name}çªç„¶æ¥æŸ¥${npc.name}çš„å²—ã€‚${npc.name}æ ¹æ®æ€§æ ¼ååº”ï¼ˆå¿ƒè™š/å¦ç„¶/æ’’å¨‡/ç”Ÿæ°”è¢«è´¨ç–‘ç­‰ï¼‰ã€‚`;
  return `ä½ æ˜¯ä¿®ä»™ä¸–ç•Œè§’è‰²æ‰®æ¼”AIï¼Œä¸¥æ ¼æ‰®æ¼”è§’è‰²ã€‚
ã€ä¸–ç•Œè§‚ã€‘ä¿®ä»™ä¸–ç•Œã€‚ç”·æ€§å¯æ€€å­•ï¼ˆç”·ç”Ÿå­ï¼‰ï¼Œè‡ªç„¶æ³•åˆ™ã€‚åŒä¿®/æœ¯æ³•å¯ä½¿ç”·æ€§å—å­•ã€‚å¯å¼ºåˆ¶æ’­ç§ã€‚${state.worldSetting?'è¡¥å……ï¼š'+state.worldSetting:''}
ã€è§’è‰²ã€‘${npc.name}ï½œ${npc.gender}ï½œ${npc.realm}ï½œ${npc.role||'æ•£ä¿®'}
æ€§æ ¼å¤–è²Œï¼š${npc.personality||'å¾…è®¾å®š'}
å…³ç³»ï¼š${rel.type}ï¼ˆå¥½æ„Ÿ${rel.love}/100ï¼‰ï½œ${npc.relMode||'å¯æ”»ç•¥'}
${npc.tags?.length?'æ ‡ç­¾ï¼š'+npc.tags.join('ã€'):''}${npc.sysPrompt?'\né¢å¤–ï¼š'+npc.sysPrompt:''}${ps}${ms}
ã€å¯¹æ–¹ã€‘${p.name}ï½œ${p.gender}ï½œ${p.realm}ï½œ${p.desc||'ç¥ç§˜ä¿®å£«'}
ã€è§„åˆ™ã€‘1.ä¿æŒæ€§æ ¼ 2.å¥½æ„Ÿä½å†·æ·¡é«˜äº²å¯† 3.*åŒ…è£¹åŠ¨ä½œ* 4.200-400å­— 5.æœ«å°¾ã€å¥½æ„Ÿ+Nã€‘æˆ–ã€å¥½æ„Ÿ-Nã€‘`;
}

// ========== æ‹‰å–æ¨¡å‹ ==========
async function fetchModels(){
  const url=document.getElementById('apiUrl').value.trim(),key=document.getElementById('apiKey').value.trim();
  if(!url||!key)return alert('å…ˆå¡«APIåœ°å€å’ŒKey');
  const base=url.replace(/\/chat\/completions\/?$/,'').replace(/\/+$/,''),list=document.getElementById('modelList');
  list.innerHTML='<span style="color:var(--dim);font-size:10px">åŠ è½½ä¸­â€¦</span>';
  try{
    const r=await fetch(base+'/models',{headers:{'Authorization':'Bearer '+key}});
    if(!r.ok)throw new Error(r.status);const d=await r.json();
    const models=(d.data||d||[]).map(m=>m.id||m.name||m).filter(Boolean).sort();
    if(!models.length){list.innerHTML='<span style="color:var(--dim)">æœªæ‰¾åˆ°</span>';return}
    list.innerHTML=models.map(m=>`<button class="model-tag" onclick="document.getElementById('apiModel').value='${m}';document.querySelectorAll('.model-tag').forEach(t=>t.classList.remove('active'));this.classList.add('active')">${m}</button>`).join('');
  }catch(e){list.innerHTML=`<span style="color:var(--danger);font-size:10px">å¤±è´¥ï¼š${e.message}</span>`}
}

// ========== UIæ›´æ–° ==========
function updatePlayerUI(){const p=state.player;document.getElementById('pName').textContent=p.name;document.getElementById('pRealm').textContent=p.realm;document.getElementById('hpBar').style.width=(p.hp/p.maxHp*100)+'%';document.getElementById('mpBar').style.width=(p.mp/p.maxMp*100)+'%';document.getElementById('expBar').style.width=(p.exp/p.maxExp*100)+'%'}

function updateNpcCards(){
  const c=document.getElementById('npcCards'),e=document.getElementById('npcEmpty');
  if(!state.npcs.length){c.innerHTML='';e.style.display='block';return}e.style.display='none';
  c.innerHTML=state.npcs.map(n=>{
    const rel=state.relations[n.id]||{type:'é™Œç”Ÿäºº',love:0},preg=state.pregnancies[n.id];
    let tags=(n.tags||[]).map(t=>`<span class="tag tag-p">${t}</span>`).join('');
    tags+=`<span class="tag tag-c">${rel.type}</span>`;
    if(preg?.active)tags+=`<span class="tag tag-g">å­•è‚²${preg.days}å¤©</span>`;
    return `<div class="card"><div class="cn">${n.name}</div><div class="cr">${n.gender}Â·${n.realm}Â·${n.role||'æ•£ä¿®'}</div><div class="cd">${n.personality||''}</div><div class="ctags">${tags}</div><div style="margin-top:6px"><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim)"><span>å¥½æ„Ÿ</span><span>${rel.love}/100</span></div><div class="rel-bar"><div class="rel-fill" style="width:${rel.love}%"></div></div></div><div class="cbtns"><button onclick="startChat('${n.id}')">ğŸ’¬</button><button onclick="viewStatus('${n.id}')">ğŸ”®å†…å¿ƒ</button><button onclick="userCheck('${n.id}')">ğŸ”æŸ¥å²—</button><button onclick="openNpcModal('${n.id}')">âœï¸</button><button class="bdel" onclick="deleteNpc('${n.id}')">ğŸ—‘ï¸</button></div></div>`}).join('');
}

function updateSelects(){
  const opts=state.npcs.map(n=>`<option value="${n.id}">${n.name}ï¼ˆ${n.realm}ï¼‰</option>`).join('');
  ['chatSelect','msgSelect','dualSelect','seedSelect','realmCompanion'].forEach(id=>{const s=document.getElementById(id);if(!s)return;const v=s.value;s.innerHTML=(id==='realmCompanion'?'<option value="">ç‹¬è‡ªå‰å¾€</option>':'<option value="">é€‰æ‹©å¯¹è±¡</option>')+opts;if(v&&state.npcs.find(n=>n.id===v))s.value=v});
}

function updateRelCards(){
  const c=document.getElementById('relCards'),e=document.getElementById('relEmpty'),entries=state.npcs.filter(n=>state.relations[n.id]);
  if(!entries.length){c.innerHTML='';e.style.display='block';return}e.style.display='none';
  c.innerHTML=entries.map(n=>{const r=state.relations[n.id],preg=state.pregnancies[n.id];let st=r.type;if(preg?.active)st+=`Â·æœ‰å–œ${preg.days}å¤©`;
    return `<div class="card"><div class="cn">${n.name}</div><div class="cr">${st}</div><div style="margin-top:8px"><div style="display:flex;justify-content:space-between;font-size:10px;color:var(--dim)"><span>â¤ï¸</span><span>${r.love}/100</span></div><div class="rel-bar"><div class="rel-fill" style="width:${r.love}%"></div></div></div>${preg?.active?`<div style="margin-top:6px;font-size:10px;color:var(--green)">ğŸŒ±${preg.stage} ç¬¬${preg.days}å¤©</div>`:''}<div class="cbtns" style="margin-top:8px"><button onclick="startChat('${n.id}')">ğŸ’¬</button><button onclick="viewStatus('${n.id}')">ğŸ”®</button><button onclick="userCheck('${n.id}')">ğŸ”æŸ¥å²—</button>${!preg?.active?`<button onclick="forcePreg('${n.id}')">ğŸŒ±æ’­ç§</button>`:`<button onclick="advPreg('${n.id}')">â©æ¨è¿›</button>`}</div></div>`}).join('');
}

function updateEvents(){const el=document.getElementById('eventLog'),e=document.getElementById('eventEmpty');if(!state.events.length){el.innerHTML='';e.style.display='block';return}e.style.display='none';el.innerHTML=state.events.slice().reverse().map(ev=>`<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:11px"><span style="color:var(--dim)">${ev.time}</span> <span style="color:var(--gold)">[${ev.type}]</span> ${ev.text}</div>`).join('')}
function updatePills(){const el=document.getElementById('pillList');if(!state.pills.length){el.innerHTML='æš‚æ— ';return}const c={};state.pills.forEach(p=>{c[p]=(c[p]||0)+1});el.innerHTML=Object.entries(c).map(([n,cnt])=>`<button class="abtn cyan" style="margin:2px" onclick="usePill('${n}')">${n}Ã—${cnt}</button>`).join('')}
function updateRealmBtns(){const el=document.getElementById('realmBtns'),ri=REALMS.indexOf(state.player.realm);el.innerHTML=REALMS_DB.map(r=>{const ok=ri>=r.level;return `<button ${ok?`onclick="enterRealm('${r.name}')"`:'disabled'} title="${r.desc}">${r.name}${ok?'':'ğŸ”’'}</button>`}).join('')}
function addEvent(t,x){state.events.push({type:t,text:x,time:new Date().toLocaleString('zh-CN')});if(state.events.length>200)state.events.shift();save();updateEvents()}
function refreshAll(){updatePlayerUI();updateNpcCards();updateSelects();updateRelCards();updateEvents();updatePills();updateRealmBtns()}

// ========== NPCç®¡ç† ==========
function openNpcModal(id){
  document.getElementById('npcModal').classList.add('show');
  if(id){const n=state.npcs.find(x=>x.id===id);if(!n)return;document.getElementById('npcModalTitle').textContent='âœï¸ç¼–è¾‘';document.getElementById('editNpcId').value=id;document.getElementById('npcName').value=n.name;document.getElementById('npcGender').value=n.gender;document.getElementById('npcRealm').value=n.realm;document.getElementById('npcRole').value=n.role||'';document.getElementById('npcPersonality').value=n.personality||'';document.getElementById('npcRelType').value=state.relations[id]?.type||'é™Œç”Ÿäºº';document.getElementById('npcRelMode').value=n.relMode||'å¯æ”»ç•¥';document.getElementById('npcTags').value=(n.tags||[]).join(',');document.getElementById('npcSysPrompt').value=n.sysPrompt||''}
  else{document.getElementById('npcModalTitle').textContent='âœ¨æ–°å»º';document.getElementById('editNpcId').value='';['npcName','npcRole','npcPersonality','npcTags','npcSysPrompt'].forEach(x=>document.getElementById(x).value='');document.getElementById('npcGender').value='ç”·';document.getElementById('npcRealm').value='é‡‘ä¸¹æœŸ';document.getElementById('npcRelType').value='é™Œç”Ÿäºº';document.getElementById('npcRelMode').value='å¯æ”»ç•¥'}
}
function closeNpcModal(){document.getElementById('npcModal').classList.remove('show')}
function saveNpc(){
  const name=document.getElementById('npcName').value.trim();if(!name)return alert('è¾“å…¥åå­—');
  const eid=document.getElementById('editNpcId').value,d={id:eid||'npc_'+Date.now(),name,gender:document.getElementById('npcGender').value,realm:document.getElementById('npcRealm').value,role:document.getElementById('npcRole').value.trim(),personality:document.getElementById('npcPersonality').value.trim(),relMode:document.getElementById('npcRelMode').value,tags:document.getElementById('npcTags').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean),sysPrompt:document.getElementById('npcSysPrompt').value.trim()},rt=document.getElementById('npcRelType').value;
  if(eid){const i=state.npcs.findIndex(n=>n.id===eid);if(i>=0)state.npcs[i]={...state.npcs[i],...d}}else{state.npcs.push(d);state.relations[d.id]={type:rt,love:rt==='é“ä¾£'?80:rt==='æš§æ˜§'?50:10};addEvent('è§’è‰²',`${name}å‡ºç°äº†`)}
  if(!state.relations[d.id])state.relations[d.id]={type:rt,love:10};else state.relations[d.id].type=rt;
  save();closeNpcModal();refreshAll();
}
function deleteNpc(id){
  const n=state.npcs.find(x=>x.id===id);if(!n||!confirm(`åˆ é™¤ã€Œ${n.name}ã€ï¼Ÿ`))return;
  state.npcs=state.npcs.filter(x=>x.id!==id);delete state.relations[id];delete state.chatHistories[id];delete state.msgHistories[id];delete state.pregnancies[id];
  save();refreshAll();addEvent('è§’è‰²',`${n.name}ç¦»å¼€äº†`);
}

// ========== AIæ ¸å¿ƒ ==========
let currentChatId=null,currentMsgId=null;
function startChat(id){currentChatId=id;document.getElementById('chatSelect').value=id;switchPage('chat');loadChat()}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*(.*?)\*/g,'<em style="color:var(--pink)">$1</em>').replace(/ã€(.*?)ã€‘/g,'<span style="color:var(--gold);font-size:10px">ã€$1ã€‘</span>')}

function loadChat(){
  const box=document.getElementById('msgBox'),npc=state.npcs.find(n=>n.id===currentChatId),info=document.getElementById('chatInfo');
  if(!npc){info.textContent='';box.innerHTML='<div class="msg sys">é€‰æ‹©NPCå¼€å§‹å¯¹è¯</div>';return}
  const rel=state.relations[npc.id]||{};info.textContent=`${npc.realm}Â·${rel.type||'?'}Â·â¤ï¸${rel.love||0}`;
  const h=state.chatHistories[currentChatId]||[];
  box.innerHTML=h.length?h.filter(m=>m.role!=='system').map(m=>`<div class="msg ${m.role==='user'?'user':'ai'}"><div class="ms">${m.role==='user'?state.player.name:npc.name}</div>${esc(m.content)}</div>`).join(''):`<div class="msg sys">ä¸ã€Œ${npc.name}ã€çš„æ•…äº‹å¼€å§‹â€¦</div>`;
  box.scrollTop=box.scrollHeight;
}

function loadMsgChat(){
  const box=document.getElementById('msgMsgBox'),npc=state.npcs.find(n=>n.id===currentMsgId),info=document.getElementById('msgInfo');
  if(!npc){info.textContent='è¿œç¨‹ä¼ è®¯';box.innerHTML='<div class="msg sys">ğŸ“¨é€‰æ‹©ä¼ è®¯å¯¹è±¡</div>';return}
  info.textContent=`ä¼ è®¯â†’${npc.name}`;
  const h=state.msgHistories[currentMsgId]||[];
  box.innerHTML=h.length?h.filter(m=>m.role!=='system').map(m=>`<div class="msg ${m.role==='user'?'user':'ai msg-remote'}"><div class="ms">${m.role==='user'?state.player.name:npc.name}</div>${esc(m.content)}</div>`).join(''):`<div class="msg sys">ğŸ“¨ä¸ã€Œ${npc.name}ã€ä¼ è®¯â€¦</div>`;
  box.scrollTop=box.scrollHeight;
}

function parseReply(npcId,reply){
  const lm=reply.match(/ã€å¥½æ„Ÿ([+-]\d+)ã€‘/);
  if(lm){const d=parseInt(lm[1]),rel=state.relations[npcId];if(rel){rel.love=Math.max(0,Math.min(100,rel.love+d));if(rel.love>=90&&rel.type!=='é“ä¾£'){rel.type='é“ä¾£';addEvent('å…³ç³»',`${state.npcs.find(n=>n.id===npcId)?.name}ä¸ä½ ç»“ä¸ºé“ä¾£ï¼`)}else if(rel.love>=60&&['é™Œç”Ÿäºº','åŒé—¨'].includes(rel.type))rel.type='æš§æ˜§'}}
  if((reply.includes('å—å­•')||reply.includes('æ€€å­•')||reply.includes('æ’­ç§æˆåŠŸ'))&&!state.pregnancies[npcId]?.active){state.pregnancies[npcId]={active:true,days:1,stage:'åˆæœŸ'};addEvent('å¤§äº‹',`${state.npcs.find(n=>n.id===npcId)?.name}æ€€å­•äº†ï¼`)}
  if(reply.includes('ã€èµ¶æ¥ã€‘'))addEvent('äº‹ä»¶',`${state.npcs.find(n=>n.id===npcId)?.name}æ­£èµ¶æ¥ä½ èº«è¾¹ï¼`);
}

async function callAI(npc,history,mode,box,onDone){
  if(!state.api.url||!state.api.key)return alert('è¯·å…ˆé…ç½®API');
  const msgs=[{role:'system',content:buildSys(npc,mode)},...history.slice(-20)];
  const ld=document.createElement('div');ld.className='msg ai'+(mode==='remote'?' msg-remote':'');
  ld.innerHTML=`<div class="ms">${npc.name}</div><span style="color:var(--dim)">å›åº”ä¸­â€¦</span>`;
  box.appendChild(ld);box.scrollTop=box.scrollHeight;
  try{
    const r=await fetch(state.api.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},body:JSON.stringify({model:state.api.model,messages:msgs,max_tokens:parseInt(state.api.maxTokens)||2048,temperature:.85})});
    if(!r.ok)throw new Error(r.status+' '+r.statusText);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'ï¼ˆæ— å›åº”ï¼‰';
    ld.innerHTML=`<div class="ms">${npc.name}</div>${esc(reply)}`;
    parseReply(npc.id,reply);if(onDone)onDone(reply);save();
  }catch(e){ld.innerHTML=`<div class="ms">ç³»ç»Ÿ</div><span style="color:var(--danger)">å¤±è´¥ï¼š${e.message}</span>`}
  box.scrollTop=box.scrollHeight;refreshAll();
}

async function callAIModal(npc,mode,el){
  if(!state.api.url||!state.api.key)return alert('è¯·å…ˆé…ç½®API');
  el.innerHTML='<span style="color:var(--dim)">AIæ€è€ƒä¸­â€¦</span>';
  const prompt=mode==='status'?'æè¿°ä½ æ­¤åˆ»çš„çŠ¶æ€å’Œå†…å¿ƒæƒ³æ³•ã€‚':mode==='npc-check'?`*${npc.name}çªç„¶å‡ºç°åœ¨${state.player.name}é¢å‰æŸ¥å²—*`:`*${state.player.name}çªç„¶å‡ºç°æŸ¥çœ‹${npc.name}åœ¨åšä»€ä¹ˆ*`;
  const msgs=[{role:'system',content:buildSys(npc,mode)},{role:'user',content:prompt}];
  try{
    const r=await fetch(state.api.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},body:JSON.stringify({model:state.api.model,messages:msgs,max_tokens:parseInt(state.api.maxTokens)||2048,temperature:.85})});
    if(!r.ok)throw new Error(r.status);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'ï¼ˆæ— å›åº”ï¼‰';
    el.innerHTML=esc(reply);parseReply(npc.id,reply);save();refreshAll();
  }catch(e){el.innerHTML=`<span style="color:var(--danger)">å¤±è´¥ï¼š${e.message}</span>`}
}

// ========== å‘é€æ¶ˆæ¯ ==========
async function sendChat(text){
  if(!currentChatId)return alert('é€‰æ‹©NPC');const npc=state.npcs.find(n=>n.id===currentChatId);if(!npc)return;
  const box=document.getElementById('msgBox');
  if(!state.chatHistories[currentChatId])state.chatHistories[currentChatId]=[];
  state.chatHistories[currentChatId].push({role:'user',content:text});
  box.innerHTML+=`<div class="msg user"><div class="ms">${state.player.name}</div>${esc(text)}</div>`;box.scrollTop=box.scrollHeight;
  state.lastTalkTo=currentChatId;save();
  document.getElementById('sendBtn').disabled=true;
  await callAI(npc,state.chatHistories[currentChatId],'face',box,reply=>{state.chatHistories[currentChatId].push({role:'assistant',content:reply})});
  document.getElementById('sendBtn').disabled=false;
  maybeJealousy();
}

async function sendRemote(text){
  if(!currentMsgId)return alert('é€‰æ‹©ä¼ è®¯å¯¹è±¡');const npc=state.npcs.find(n=>n.id===currentMsgId);if(!npc)return;
  const box=document.getElementById('msgMsgBox');
  if(!state.msgHistories[currentMsgId])state.msgHistories[currentMsgId]=[];
  state.msgHistories[currentMsgId].push({role:'user',content:text});
  box.innerHTML+=`<div class="msg user"><div class="ms">${state.player.name}</div>${esc(text)}</div>`;box.scrollTop=box.scrollHeight;
  document.getElementById('msgSendBtn').disabled=true;
  await callAI(npc,state.msgHistories[currentMsgId],'remote',box,reply=>{state.msgHistories[currentMsgId].push({role:'assistant',content:reply})});
  document.getElementById('msgSendBtn').disabled=false;
}

// ========== æŸ¥çœ‹NPCå†…å¿ƒ ==========
async function viewStatus(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  document.getElementById('statusNpcName').textContent=npc.name;
  const el=document.getElementById('statusContent');
  const rel=state.relations[id]||{type:'?',love:0},preg=state.pregnancies[id];
  let base=`<div style="margin-bottom:10px;padding:8px;background:rgba(92,224,216,.05);border-radius:8px;font-size:11px">
    â¤ï¸ å¥½æ„Ÿï¼š<b style="color:var(--pink)">${rel.love}/100</b>ï¼ˆ${rel.type}ï¼‰`;
  if(preg?.active)base+=`<br> çµèƒå·²ç»“ æ€€å­•ï¼š${preg.stage} ç¬¬${preg.days}å¤©`;
  base+=`</div><div id="statusAIContent">åŠ è½½ä¸­â€¦</div>`;
  el.innerHTML=base;
  document.getElementById('statusModal').classList.add('show');
  await callAIModal(npc,'status',document.getElementById('statusAIContent'));
}

// ========== æŸ¥å²—ç³»ç»Ÿ ==========
async function userCheck(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  document.getElementById('checkTitle').textContent=`ğŸ” ä½ å»æŸ¥${npc.name}çš„å²—`;
  const el=document.getElementById('checkContent');el.innerHTML='åŠ è½½ä¸­â€¦';
  document.getElementById('checkModal').classList.add('show');
  addEvent('æŸ¥å²—',`ä½ å»æŸ¥äº†${npc.name}çš„å²—`);
  await callAIModal(npc,'user-check',el);
}

function maybeJealousy(){
  // å’ŒæŸNPCèŠå¤©æ—¶ï¼Œå…¶ä»–å¥½æ„Ÿ>=50çš„é“ä¾£/æš§æ˜§å¯¹è±¡æœ‰æ¦‚ç‡åƒé†‹æŸ¥å²—
  const jealous=state.npcs.filter(n=>n.id!==currentChatId&&state.relations[n.id]&&state.relations[n.id].love>=50&&['æš§æ˜§','é“ä¾£'].includes(state.relations[n.id].type));
  if(!jealous.length)return;
  jealous.forEach(n=>{
    const chance=state.relations[n.id].love>=80?0.25:0.1;
    if(Math.random()<chance){
      setTimeout(()=>{npcCheckUser(n.id)},2000+Math.random()*3000);
    }
  });
}

async function npcCheckUser(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  const talkingTo=state.npcs.find(n=>n.id===currentChatId);
  addEvent('æŸ¥å²—',`${npc.name}åƒé†‹äº†ï¼Œæ¥æŸ¥ä½ çš„å²—ï¼${talkingTo?'å‘ç°ä½ åœ¨å’Œ'+talkingTo.name+'èŠå¤©':''}`);
  // åœ¨å½“å‰èŠå¤©ä¸­æ’å…¥æŸ¥å²—æ¶ˆæ¯
  const box=document.getElementById('msgBox');
  const sysMsg=document.createElement('div');sysMsg.className='msg sys';
  sysMsg.textContent=`âš ï¸ ${npc.name}çªç„¶å‡ºç°äº†ï¼çœ‹èµ·æ¥åœ¨åƒé†‹â€¦`;
  box.appendChild(sysMsg);box.scrollTop=box.scrollHeight;
  // å¼¹å‡ºæŸ¥å²—æ¨¡æ€æ¡†
  document.getElementById('checkTitle').textContent=`ğŸ˜¤ ${npc.name}æ¥æŸ¥ä½ çš„å²—äº†ï¼`;
  const el=document.getElementById('checkContent');el.innerHTML='åŠ è½½ä¸­â€¦';
  document.getElementById('checkModal').classList.add('show');
  await callAIModal(npc,'npc-check',el);
}

// ========== æ€€å­•ç³»ç»Ÿ ==========
function forcePreg(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  if(state.pregnancies[id]?.active)return alert(`${npc.name}å·²ç»æ€€å­•äº†`);
  if(!confirm(`å¯¹ã€Œ${npc.name}ã€æ–½å±•æ’­ç§æœ¯ï¼Ÿ`))return;
  state.pregnancies[id]={active:true,days:1,stage:'åˆæœŸ'};
  addEvent('å¤§äº‹',`ä½ å¯¹${npc.name}æ–½å±•äº†æ’­ç§æœ¯ï¼`);save();refreshAll();
  if(currentChatId===id){
    sendChat(`*ä½ çµåŠ›æš´æ¶Œï¼Œå‡èšæ’­ç§æœ¯æ³•ï¼Œé‡‘è‰²çµçº¹åœ¨æŒå¿ƒæµ®ç°ï¼Œå¼ºè¡ŒçŒå…¥${npc.name}ä½“å†…* ä¹–ï¼Œç»™æˆ‘æ€€ä¸Šã€‚`);
  }
}

function advPreg(id){
  const preg=state.pregnancies[id];if(!preg?.active)return;
  preg.days+=30;
  if(preg.days<=90)preg.stage='åˆæœŸï¼ˆ1-3æœˆï¼‰';
  else if(preg.days<=180)preg.stage='ä¸­æœŸï¼ˆ4-6æœˆï¼‰';
  else if(preg.days<=270)preg.stage='æ™šæœŸï¼ˆ7-9æœˆï¼‰';
  else{preg.stage='å³å°†ä¸´ç›†';if(preg.days>300){preg.active=false;preg.stage='å·²è¯ä¸‹çµå©´';const npc=state.npcs.find(n=>n.id===id);addEvent('å¤§äº‹',`${npc?.name}è¯ä¸‹äº†çµå©´ï¼`)}}
  save();refreshAll();const npc=state.npcs.find(n=>n.id===id);addEvent('å­•æœŸ',`${npc?.name}ï¼š${preg.stage}ï¼ˆç¬¬${preg.days}å¤©ï¼‰`);
}

// ========== ä¿®ç‚¼ç³»ç»Ÿ ==========
function doCult(type){
  const p=state.player,ri=REALMS.indexOf(p.realm),el=document.getElementById('res-'+type.replace('meditate','meditate'));
  let resEl;
  if(type==='meditate')resEl=document.getElementById('res-meditate');
  else if(type==='alchemy')resEl=document.getElementById('res-alchemy');
  else if(type==='dual')resEl=document.getElementById('res-dual');
  else if(type==='seed')resEl=document.getElementById('res-seed');
  else if(type==='study')resEl=document.getElementById('res-study');
  if(!resEl)return;resEl.style.display='block';

  if(type==='meditate'){
    if(p.mp<10){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€10ï¼‰';return}
    p.mp-=10;const gain=10+ri*5+Math.floor(Math.random()*20);p.exp+=gain;
    resEl.textContent=`ğŸ§˜ æ¶ˆè€—10çµåŠ›ï¼Œè·å¾—${gain}ä¿®ä¸ºç»éªŒ`;
    if(p.exp>=p.maxExp){p.exp-=p.maxExp;const ni=Math.min(ri+1,REALMS.length-1);if(ni>ri){p.realm=REALMS[ni];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);resEl.textContent+=`\nğŸ‰ çªç ´ï¼æ™‹å‡${p.realm}ï¼`;addEvent('çªç ´',`ä½ çªç ´åˆ°äº†${p.realm}ï¼`)}}
    addEvent('ä¿®ç‚¼','æ‰“åä¿®ç‚¼ï¼Œè·å¾—'+gain+'ä¿®ä¸º');
  }
  else if(type==='alchemy'){
    if(p.mp<15){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€15ï¼‰';return}
    p.mp-=15;const pill=PILLS_DB[Math.floor(Math.random()*PILLS_DB.length)];
    const success=Math.random()<(pill.rate+ri*0.05);
    if(success){state.pills.push(pill.name);resEl.textContent=`âš—ï¸ ç‚¼ä¸¹æˆåŠŸï¼è·å¾—ã€Œ${pill.name}ã€- ${pill.desc}`;addEvent('ç‚¼ä¸¹',`æˆåŠŸç‚¼åˆ¶${pill.name}`)}
    else{resEl.textContent='âš—ï¸ ç‚¼ä¸¹å¤±è´¥â€¦ä¸¹ç‚‰ç‚¸äº†ğŸ’¥';addEvent('ç‚¼ä¸¹','ç‚¼ä¸¹å¤±è´¥')}
    updatePills();
  }
  else if(type==='dual'){
    const tid=document.getElementById('dualSelect').value;if(!tid){resEl.textContent='è¯·é€‰æ‹©åŒä¿®å¯¹è±¡';return}
    const npc=state.npcs.find(n=>n.id===tid);if(!npc){resEl.textContent='å¯¹è±¡ä¸å­˜åœ¨';return}
    if(p.mp<20){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€20ï¼‰';return}
    p.mp-=20;const rel=state.relations[tid]||{love:0};
    const gain=20+ri*8+Math.floor(rel.love/5);p.exp+=gain;rel.love=Math.min(100,rel.love+5);
    resEl.textContent=`ğŸ’ ä¸${npc.name}åŒä¿®ï¼Œè·å¾—${gain}ä¿®ä¸ºï¼Œå¥½æ„Ÿ+5`;
    if(Math.random()<0.15&&!state.pregnancies[tid]?.active){state.pregnancies[tid]={active:true,days:1,stage:'åˆæœŸ'};resEl.textContent+=`\nğŸŒ± åŒä¿®è¿‡ç¨‹ä¸­â€¦${npc.name}å—å­•äº†ï¼`;addEvent('å¤§äº‹',`åŒä¿®ä¸­${npc.name}æ„å¤–å—å­•ï¼`)}
    if(p.exp>=p.maxExp){p.exp-=p.maxExp;const ni=Math.min(ri+1,REALMS.length-1);if(ni>ri){p.realm=REALMS[ni];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);resEl.textContent+=`\nğŸ‰ çªç ´${p.realm}ï¼`;addEvent('çªç ´',`åŒä¿®çªç ´åˆ°${p.realm}ï¼`)}}
    addEvent('åŒä¿®',`ä¸${npc.name}åŒä¿®`);
  }
  else if(type==='seed'){
    const tid=document.getElementById('seedSelect').value;if(!tid){resEl.textContent='è¯·é€‰æ‹©ç›®æ ‡';return}
    const npc=state.npcs.find(n=>n.id===tid);if(!npc){resEl.textContent='ç›®æ ‡ä¸å­˜åœ¨';return}
    if(state.pregnancies[tid]?.active){resEl.textContent=`${npc.name}å·²ç»æ€€å­•äº†`;return}
    if(p.mp<30){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€30ï¼‰';return}
    p.mp-=30;state.pregnancies[tid]={active:true,days:1,stage:'åˆæœŸ'};
    resEl.textContent=`ğŸŒ± æ’­ç§æœ¯æ–½å±•æˆåŠŸï¼${npc.name}å—å­•äº†ï¼`;
    addEvent('å¤§äº‹',`å¯¹${npc.name}æ–½å±•æ’­ç§æœ¯æˆåŠŸï¼`);
    const rel=state.relations[tid];if(rel)rel.love=Math.max(0,rel.love-5);
  }
  else if(type==='study'){
    if(p.mp<10){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€10ï¼‰';return}
    p.mp-=10;const chance=0.15+ri*0.02;
    if(Math.random()<chance){const gain=30+ri*10;p.exp+=gain;resEl.textContent=`ğŸ“– å‚æ‚Ÿæœ‰æˆï¼è·å¾—${gain}ä¿®ä¸º`;addEvent('å‚æ‚Ÿ','åŠŸæ³•å‚æ‚Ÿæœ‰æˆ')}
    else{resEl.textContent='ğŸ“– å¿ƒå¢ƒä¸å¤Ÿï¼Œæœªèƒ½é¢†æ‚Ÿâ€¦';addEvent('å‚æ‚Ÿ','å‚æ‚Ÿå¤±è´¥')}
  }
  save();refreshAll();
}

function usePill(name){
  const idx=state.pills.indexOf(name);if(idx<0)return;
  const pill=PILLS_DB.find(p=>p.name===name);if(!pill)return;
  state.pills.splice(idx,1);const p=state.player,resEl=document.getElementById('res-pill');resEl.style.display='block';
  if(pill.effect==='hp'){p.hp=Math.min(p.maxHp,p.hp+pill.val);resEl.textContent=`ğŸ’Š æœç”¨${name}ï¼Œæ¢å¤${pill.val}æ°”è¡€`}
  else if(pill.effect==='mp'){p.mp=Math.min(p.maxMp,p.mp+pill.val);resEl.textContent=`ğŸ’Š æœç”¨${name}ï¼Œæ¢å¤${pill.val}çµåŠ›`}
  else if(pill.effect==='exp'){p.exp+=pill.val;resEl.textContent=`ğŸ’Š æœç”¨${name}ï¼Œè·å¾—${pill.val}ä¿®ä¸º`;const ri=REALMS.indexOf(p.realm);if(p.exp>=p.maxExp){p.exp-=p.maxExp;const ni=Math.min(ri+1,REALMS.length-1);if(ni>ri){p.realm=REALMS[ni];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);resEl.textContent+=` çªç ´${p.realm}ï¼`}}}
  else if(pill.effect==='breakthrough'){const ri=REALMS.indexOf(p.realm);if(Math.random()<0.3&&ri<REALMS.length-1){p.realm=REALMS[ri+1];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);resEl.textContent=`ğŸ’Š ç ´å¢ƒä¸¹ç”Ÿæ•ˆï¼çªç ´åˆ°${p.realm}ï¼`;addEvent('çªç ´',`ç ´å¢ƒä¸¹çªç ´åˆ°${p.realm}ï¼`)}else resEl.textContent='ğŸ’Š ç ´å¢ƒä¸¹â€¦æœªèƒ½çªç ´'}
  else if(pill.effect==='love'){resEl.textContent=`ğŸ’Š åˆæ¬¢æ•£éœ€è¦å¯¹ç›®æ ‡ä½¿ç”¨ï¼ˆåœ¨å¯¹è¯ä¸­ä½¿ç”¨å–‚ä¸¹åŠŸèƒ½ï¼‰`; state.pills.push(name)}
  else if(pill.effect==='fertility'){resEl.textContent=`ğŸ’Š åŠ©å­•ä¸¹æ•ˆæœå·²æ¿€æ´»`}
  save();refreshAll();updatePills();
}

// ========== ç§˜å¢ƒç³»ç»Ÿ ==========
async function enterRealm(name){
  const realm=REALMS_DB.find(r=>r.name===name);if(!realm)return;
  const compId=document.getElementById('realmCompanion').value;
  const comp=compId?state.npcs.find(n=>n.id===compId):null;
  if(name==='åŒä¿®ç§˜å¢ƒ'&&!comp){alert('åŒä¿®ç§˜å¢ƒå¿…é¡»æºå¸¦åŒä¼´ï¼');return}
  const log=document.getElementById('realmLog');log.style.display='block';log.innerHTML='';
  const p=state.player,ri=REALMS.indexOf(p.realm);

  function addLog(text){log.innerHTML+=`<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.03)">${text}</div>`;log.scrollTop=log.scrollHeight}

  addLog(`ğŸŒ€ è¿›å…¥ã€Œ${name}ã€${comp?'ï¼Œæºå¸¦åŒä¼´ï¼š'+comp.name:'ï¼Œç‹¬è‡ªå‰å¾€'}â€¦`);
  addEvent('ç§˜å¢ƒ',`è¿›å…¥${name}${comp?'ï¼ˆæº'+comp.name+'ï¼‰':''}`);

  const stages=3+Math.floor(Math.random()*3);
  for(let i=0;i<stages;i++){
    await new Promise(r=>setTimeout(r,800));
    const roll=Math.random();
    if(roll<0.3){
      const dmg=Math.floor(10+Math.random()*20*(realm.level+1));
      p.hp=Math.max(1,p.hp-dmg);
      addLog(`âš”ï¸ ç¬¬${i+1}å±‚ï¼šé­é‡å¦–å…½ï¼å—åˆ°${dmg}ç‚¹ä¼¤å®³${comp?'ï¼Œ'+comp.name+'åœ¨èº«æ—ååŠ©æˆ˜æ–—':''}`);
      if(comp){const rel=state.relations[comp.id];if(rel)rel.love=Math.min(100,rel.love+2)}
    }else if(roll<0.6){
      const reward=realm.rewards[Math.floor(Math.random()*realm.rewards.length)];
      const expGain=15+realm.level*10+Math.floor(Math.random()*20);p.exp+=expGain;
      addLog(`âœ¨ ç¬¬${i+1}å±‚ï¼šå‘ç°${reward}ï¼è·å¾—${expGain}ä¿®ä¸º`);
    }else if(roll<0.8&&comp){
      const rel=state.relations[comp.id];if(rel)rel.love=Math.min(100,rel.love+5);
      addLog(`ğŸ’• ç¬¬${i+1}å±‚ï¼šä¸${comp.name}åœ¨ç§˜å¢ƒä¸­äº²å¯†äº’åŠ¨ï¼Œå¥½æ„Ÿ+5`);
      if(name==='åŒä¿®ç§˜å¢ƒ'&&Math.random()<0.2&&!state.pregnancies[comp.id]?.active){
        state.pregnancies[comp.id]={active:true,days:1,stage:'åˆæœŸ'};
        addLog(`ğŸŒ± ç§˜å¢ƒçµæ°”å‚¬åŒ–â€¦${comp.name}å—å­•äº†ï¼`);addEvent('å¤§äº‹',`ç§˜å¢ƒä¸­${comp.name}å—å­•ï¼`);
      }
    }else{
      p.mp=Math.min(p.maxMp,p.mp+15);
      addLog(`ğŸŒ¿ ç¬¬${i+1}å±‚ï¼šå‘ç°çµæ³‰ï¼Œæ¢å¤15çµåŠ›`);
    }
    // æ£€æŸ¥çªç ´
    if(p.exp>=p.maxExp){p.exp-=p.maxExp;const ni=Math.min(ri+1,REALMS.length-1);if(ni>REALMS.indexOf(p.realm)){p.realm=REALMS[ni];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);addLog(`ğŸ‰ ç§˜å¢ƒä¸­çªç ´åˆ°${p.realm}ï¼`);addEvent('çªç ´',`ç§˜å¢ƒä¸­çªç ´åˆ°${p.realm}ï¼`)}}
    save();refreshAll();
  }
  await new Promise(r=>setTimeout(r,500));
  addLog(`ğŸ ç§˜å¢ƒæ¢ç´¢å®Œæ¯•ï¼${comp?comp.name+'ä¸ä½ ä¸€åŒå®‰å…¨è¿”å›':'å®‰å…¨è¿”å›'}`);
  if(comp&&state.api.url&&state.api.key){
    addLog(`ğŸ’¬ ${comp.name}å¯¹è¿™æ¬¡ç§˜å¢ƒä¹‹æ—…æœ‰è¯è¯´â€¦`);
    await callAI(comp,[{role:'user',content:`æˆ‘ä»¬åˆšä¸€èµ·é—¯å®Œ${name}ï¼Œä½ æœ‰ä»€ä¹ˆæ„Ÿæƒ³ï¼Ÿ`}],'realm',log,reply=>{
      if(!state.chatHistories[comp.id])state.chatHistories[comp.id]=[];
      state.chatHistories[comp.id].push({role:'user',content:`ï¼ˆç§˜å¢ƒå½’æ¥ï¼‰æˆ‘ä»¬åˆšä¸€èµ·é—¯å®Œ${name}ã€‚`},{role:'assistant',content:reply});
    });
  }
  save();refreshAll();
}

// ========== è®¾ç½® ==========
function loadSettings(){
  document.getElementById('apiUrl').value=state.api.url||'';document.getElementById('apiKey').value=state.api.key||'';
  document.getElementById('apiModel').value=state.api.model||'gpt-4o';document.getElementById('apiMaxTokens').value=state.api.maxTokens||2048;
  document.getElementById('pcName').value=state.player.name||'';document.getElementById('pcGender').value=state.player.gender||'ç”·';
  document.getElementById('pcRealm').value=state.player.realm||'å‡¡äºº';document.getElementById('pcDesc').value=state.player.desc||'';
  document.getElementById('worldSetting').value=state.worldSetting||'';
}
function saveSettings(){
  state.api.url=document.getElementById('apiUrl').value.trim();state.api.key=document.getElementById('apiKey').value.trim();
  state.api.model=document.getElementById('apiModel').value.trim()||'gpt-4o';state.api.maxTokens=parseInt(document.getElementById('apiMaxTokens').value)||2048;
  state.player.name=document.getElementById('pcName').value.trim()||'æ— åæ•£ä¿®';state.player.gender=document.getElementById('pcGender').value;
  state.player.realm=document.getElementById('pcRealm').value;state.player.desc=document.getElementById('pcDesc').value.trim();
  state.worldSetting=document.getElementById('worldSetting').value.trim();
  save();refreshAll();const m=document.getElementById('saveMsg');m.textContent='âœ…å·²ä¿å­˜';setTimeout(()=>m.textContent='',2000);
}

// ========== é¡µé¢åˆ‡æ¢ ==========
function switchPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  document.getElementById('pg-'+name)?.classList.add('active');
  document.querySelector(`.nb[data-page="${name}"]`)?.classList.add('active');
}

// ========== äº‹ä»¶ç»‘å®š ==========
document.querySelectorAll('.nb').forEach(btn=>{btn.addEventListener('click',()=>switchPage(btn.dataset.page))});

document.getElementById('chatSelect').addEventListener('change',function(){if(this.value){currentChatId=this.value;loadChat()}});
document.getElementById('msgSelect').addEventListener('change',function(){if(this.value){currentMsgId=this.value;loadMsgChat()}});

document.getElementById('sendBtn').addEventListener('click',()=>{const i=document.getElementById('chatInput'),t=i.value.trim();if(!t)return;i.value='';i.style.height='auto';sendChat(t)});
document.getElementById('msgSendBtn').addEventListener('click',()=>{const i=document.getElementById('msgInput'),t=i.value.trim();if(!t)return;i.value='';i.style.height='auto';sendRemote(t)});

document.getElementById('chatInput').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('sendBtn').click()}});
document.getElementById('msgInput').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('msgSendBtn').click()}});

[document.getElementById('chatInput'),document.getElementById('msgInput')].forEach(el=>{if(el)el.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,90)+'px'})});

// é¢å¯¹é¢å¿«æ·åŠ¨ä½œ
document.querySelectorAll('[data-act]').forEach(btn=>{btn.addEventListener('click',()=>{
  if(!currentChatId)return alert('é€‰æ‹©NPC');
  const npc=state.npcs.find(n=>n.id===currentChatId);if(!npc)return;
  const act=btn.dataset.act;
  const map={
    'è°ƒæƒ…':`*é è¿‘${npc.name}ï¼Œæš§æ˜§åœ°æ‰“é‡* ä½ ä»Šå¤©æ ¼å¤–è¯±äººã€‚`,
    'åŒä¿®':`*æ¡ä½${npc.name}çš„æ‰‹ï¼ŒçµåŠ›æµè½¬* æ¥åŒä¿®å§ã€‚`,
    'å¼ºåˆ¶æ’­ç§':`*çµåŠ›æš´æ¶Œï¼Œé‡‘è‰²çµçº¹æµ®ç°* ${npc.name}ï¼Œä¹–ä¹–å—å­•ã€‚*æ’­ç§æœ¯æ³•çŒå…¥${npc.name}ä½“å†…*`,
    'æŸ¥çœ‹èº«ä½“çŠ¶å†µ':`*çµè¯†æ¢å…¥${npc.name}ä½“å†…* è®©æˆ‘çœ‹çœ‹ä½ èº«ä½“æ€ä¹ˆæ ·äº†ã€‚`,
    'æ‹¥å…¥æ€€ä¸­':`*ä¸€æŠŠå°†${npc.name}æ‹‰å…¥æ€€ä¸­* åˆ«åŠ¨ï¼Œè®©æˆ‘æŠ±ä¼šå„¿ã€‚`,
    'åˆ‡ç£‹':`*æ‹”å‰‘ï¼ŒçµåŠ›æ¶ŒåŠ¨* ${npc.name}ï¼Œåˆ‡ç£‹ä¸€ä¸‹ï¼Ÿ`,
    'å–‚ä¸¹è¯':`*å–å‡ºä¸€é¢—ä¸¹è¯ï¼Œæä½${npc.name}çš„ä¸‹å·´* ä¹–ï¼Œå¼ å˜´åƒè¯ã€‚`
  };
  const text=map[act]||act;
  if(act==='å¼ºåˆ¶æ’­ç§'&&!state.pregnancies[currentChatId]?.active){
    state.pregnancies[currentChatId]={active:true,days:1,stage:'åˆæœŸ'};
    addEvent('å¤§äº‹',`å¯¹${npc.name}æ–½å±•æ’­ç§æœ¯ï¼`);save();
  }
  if(act==='å–‚ä¸¹è¯'&&state.pills.length>0){
    const pill=state.pills.shift();save();updatePills();
  }
  sendChat(text);
})});

// ä¼ è®¯å¿«æ·åŠ¨ä½œ
document.querySelectorAll('[data-msg-act]').forEach(btn=>{btn.addEventListener('click',()=>{
  if(!currentMsgId)return alert('é€‰æ‹©ä¼ è®¯å¯¹è±¡');
  const npc=state.npcs.find(n=>n.id===currentMsgId);if(!npc)return;
  const act=btn.dataset.msgAct;
  const map={
    'æƒ³ä½ äº†':`${npc.name}ï¼Œæˆ‘æƒ³ä½ äº†â€¦ä½ åœ¨åšä»€ä¹ˆï¼Ÿ`,
    'é€Ÿæ¥':`${npc.name}ï¼Œé€Ÿæ¥æˆ‘è¿™é‡Œï¼Œæœ‰è¦äº‹ï¼`,
    'æŠ¥å¹³å®‰':`${npc.name}ï¼Œæˆ‘ä¸€åˆ‡å®‰å¥½ï¼Œå‹¿å¿µã€‚`,
    'é‚€è¯·é—¯ç§˜å¢ƒ':`${npc.name}ï¼Œæœ€è¿‘å‘ç°ä¸€å¤„ç§˜å¢ƒï¼Œè¦ä¸è¦ä¸€èµ·å»é—¯ï¼Ÿ`
  };
  sendRemote(map[act]||act);
})});

// æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
document.querySelectorAll('.modal-mask').forEach(m=>{m.addEventListener('click',function(e){if(e.target===this)this.classList.remove('show')})});

// ========== åˆå§‹åŒ– ==========
loadSettings();
refreshAll();

// çµåŠ›è‡ªåŠ¨æ¢å¤ï¼ˆæ¯30ç§’æ¢å¤5çµåŠ›ï¼‰
setInterval(()=>{
  if(state.player.mp<state.player.maxMp){
    state.player.mp=Math.min(state.player.maxMp,state.player.mp+5);
    save();updatePlayerUI();
  }
},30000);
</script>
</body>
</html>