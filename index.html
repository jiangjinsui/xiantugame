<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»™é€”Â·é€†å‘½å½•</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#08080f">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080f;--panel:#101020;--card:#161630;--border:#252550;--gold:#d4a843;--cyan:#5ce0d8;--pink:#e87ca0;--text:#c8c8e0;--dim:#6a6a8a;--danger:#e85050;--green:#50c878;--purple:#a070e0;--orange:#e0a050}
body{font-family:'Microsoft YaHei','PingFang SC',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
button{cursor:pointer;font-family:inherit}input,textarea,select{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;height:48px}
.topbar .logo h1{font-size:16px;color:var(--gold);text-shadow:0 0 15px rgba(212,168,67,.3)}
.topbar .pinfo{display:flex;align-items:center;gap:12px;font-size:11px}
.topbar .pinfo .pn{color:var(--cyan);font-weight:bold;font-size:13px}
.topbar .pinfo .pr{color:var(--gold)}
.mini-bars{display:flex;gap:8px;align-items:center}
.mini-bar{width:60px;height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden}
.mini-bar .mf{height:100%;border-radius:3px;transition:width .5s}
.sf-hp{background:linear-gradient(90deg,#e85050,#ff7070)}.sf-mp{background:linear-gradient(90deg,#5070e8,#70a0ff)}.sf-exp{background:linear-gradient(90deg,#d4a843,#f0d060)}
.main-content{flex:1;overflow:hidden;position:relative}
.page{display:none;flex-direction:column;height:100%;position:absolute;inset:0}.page.active{display:flex}
.page-hd{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;align-items:center;justify-content:space-between}
.page-hd h2{font-size:16px;color:var(--gold)}
.page-bd{flex:1;overflow-y:auto;padding:16px}
.bottomnav{display:flex;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0;height:56px;overflow-x:auto}
.nb{flex:1;min-width:38px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:none;border:none;color:var(--dim);font-size:6px;transition:all .2s;position:relative}
.nb .ni{font-size:14px}.nb:hover{color:var(--text)}.nb.active{color:var(--cyan)}
.nb.active::after{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;background:var(--cyan);border-radius:0 0 2px 2px}
.nb .notif-dot{position:absolute;top:4px;right:25%;width:6px;height:6px;background:var(--danger);border-radius:50%;display:none}
.chat-header{padding:10px 16px;border-bottom:1px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:space-between}
.chat-header .ch-info{font-size:10px;color:var(--dim);margin-left:8px}
.chat-header select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:6px;font-size:11px}
.msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:78%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.75;white-space:pre-wrap;word-break:break-word;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.sys{align-self:center;max-width:90%;background:rgba(212,168,67,.08);border:1px solid rgba(212,168,67,.15);color:var(--gold);font-size:11px;text-align:center;border-radius:8px}
.msg.user{align-self:flex-end;background:linear-gradient(135deg,rgba(232,124,160,.12),rgba(232,124,160,.06));border:1px solid rgba(232,124,160,.12)}
.msg.ai{align-self:flex-start;background:var(--card);border:1px solid var(--border)}
.msg .ms{font-size:10px;color:var(--dim);margin-bottom:3px}
.msg-remote{border-left:2px solid var(--purple)!important}
.chat-actions{padding:4px 12px;background:var(--panel);border-top:1px solid var(--border);display:flex;gap:4px;flex-wrap:wrap;justify-content:center}
.abtn{padding:4px 10px;border:1px solid var(--border);background:none;color:var(--pink);border-radius:12px;font-size:10px;transition:all .2s;white-space:nowrap}
.abtn:hover{border-color:var(--pink);background:rgba(232,124,160,.08)}
.abtn.cyan{color:var(--cyan)}.abtn.cyan:hover{border-color:var(--cyan);background:rgba(92,224,216,.08)}
.chat-input{padding:10px 14px;border-top:1px solid var(--border);background:var(--panel);display:flex;gap:8px;align-items:flex-end}
.chat-input textarea{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;resize:none;font-size:13px;min-height:38px;max-height:90px}
.chat-input textarea:focus{outline:0;border-color:var(--cyan)}
.sbtn{padding:8px 16px;background:linear-gradient(135deg,var(--cyan),#40b0a8);border:none;color:var(--bg);font-weight:bold;border-radius:10px;font-size:12px;white-space:nowrap}
.sbtn:disabled{opacity:.35;cursor:not-allowed}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .25s}
.card:hover{border-color:rgba(92,224,216,.4);transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.card .cn{font-size:14px;font-weight:bold;color:var(--cyan)}
.card .cr{font-size:10px;color:var(--gold);margin-top:2px}
.card .cd{font-size:11px;color:var(--dim);margin-top:5px;line-height:1.5;max-height:44px;overflow:hidden}
.card .ctags{display:flex;flex-wrap:wrap;gap:3px;margin-top:6px}
.tag{padding:1px 6px;border-radius:6px;font-size:9px}
.tag-p{background:rgba(232,124,160,.1);color:var(--pink)}.tag-c{background:rgba(92,224,216,.1);color:var(--cyan)}.tag-g{background:rgba(80,200,120,.1);color:var(--green)}.tag-o{background:rgba(224,160,80,.1);color:var(--orange)}.tag-r{background:rgba(232,80,80,.1);color:var(--danger)}
.card .cbtns{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.card .cbtns button{padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text);font-size:10px;transition:all .2s}
.card .cbtns button:hover{border-color:var(--cyan);color:var(--cyan)}
.card .cbtns .bdel:hover{border-color:var(--danger);color:var(--danger)}
.rel-bar{height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;margin-top:3px}
.rel-fill{height:100%;background:linear-gradient(90deg,var(--pink),#ff70a0);border-radius:3px;transition:width .3s}
.cult-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.cult-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;transition:all .3s;position:relative;overflow:hidden}
.cult-card::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 120%,rgba(92,224,216,.05),transparent);pointer-events:none}
.cult-card:hover{border-color:rgba(92,224,216,.3);transform:translateY(-3px)}
.cult-card .ci{font-size:32px;margin-bottom:6px}
.cult-card .ct{font-size:13px;font-weight:bold;color:var(--gold)}
.cult-card .cdesc{font-size:10px;color:var(--dim);margin-top:4px;line-height:1.4}
.cult-card .cbtn{margin-top:10px;padding:6px 18px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(135deg,rgba(92,224,216,.1),rgba(92,224,216,.02));color:var(--cyan);font-size:11px;font-weight:bold}
.cult-card .cbtn:hover{border-color:var(--cyan)}
.cult-card .cbtn:disabled{opacity:.3;cursor:not-allowed}
.cult-result{margin-top:8px;padding:8px;background:rgba(212,168,67,.06);border:1px solid rgba(212,168,67,.12);border-radius:8px;font-size:10px;color:var(--gold);line-height:1.6;display:none;text-align:left}
.realm-banner{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px;position:relative;overflow:hidden}
.realm-banner::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(160,112,224,.06),rgba(92,224,216,.04));pointer-events:none}
.realm-banner h3{color:var(--purple);font-size:14px}
.realm-banner p{color:var(--dim);font-size:11px;margin-top:4px}
.realm-select{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.realm-select button{padding:5px 12px;border:1px solid var(--border);background:none;color:var(--text);border-radius:8px;font-size:11px;transition:all .2s}
.realm-select button:hover{border-color:var(--purple);color:var(--purple)}
.realm-select button:disabled{opacity:.4;cursor:not-allowed}
.realm-log{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;max-height:300px;overflow-y:auto;font-size:12px;line-height:1.7}
.fg{margin-bottom:12px}
.fg label{display:block;font-size:11px;color:var(--dim);margin-bottom:3px}
.fg input,.fg textarea,.fg select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:8px;font-size:12px}
.fg textarea{min-height:70px;resize:vertical}
.fg input:focus,.fg textarea:focus,.fg select:focus{outline:0;border-color:var(--cyan)}
.fg .row{display:flex;gap:8px}.fg .row>*{flex:1}
.fbtn{padding:7px 20px;border:none;font-weight:bold;border-radius:8px;font-size:12px;transition:all .2s}
.fbtn:hover{opacity:.85}
.fbtn-gold{background:linear-gradient(135deg,var(--gold),#c09030);color:var(--bg)}
.fbtn-cyan{background:linear-gradient(135deg,var(--cyan),#40b0a8);color:var(--bg)}
.fbtn-danger{background:linear-gradient(135deg,var(--danger),#c04040);color:#fff}
.fbtn-purple{background:linear-gradient(135deg,var(--purple),#8050c0);color:#fff}
.modal-mask{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal-mask.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;width:92%;max-width:480px;max-height:82vh;overflow-y:auto}
.modal h3{color:var(--gold);margin-bottom:14px;font-size:15px}
.modal .mclose{float:right;background:none;border:0;color:var(--dim);font-size:18px}
.empty{text-align:center;color:var(--dim);padding:30px;font-size:12px}
.settings-wrap{max-width:540px;margin:0 auto}
.settings-section{margin-bottom:16px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.settings-section h3{font-size:13px;color:var(--cyan);margin-bottom:10px}
.model-list{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.model-tag{padding:3px 8px;border:1px solid var(--border);border-radius:6px;font-size:10px;color:var(--dim);cursor:pointer;transition:all .2s;background:none}
.model-tag:hover,.model-tag.active{border-color:var(--cyan);color:var(--cyan)}
.fetch-btn{padding:3px 10px;border:1px solid var(--border);background:none;color:var(--cyan);border-radius:6px;font-size:10px;margin-left:6px}
.beast-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .25s}
.beast-card:hover{border-color:rgba(224,160,80,.4);transform:translateY(-2px)}
.subtabs{display:flex;gap:0;background:var(--panel);border-bottom:1px solid var(--border);padding:0 12px}
.subtab{padding:8px 16px;background:none;border:none;color:var(--dim);font-size:11px;border-bottom:2px solid transparent;transition:all .2s}
.subtab:hover{color:var(--text)}
.subtab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.subpage{display:none;flex-direction:column;flex:1;overflow:hidden}
.subpage.active{display:flex}

/* ç‰¹æ•ˆåŠ¨ç”» */
@keyframes flashAnim{0%{opacity:1}100%{opacity:0}}
@keyframes floatUp{0%{transform:scale(.5) translateY(20px);opacity:0}30%{transform:scale(1.2) translateY(0);opacity:1}100%{transform:scale(1) translateY(-40px);opacity:0}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}

.screen-flash{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;pointer-events:none;animation:flashAnim 1.5s ease-out forwards}
.screen-flash .flash-text{font-size:24px;font-weight:bold;text-shadow:0 0 30px currentColor;animation:floatUp 1.5s ease-out forwards}
.float-num{position:fixed;z-index:150;font-size:14px;font-weight:bold;pointer-events:none;animation:floatUp 1s ease-out forwards}
.notif-toast{position:fixed;top:56px;right:12px;z-index:150;background:var(--card);border:1px solid var(--cyan);border-radius:10px;padding:10px 16px;font-size:12px;color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.4);max-width:280px;cursor:pointer;animation:slideInRight .3s ease}
.notif-toast.fading{animation:fadeOut .5s forwards}

/* æˆ˜æ–—é€‰æ‹©æŒ‰é’® */
.battle-choices{display:flex;gap:6px;padding:8px 0;flex-wrap:wrap}
.battle-choices button{padding:6px 14px;border:1px solid var(--border);background:rgba(92,224,216,.05);color:var(--cyan);border-radius:8px;font-size:11px;transition:all .2s}
.battle-choices button:hover{border-color:var(--cyan);background:rgba(92,224,216,.12)}

/* äº‹ä»¶å¼¹çª—é€‰é¡¹ */
.event-choice{text-align:left;padding:10px 14px;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;font-size:12px;transition:all .2s;width:100%;margin-bottom:6px}
.event-choice:hover{border-color:var(--pink);background:rgba(232,124,160,.06);transform:translateX(4px)}
.event-choice .ec-cost{font-size:9px;color:var(--danger);margin-top:2px}
.event-choice .ec-hint{font-size:9px;color:var(--dim);margin-top:2px}

@media(max-width:600px){.cards,.cult-grid{grid-template-columns:1fr}.mini-bars{display:none}}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo"><h1>ğŸŒ™ ä»™é€”Â·é€†å‘½å½•</h1></div>
  <div class="pinfo">
    <span class="pn" id="pName">æ— åä»™å­</span>
    <span class="pr" id="pRealm">å‡¡äºº</span>
    <div class="mini-bars">
      <div class="mini-bar" title="æ°”è¡€"><div class="mf sf-hp" id="hpBar" style="width:100%"></div></div>
      <div class="mini-bar" title="çµåŠ›"><div class="mf sf-mp" id="mpBar" style="width:100%"></div></div>
      <div class="mini-bar" title="ä¿®ä¸º"><div class="mf sf-exp" id="expBar" style="width:0%"></div></div>
    </div>
  </div>
</div>

<div class="main-content">
  <!-- äº’åŠ¨é¡µ -->
  <div class="page active" id="pg-interact">
    <div class="subtabs">
      <button class="subtab active" data-sub="chat" data-parent="interact">ğŸ’¬ é¢å¯¹é¢</button>
      <button class="subtab" data-sub="msg" data-parent="interact">ğŸ“¨ ä¼ è®¯</button>
    </div>
    <div class="subpage active" id="sub-chat">
      <div class="chat-header"><div><select id="chatSelect"><option value="">é€‰æ‹©å¯¹è¯å¯¹è±¡</option></select><span class="ch-info" id="chatInfo"></span></div></div>
      <div class="msgs" id="msgBox"><div class="msg sys">æ¬¢è¿æ¥åˆ°ä»™é€”Â·é€†å‘½å½• âœ¨ å…ˆå»âš™ï¸è®¾ç½®é…APIï¼Œå†åˆ›å»ºæˆ–ç”ŸæˆNPC~</div></div>
      <div class="chat-actions">
        <button class="abtn" data-act="æ’’å¨‡">ğŸ¥ºæ’’å¨‡</button>
        <button class="abtn" data-act="ç‰µæ‰‹">ğŸ¤ç‰µæ‰‹</button>
        <button class="abtn" data-act="ä¾å">ğŸ’•ä¾å</button>
        <button class="abtn" data-act="é€èŠ±">ğŸŒ¸é€èŠ±</button>
        <button class="abtn" data-act="äº²äº²">ğŸ’‹äº²äº²</button>
        <button class="abtn" data-act="åˆ‡ç£‹">âš”ï¸åˆ‡ç£‹</button>
        <button class="abtn cyan" data-act="å–‚ä¸¹è¯">ğŸ’Šå–‚ä¸¹</button>
        <button class="abtn cyan" data-act="æŸ¥çœ‹çŠ¶æ€">ğŸ”æŸ¥çœ‹</button>
      </div>
      <div class="chat-input"><textarea id="chatInput" placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦ï¼ˆShift+Enteræ¢è¡Œï¼‰" rows="1"></textarea><button class="sbtn" id="sendBtn">å‘é€</button></div>
    </div>
    <div class="subpage" id="sub-msg">
      <div class="chat-header"><div><select id="msgSelect"><option value="">é€‰æ‹©ä¼ è®¯å¯¹è±¡</option></select><span class="ch-info" id="msgInfo">è¿œç¨‹ä¼ è®¯</span></div></div>
      <div class="msgs" id="msgMsgBox"><div class="msg sys">ğŸ“¨ ä¼ è®¯ç³»ç»Ÿï¼šè¿œç¨‹è”ç»œ~</div></div>
      <div class="chat-actions">
        <button class="abtn" data-msg-act="æƒ³ä½ äº†">ğŸ’•æƒ³ä½ </button>
        <button class="abtn" data-msg-act="åœ¨å¹²å˜›">ğŸ¤”åœ¨å¹²å˜›</button>
        <button class="abtn" data-msg-act="å¿«æ¥æ‰¾æˆ‘">ğŸƒå¿«æ¥</button>
        <button class="abtn cyan" data-msg-act="ä¸€èµ·é—¯ç§˜å¢ƒå§">ğŸŒ€é‚€ç§˜å¢ƒ</button>
      </div>
      <div class="chat-input"><textarea id="msgInput" placeholder="ä¼ è®¯å†…å®¹â€¦" rows="1"></textarea><button class="sbtn" id="msgSendBtn">ä¼ è®¯</button></div>
    </div>
  </div>

  <!-- ä¿®ç‚¼é¡µ -->
  <div class="page" id="pg-cult">
    <div class="page-hd"><h2>ğŸ§˜ ä¿®ç‚¼æ´åºœ</h2></div>
    <div class="page-bd"><div class="cult-grid">
      <div class="cult-card"><div class="ci">ğŸ§˜</div><div class="ct">æ‰“åä¿®ç‚¼</div><div class="cdesc">å¸æ”¶çµæ°”ï¼Œæå‡ä¿®ä¸º</div><button class="cbtn" onclick="doCult('meditate')">ä¿®ç‚¼</button><div class="cult-result" id="res-meditate"></div></div>
      <div class="cult-card"><div class="ci">âš—ï¸</div><div class="ct">ç‚¼ä¸¹</div><div class="cdesc">ç‚¼åˆ¶ä¸¹è¯</div><button class="cbtn" onclick="doCult('alchemy')">ç‚¼ä¸¹</button><div class="cult-result" id="res-alchemy"></div></div>
      <div class="cult-card"><div class="ci">ğŸ’</div><div class="ct">åŒä¿®</div><div class="cdesc">ä¸é“ä¾£åŒä¿®</div><select id="dualSelect" style="margin-top:6px;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:6px;font-size:10px;width:100%"><option value="">é€‰æ‹©å¯¹è±¡</option></select><button class="cbtn" onclick="doCult('dual')">åŒä¿®</button><div class="cult-result" id="res-dual"></div></div>
      <div class="cult-card"><div class="ci">ğŸ“–</div><div class="ct">å‚æ‚ŸåŠŸæ³•</div><div class="cdesc">æ¦‚ç‡çªç ´</div><button class="cbtn" onclick="doCult('study')">å‚æ‚Ÿ</button><div class="cult-result" id="res-study"></div></div>
      <div class="cult-card"><div class="ci">ğŸ’Š</div><div class="ct">ä¸¹è¯èƒŒåŒ…</div><div id="pillList" style="margin-top:6px;font-size:10px;color:var(--dim)">æš‚æ— </div><div class="cult-result" id="res-pill"></div></div>
      <div class="cult-card"><div class="ci">âš¡</div><div class="ct">æ¸¡åŠ«</div><div class="cdesc">å†å¤©é›·ä¹‹åŠ«</div><select id="tribCompanion" style="margin-top:6px;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:6px;font-size:10px;width:100%"><option value="">æ— äººæŠ¤æ³•</option></select><button class="cbtn" onclick="doCult('tribulation')">æ¸¡åŠ«</button><div class="cult-result" id="res-tribulation"></div></div>
    </div></div>
  </div>

  <!-- æ¢ç´¢é¡µ -->
  <div class="page" id="pg-explore">
    <div class="subtabs">
      <button class="subtab active" data-sub="realm" data-parent="explore">ğŸŒ€ ç§˜å¢ƒ</button>
      <button class="subtab" data-sub="beast" data-parent="explore">ğŸ¾ çµå…½</button>
    </div>
    <div class="subpage active" id="sub-realm">
      <div class="page-bd">
        <div class="realm-banner"><h3>ğŸŒ€ é€‰æ‹©ç§˜å¢ƒ</h3><p>æºå¸¦åŒä¼´é—¯è¡ï¼Œå±é™©ä¸æœºç¼˜å¹¶å­˜ï¼</p>
          <div style="margin-top:8px"><label style="font-size:10px;color:var(--dim)">åŒä¼´ï¼š</label><select id="realmCompanion" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:6px;font-size:10px"><option value="">ç‹¬è‡ªå‰å¾€</option></select></div>
          <div class="realm-select" id="realmBtns"></div>
        </div>
        <div class="realm-log" id="realmLog" style="display:none"></div>
      </div>
    </div>
    <div class="subpage" id="sub-beast">
      <div class="page-hd"><h2>ğŸ¾ çµå…½</h2><button class="fbtn fbtn-cyan" onclick="catchBeast()" style="font-size:10px;padding:5px 12px">ğŸ¯ æ•æ‰</button></div>
      <div class="page-bd">
        <div id="beastResult" class="cult-result" style="margin-bottom:12px"></div>
        <div class="cards" id="beastCards"></div>
        <div class="empty" id="beastEmpty">è¿˜æ²¡æœ‰çµå…½~</div>
      </div>
    </div>
  </div>

  <!-- è§’è‰²é¡µ -->
  <div class="page" id="pg-chars">
    <div class="subtabs">
      <button class="subtab active" data-sub="npc" data-parent="chars">ğŸ‘¥ ç®¡ç†</button>
      <button class="subtab" data-sub="rel" data-parent="chars">ğŸ’• å…³ç³»</button>
      <button class="subtab" data-sub="event" data-parent="chars">ğŸ“œ äº‹ä»¶</button>
    </div>
    <div class="subpage active" id="sub-npc">
      <div class="page-hd"><h2>ğŸ‘¥ è§’è‰²ç®¡ç†</h2>
        <div style="display:flex;gap:6px">
          <button class="fbtn fbtn-purple" onclick="aiGenerateNpc()" style="font-size:10px;padding:5px 12px">ğŸ²AIç”Ÿæˆ</button>
          <button class="fbtn fbtn-cyan" onclick="openNpcModal()" style="font-size:10px;padding:5px 12px">âœ¨æ‰‹åŠ¨æ–°å»º</button>
        </div>
      </div>
      <div class="page-bd"><div class="cards" id="npcCards"></div><div class="empty" id="npcEmpty">è¿˜æ²¡æœ‰è§’è‰²~ ç‚¹AIç”Ÿæˆæˆ–æ‰‹åŠ¨æ–°å»º</div></div>
    </div>
    <div class="subpage" id="sub-rel">
      <div class="page-hd"><h2>ğŸ’• å…³ç³»æ€»è§ˆ</h2></div>
      <div class="page-bd"><div class="cards" id="relCards"></div><div class="empty" id="relEmpty">æš‚æ— </div></div>
    </div>
    <div class="subpage" id="sub-event">
      <div class="page-hd"><h2>ğŸ“œ ä¸–ç•Œäº‹ä»¶</h2></div>
      <div class="page-bd"><div id="eventLog"></div><div class="empty" id="eventEmpty">å¤©åœ°å¯‚é™â€¦</div></div>
    </div>
  </div>

  <!-- è®¾ç½®é¡µ -->
  <div class="page" id="pg-set">
    <div class="page-hd"><h2>âš™ï¸ è®¾ç½®</h2></div>
    <div class="page-bd"><div class="settings-wrap">
      <div class="settings-section"><h3>ğŸ”‘ AIæ¥å£</h3>
        <div class="fg"><label>APIå®Œæ•´åœ°å€</label><input id="apiUrl" placeholder="https://ä½ çš„ç«™ç‚¹.com/v1/chat/completions"></div>
        <div class="fg"><label>API Key</label><input id="apiKey" type="password" placeholder="sk-..."></div>
        <div class="fg"><label>æ¨¡å‹ <button class="fetch-btn" onclick="fetchModels()">ğŸ”„æ‹‰å–</button></label><input id="apiModel" placeholder="gpt-4o"><div class="model-list" id="modelList"></div></div>
        <div class="fg"><label>æœ€å¤§Token</label><input id="apiMaxTokens" type="number" value="2048"></div>
        <button class="fbtn fbtn-cyan" onclick="saveApi()">ğŸ’¾ ä¿å­˜API</button>
        <span id="apiSaveMsg" style="color:var(--green);font-size:11px;margin-left:6px"></span>
      </div>
      <div class="settings-section"><h3>ğŸ­ ä¸»æ§äººè®¾</h3>
        <div class="fg"><div class="row"><div><label>åå·</label><input id="pcName" placeholder="è§’è‰²å"></div><div><label>æ€§åˆ«</label><select id="pcGender"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option><option value="å…¶ä»–">å…¶ä»–</option></select></div></div></div>
        <div class="fg"><label>å¢ƒç•Œ</label><select id="pcRealm"><option>å‡¡äºº</option><option>ç»ƒæ°”æœŸ</option><option>ç­‘åŸºæœŸ</option><option>é‡‘ä¸¹æœŸ</option><option>å…ƒå©´æœŸ</option><option>åŒ–ç¥æœŸ</option><option>åˆä½“æœŸ</option><option>å¤§ä¹˜æœŸ</option><option>æ¸¡åŠ«æœŸ</option><option>ä»™äºº</option></select></div>
        <div class="fg"><label>äººè®¾æè¿°</label><textarea id="pcDesc" placeholder="æ€§æ ¼ã€å¤–è²Œã€èƒ½åŠ›â€¦"></textarea></div>
      </div>
      <div class="settings-section"><h3>ğŸŒ ä¸–ç•Œè§‚è¡¥å……</h3><div class="fg"><textarea id="worldSetting" placeholder="é¢å¤–è®¾å®šâ€¦"></textarea></div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="fbtn fbtn-gold" onclick="saveSettings()">ğŸ’¾ä¿å­˜å…¨éƒ¨</button>
        <button class="fbtn fbtn-danger" onclick="if(confirm('æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ')){localStorage.clear();location.reload()}">ğŸ—‘ï¸é‡ç½®</button>
        <span id="saveMsg" style="color:var(--green);font-size:11px"></span>
      </div>
    </div></div>
  </div>
</div>

<div class="bottomnav">
  <button class="nb active" data-page="interact"><span class="ni">ğŸ’¬</span><span class="notif-dot" id="notifChat"></span>äº’åŠ¨</button>
  <button class="nb" data-page="cult"><span class="ni">ğŸ§˜</span>ä¿®ç‚¼</button>
  <button class="nb" data-page="explore"><span class="ni">ğŸŒ€</span>æ¢ç´¢</button>
  <button class="nb" data-page="chars"><span class="ni">ğŸ‘¥</span>è§’è‰²</button>
  <button class="nb" data-page="set"><span class="ni">âš™ï¸</span>è®¾ç½®</button>
</div>

<!-- NPCç¼–è¾‘å¼¹çª— -->
<div class="modal-mask" id="npcModal"><div class="modal">
  <button class="mclose" onclick="closeNpcModal()">âœ•</button>
  <h3 id="npcModalTitle">âœ¨ æ–°å»ºè§’è‰²</h3><input type="hidden" id="editNpcId">
  <div class="fg"><div class="row"><div><label>åå­—</label><input id="npcName"></div><div><label>æ€§åˆ«</label><select id="npcGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select></div></div></div>
  <div class="fg"><div class="row"><div><label>å¢ƒç•Œ</label><select id="npcRealm"><option>ç»ƒæ°”æœŸ</option><option>ç­‘åŸºæœŸ</option><option>é‡‘ä¸¹æœŸ</option><option>å…ƒå©´æœŸ</option><option>åŒ–ç¥æœŸ</option><option>åˆä½“æœŸ</option><option>å¤§ä¹˜æœŸ</option><option>æ¸¡åŠ«æœŸ</option><option>ä»™äºº</option></select></div><div><label>èº«ä»½</label><input id="npcRole" placeholder="å‰‘ä¿®ã€é­”é“åœ£å­â€¦"></div></div></div>
  <div class="fg"><label>æ€§æ ¼ä¸å¤–è²Œ</label><textarea id="npcPersonality" placeholder="è¯¦ç»†æè¿°â€¦"></textarea></div>
  <div class="fg"><div class="row"><div><label>åˆå§‹å…³ç³»</label><select id="npcRelType"><option value="é™Œç”Ÿäºº">é™Œç”Ÿäºº</option><option value="åŒé—¨">åŒé—¨</option><option value="é’æ¢…ç«¹é©¬">é’æ¢…ç«¹é©¬</option><option value="å®¿æ•Œ">å®¿æ•Œ</option><option value="æš§æ˜§">æš§æ˜§</option><option value="é“ä¾£">é“ä¾£</option><option value="ä»†ä»">ä»†ä»</option></select></div><div><label>æ¨¡å¼</label><select id="npcRelMode"><option value="å¯æ”»ç•¥">å¯æ”»ç•¥</option><option value="ä¸“æƒ…">ä¸“æƒ…1v1</option></select></div></div></div>
  <div class="fg"><label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input id="npcTags" placeholder="å‚²å¨‡,æ¸©æŸ”,æ¯’èˆŒ,å¿ çŠ¬"></div>
  <div class="fg"><label>é¢å¤–AIæŒ‡ä»¤</label><textarea id="npcSysPrompt" placeholder="ç»™AIçš„é¢å¤–æŒ‡ä»¤â€¦"></textarea></div>
  <button class="fbtn fbtn-gold" onclick="saveNpc()">ğŸ’¾ä¿å­˜</button>
</div></div>

<!-- å†…å¿ƒå¼¹çª— -->
<div class="modal-mask" id="statusModal"><div class="modal">
  <button class="mclose" onclick="document.getElementById('statusModal').classList.remove('show')">âœ•</button>
  <h3>ğŸ”® <span id="statusNpcName"></span> çš„å†…å¿ƒ</h3>
  <div id="statusContent" style="font-size:12px;line-height:1.8"></div>
</div></div>

<!-- æŸ¥å²—å¼¹çª— -->
<div class="modal-mask" id="checkModal"><div class="modal">
  <button class="mclose" onclick="document.getElementById('checkModal').classList.remove('show')">âœ•</button>
  <h3 id="checkTitle">ğŸ” æŸ¥å²—</h3>
  <div id="checkContent" style="font-size:12px;line-height:1.8"></div>
</div></div>

<!-- éšæœºäº‹ä»¶å¼¹çª— -->
<div class="modal-mask" id="eventModal"><div class="modal">
  <h3 id="eventModalTitle">âš¡ äº‹ä»¶</h3>
  <div id="eventModalContent"></div>
</div></div>

<!-- AIç”ŸæˆNPCå¼¹çª— -->
<div class="modal-mask" id="aiGenModal"><div class="modal">
  <button class="mclose" onclick="document.getElementById('aiGenModal').classList.remove('show')">âœ•</button>
  <h3>ğŸ² AIç”Ÿæˆè§’è‰²</h3>
  <div class="fg"><label>ä½ æƒ³è¦ä»€ä¹ˆæ ·çš„è§’è‰²ï¼Ÿï¼ˆå¯ç•™ç©ºéšæœºï¼‰</label><textarea id="aiGenHint" placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”çš„å¸ˆå…„ã€é«˜å†·çš„å‰‘ä¿®ã€è…¹é»‘çš„é­”é“å°‘ä¸»â€¦" style="min-height:50px"></textarea></div>
  <button class="fbtn fbtn-purple" id="aiGenBtn" onclick="doAiGenerate()">ğŸ² ç”Ÿæˆ</button>
  <div id="aiGenResult" style="margin-top:12px;font-size:11px;line-height:1.7;display:none"></div>
  <div id="aiGenActions" style="margin-top:10px;display:none">
    <button class="fbtn fbtn-gold" onclick="acceptAiNpc()">âœ… é‡‡ç”¨</button>
    <button class="fbtn fbtn-cyan" onclick="editAiNpc()" style="margin-left:6px">âœï¸ ç¼–è¾‘åé‡‡ç”¨</button>
    <button class="fbtn fbtn-danger" onclick="doAiGenerate()" style="margin-left:6px">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
  </div>
</div></div>

<script>
// ========== å­˜å‚¨ ==========
const D={get(k,d){try{return JSON.parse(localStorage.getItem('xt_'+k))||d}catch{return d}},set(k,v){localStorage.setItem('xt_'+k,JSON.stringify(v))}};
const REALMS=['å‡¡äºº','ç»ƒæ°”æœŸ','ç­‘åŸºæœŸ','é‡‘ä¸¹æœŸ','å…ƒå©´æœŸ','åŒ–ç¥æœŸ','åˆä½“æœŸ','å¤§ä¹˜æœŸ','æ¸¡åŠ«æœŸ','ä»™äºº'];
const PILLS_DB=[{name:'å›æ°”ä¸¹',desc:'æ¢å¤30çµåŠ›',effect:'mp',val:30,rate:.8},{name:'åŸ¹å…ƒä¸¹',desc:'æ¢å¤50æ°”è¡€',effect:'hp',val:50,rate:.75},{name:'ç­‘åŸºä¸¹',desc:'å¤§é‡ä¿®ä¸º',effect:'exp',val:60,rate:.5},{name:'åˆæ¬¢æ•£',desc:'å¥½æ„Ÿ+20',effect:'love',val:20,rate:.35},{name:'ç ´å¢ƒä¸¹',desc:'æ¦‚ç‡çªç ´',effect:'breakthrough',val:1,rate:.2}];
const REALMS_DB=[{name:'è½éœç§˜å¢ƒ',level:0,desc:'å…¥é—¨',rewards:['çµè‰','ä½é˜¶çµçŸ³','æ®‹é¡µåŠŸæ³•']},{name:'å¹½å†¥æ´çªŸ',level:2,desc:'é˜´æ°”æ£®æ£®',rewards:['å†¥é“','ä¸­é˜¶çµçŸ³','é˜´å±æ€§åŠŸæ³•']},{name:'å¤©ç«ç†”ç‚‰',level:4,desc:'æå±é™©',rewards:['å¤©ç«ç²¾å','é«˜é˜¶çµçŸ³','ç‚¼å™¨ç§˜æ³•']},{name:'åŒä¿®ç§˜å¢ƒ',level:3,desc:'é¡»æºä¼´ä¾£',rewards:['åˆæ¬¢èŠ±','åŒä¿®åŠŸæ³•','äº²å¯†åº¦å¤§å¢']},{name:'æ··æ²Œè™šç©º',level:6,desc:'ä»™äººä¹‹ä¸‹è«å…¥',rewards:['æ··æ²Œçµæ¶²','ä»™é˜¶åŠŸæ³•','é€†å¤©é€ åŒ–']},{name:'ä¸‡å…½å±±',level:1,desc:'çµå…½æ –æ¯åœ°',rewards:['å…½ä¸¹','é©¯å…½ç»³','çµå…½è›‹']}];
const BEAST_TYPES=[
  {type:'çµå…½',color:'var(--cyan)',power:[10,30],tame:.7,names:['ç‰å…”','çµé¹¤','é’é¸¾','ç™½é¹¿','çµç‹','ä»™é²¤']},
  {type:'å¦–å…½',color:'var(--danger)',power:[30,60],tame:.3,names:['èµ¤ç„°èŸ’','å™¬é­‚è››','è¡€ç¿¼è ','ä¹å°¾å¦–ç‹','æš´çŒ¿','æ¯’è']},
  {type:'ç¥å…½',color:'var(--gold)',power:[60,100],tame:.15,names:['éº’éºŸ','ç™½æ³½','æœ±é›€','ç„æ­¦','é’é¾™','å‡¤å‡°']}
];

// éšæœºäº‹ä»¶åº“
const RANDOM_EVENTS=[
  {title:'ğŸ—¡ï¸ é­”ä¿®æˆªæ€',desc:'ä¸€åé­”ä¿®æ‹¦ä½å»è·¯ï¼Œæ€æ°”è…¾è…¾ï¼',choices:[
    {text:'âš”ï¸ è¿æˆ˜',cost:{hp:-30},reward:{exp:40},chance:.6,failCost:{hp:-50}},
    {text:'ğŸƒ é€ƒè·‘',cost:{mp:-20},reward:null,chance:.8,failCost:{hp:-20}},
    {text:'ğŸ’¬ ä»¥ç†æœäºº',cost:null,reward:{exp:10},chance:.3,failCost:{hp:-40}}
  ]},
  {title:'ğŸŒ¸ çµèŠ±ç»½æ”¾',desc:'è·¯è¾¹ä¸€æ ªåƒå¹´çµèŠ±æ­£åœ¨ç››å¼€ï¼Œçµæ°”å……æ²›ï¼',choices:[
    {text:'ğŸŒ¿ é‡‡æ‘˜',reward:{pill:'ç­‘åŸºä¸¹'},chance:.5,failCost:{hp:-15}},
    {text:'ğŸ§˜ å°±åœ°ä¿®ç‚¼',reward:{exp:50,mp:30},chance:.9},
    {text:'ğŸŒ¸ æ‘˜èŠ±é€äºº',reward:{love:10},chance:1.0}
  ]},
  {title:'ğŸ‘¤ ç¥ç§˜è€è€…',desc:'ä¸€ä¸ªè¡£è¡«è¤´è¤›çš„è€è€…å‘ä½ è®¨è¦çµçŸ³â€¦',choices:[
    {text:'ğŸ’° èµ äºˆ',cost:{mp:-30},reward:{exp:80},chance:.7},
    {text:'ğŸ™… å©‰æ‹’',reward:null,chance:1.0},
    {text:'ğŸ” çµè¯†æ¢æŸ¥',reward:{exp:100,pill:'ç ´å¢ƒä¸¹'},chance:.2,failCost:{hp:-60}}
  ]},
  {title:'ğŸ¦Š å—ä¼¤çµç‹',desc:'ä¸€åªçµç‹å€’åœ¨è·¯è¾¹ï¼Œå¥„å¥„ä¸€æ¯â€¦',choices:[
    {text:'ğŸ’Š æ•‘æ²»',cost:{mp:-15},reward:{beast:true},chance:.6},
    {text:'ğŸš¶ è·¯è¿‡',reward:null,chance:1.0},
    {text:'ğŸ” æŸ¥çœ‹ä¼¤åŠ¿',reward:{exp:20},chance:.8}
  ]},
  {title:'ğŸŒ™ æœˆä¸‹å¥‡é‡',desc:'æœˆå…‰å¦‚æ°´ï¼Œä½ æ„Ÿåˆ°ä½“å†…çµåŠ›æ¶ŒåŠ¨â€¦',choices:[
    {text:'ğŸ§˜ é¡ºåŠ¿ä¿®ç‚¼',reward:{exp:60,mp:20},chance:.85},
    {text:'ğŸŒ™ èµæœˆ',reward:{mp:40},chance:1.0},
    {text:'ğŸ“– å‚æ‚ŸæœˆååŠŸæ³•',reward:{exp:120},chance:.25,failCost:{mp:-30}}
  ]},
  {title:'ğŸ’ çµçŸ³çŸ¿è„‰',desc:'å‘ç°ä¸€å¤„éšç§˜çš„çµçŸ³çŸ¿è„‰ï¼',choices:[
    {text:'â›ï¸ å¼€é‡‡',cost:{mp:-20},reward:{exp:50,pill:'å›æ°”ä¸¹'},chance:.7,failCost:{hp:-25}},
    {text:'ğŸ“ è®°ä¸‹ä½ç½®',reward:{exp:10},chance:1.0},
    {text:'ğŸƒ ç‹¬å',reward:{exp:80,pill:'ç­‘åŸºä¸¹'},chance:.4,failCost:{hp:-40}}
  ]}
];

let state=D.get('state',{
  player:{name:'æ— åä»™å­',gender:'å¥³',realm:'å‡¡äºº',desc:'',hp:100,maxHp:100,mp:50,maxMp:50,exp:0,maxExp:100},
  api:{url:'',key:'',model:'gpt-4o',maxTokens:2048},
  worldSetting:'',npcs:[],relations:{},chatHistories:{},msgHistories:{},events:[],pregnancies:{},pills:[],beasts:[],lastTalkTo:null
});
let aiGenTemp=null; // AIç”ŸæˆNPCä¸´æ—¶æ•°æ®
let sending=false; // é˜²æ­¢é‡å¤å‘é€

function save(){D.set('state',state)}
function getApiUrl(){return state.api.url.trim().replace(/\/+$/,'')}

// ========== è§†è§‰ç‰¹æ•ˆ ==========
function screenFlash(color,text){
  const el=document.createElement('div');
  el.className='screen-flash';
  el.style.background=`radial-gradient(circle,${color}33,transparent)`;
  if(text)el.innerHTML=`<div class="flash-text" style="color:${color}">${text}</div>`;
  document.body.appendChild(el);setTimeout(()=>el.remove(),1500);
}
function floatNum(text,color,x,y){
  const el=document.createElement('div');el.className='float-num';el.textContent=text;
  el.style.color=color;el.style.textShadow=`0 0 8px ${color}`;
  el.style.left=(x||window.innerWidth/2)+'px';el.style.top=(y||window.innerHeight/2)+'px';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1000);
}
function showToast(text,onclick){
  const el=document.createElement('div');el.className='notif-toast';el.textContent=text;
  if(onclick)el.onclick=()=>{onclick();el.remove()};
  document.body.appendChild(el);
  setTimeout(()=>{el.classList.add('fading');setTimeout(()=>el.remove(),500)},4000);
}

// ========== System Prompt ==========
function buildSys(npc,mode){
  const p=state.player,rel=state.relations[npc.id]||{type:'é™Œç”Ÿäºº',love:0},preg=state.pregnancies[npc.id];
  let ps='';if(preg?.active)ps=`\nã€çŠ¶æ€ã€‘${npc.name}å·²æ€€å­•ï¼Œ${preg.stage}ï¼Œç¬¬${preg.days}å¤©ã€‚`;
  let ms='';
  if(mode==='remote')ms=`\nã€åœºæ™¯ã€‘è¿œç¨‹ä¼ è®¯ã€‚å¯å†³å®šæ˜¯å¦èµ¶æ¥ï¼Œå†³å®šèµ¶æ¥æœ«å°¾åŠ ã€èµ¶æ¥ã€‘ã€‚`;
  else if(mode==='realm')ms=`\nã€åœºæ™¯ã€‘ä¸€èµ·é—¯ç§˜å¢ƒï¼Œæå†™ç¯å¢ƒé­é‡æˆ˜æ–—äº’åŠ¨ã€‚`;
  else if(mode==='status')ms=`\nã€ä»»åŠ¡ã€‘ç¬¬ä¸‰äººç§°æè¿°${npc.name}æ­¤åˆ»å†…å¿ƒæƒ³æ³•ã€å¯¹${p.name}çš„çœŸå®æ„Ÿå—ã€èº«ä½“çŠ¶æ€ã€åœ¨åšä»€ä¹ˆã€‚300å­—ã€‚`;
  else if(mode==='npc-check')ms=`\nã€åœºæ™¯ã€‘${npc.name}åƒé†‹æŸ¥å²—ï¼æ ¹æ®å¥½æ„Ÿå’Œæ€§æ ¼ååº”ã€‚`;
  else if(mode==='user-check')ms=`\nã€åœºæ™¯ã€‘${p.name}æ¥æŸ¥${npc.name}çš„å²—ã€‚æ ¹æ®æ€§æ ¼ååº”ã€‚`;
  else if(mode==='tribulation')ms=`\nã€åœºæ™¯ã€‘${p.name}æ­£åœ¨æ¸¡åŠ«ï¼Œå¤©é›·é™ä¸‹ï¼${npc.name}ä½œä¸º${rel.type}åœ¨æ—æŠ¤æ³•ã€‚æ ¹æ®å¥½æ„Ÿå†³å®šæ˜¯å¦èˆèº«æŒ¡é›·ã€‚å¥½æ„Ÿ80ä»¥ä¸Šå¤§æ¦‚ç‡æŒ¡é›·ã€‚æå†™å¤©é›·ã€æˆ˜æ–—ã€æƒ…æ„Ÿã€‚`;
  const social=state.socialNet?.[npc.id];
let socialInfo='';
if(social?.friends?.length){
  socialInfo=`\nã€ç¤¾äº¤åœˆã€‘${npc.name}çš„å¥½å‹ï¼š${social.friends.map(f=>`${f.name}ï¼ˆ${f.gender}Â·${f.relation}Â·äº²å¯†${f.closeness}ï¼‰`).join('ã€')}`;
  if(social.rivals?.length)socialInfo+=`\nè¿½æ±‚è€…ï¼š${social.rivals.join('ã€')}`;
}
  return `ä½ æ˜¯ä¿®ä»™ä¸–ç•Œè§’è‰²æ‰®æ¼”AIï¼Œä¸¥æ ¼æ‰®æ¼”è§’è‰²ã€‚ç»å¯¹ä¸è¦è·³å‡ºè§’è‰²ï¼Œä¸è¦ä»¥AIèº«ä»½å›å¤ã€‚
ã€ä¸–ç•Œè§‚ã€‘ä¿®ä»™ä¸–ç•Œã€‚${state.worldSetting?'è¡¥å……ï¼š'+state.worldSetting:''}
ã€è§’è‰²ã€‘${npc.name}ï½œ${npc.gender}ï½œ${npc.realm}ï½œ${npc.role||'æ•£ä¿®'}
æ€§æ ¼å¤–è²Œï¼š${npc.personality||'å¾…è®¾å®š'}
å…³ç³»ï¼š${rel.type}ï¼ˆå¥½æ„Ÿ${rel.love}/100ï¼‰ï½œ${npc.relMode||'å¯æ”»ç•¥'}
${npc.tags?.length?'æ ‡ç­¾ï¼š'+npc.tags.join('ã€'):''}${npc.sysPrompt?'\né¢å¤–ï¼š'+npc.sysPrompt:''}${ps}${socialInfo}${ms}
ã€å¯¹æ–¹ã€‘${p.name}ï½œ${p.gender}ï½œ${p.realm}ï½œ${p.desc||'ä¿®ä»™å°‘å¥³'}
ã€è§„åˆ™ã€‘æ ¹æ®å¥½æ„Ÿåº¦è°ƒæ•´æ€åº¦ã€‚å¥½æ„Ÿä½æ—¶å†·æ·¡/è­¦æƒ•ï¼Œå¥½æ„Ÿé«˜æ—¶äº²å¯†/æ¸©æŸ”ã€‚æ¯æ¬¡å›å¤æœ«å°¾ç”¨ã€å¥½æ„Ÿ+Nã€‘æˆ–ã€å¥½æ„Ÿ-Nã€‘æ ‡æ³¨å¥½æ„Ÿå˜åŒ–ï¼ˆ-5åˆ°+5ä¹‹é—´ï¼‰ã€‚`;
}

// ========== API ==========
async function fetchModels(){
  const url=document.getElementById('apiUrl').value.trim(),key=document.getElementById('apiKey').value.trim();
  if(!url||!key)return alert('å…ˆå¡«APIåœ°å€å’ŒKey');
  const base=url.replace(/\/chat\/completions\/?$/,'').replace(/\/+$/,'');
  const list=document.getElementById('modelList');
  list.innerHTML='<span style="color:var(--dim);font-size:10px">åŠ è½½ä¸­â€¦</span>';
  try{const r=await fetch(base+'/models',{headers:{'Authorization':'Bearer '+key}});if(!r.ok)throw new Error(r.status);const d=await r.json();
    const models=(d.data||d||[]).map(m=>m.id||m.name||m).filter(Boolean).sort();
    if(!models.length){list.innerHTML='æœªæ‰¾åˆ°';return}
    list.innerHTML=models.map(m=>`<button class="model-tag" onclick="document.getElementById('apiModel').value='${m}';document.querySelectorAll('.model-tag').forEach(t=>t.classList.remove('active'));this.classList.add('active')">${m}</button>`).join('');
  }catch(e){list.innerHTML=`<span style="color:var(--danger);font-size:10px">å¤±è´¥ï¼š${e.message}</span>`}}

function saveApi(){
  state.api.url=document.getElementById('apiUrl').value.trim();
  state.api.key=document.getElementById('apiKey').value.trim();
  state.api.model=document.getElementById('apiModel').value.trim()||'gpt-4o';
  state.api.maxTokens=parseInt(document.getElementById('apiMaxTokens').value)||2048;
  save();const m=document.getElementById('apiSaveMsg');m.textContent='âœ…å·²ä¿å­˜';setTimeout(()=>m.textContent='',2000)}

// ========== UIæ›´æ–° ==========
function updatePlayerUI(){
  const p=state.player;
  document.getElementById('pName').textContent=p.name;
  document.getElementById('pRealm').textContent=p.realm;
  document.getElementById('hpBar').style.width=(p.hp/p.maxHp*100)+'%';
  document.getElementById('mpBar').style.width=(p.mp/p.maxMp*100)+'%';
  document.getElementById('expBar').style.width=(p.exp/p.maxExp*100)+'%';
}

function updateNpcCards(){
  const c=document.getElementById('npcCards'),e=document.getElementById('npcEmpty');
  if(!state.npcs.length){c.innerHTML='';e.style.display='block';return}e.style.display='none';
  c.innerHTML=state.npcs.map(n=>{
    const rel=state.relations[n.id]||{type:'é™Œç”Ÿäºº',love:0},preg=state.pregnancies[n.id];
    let tags=(n.tags||[]).map(t=>`<span class="tag tag-p">${t}</span>`).join('');
    tags+=`<span class="tag tag-c">${rel.type}</span>`;
    if(preg?.active)tags+=`<span class="tag tag-g">å­•è‚²${preg.days}å¤©</span>`;
    return `<div class="card"><div class="cn">${n.name}</div><div class="cr">${n.gender}Â·${n.realm}Â·${n.role||'æ•£ä¿®'}</div><div class="cd">${n.personality||''}</div><div class="ctags">${tags}</div><div style="margin-top:6px"><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim)"><span>å¥½æ„Ÿ</span><span>${rel.love}/100</span></div><div class="rel-bar"><div class="rel-fill" style="width:${rel.love}%"></div></div></div><div class="cbtns"><button onclick="viewStatus('${n.id}')">ğŸ”®</button><button onclick="enhancedCheck('${n.id}')">ğŸ‘€</button><button onclick="openNpcModal('${n.id}')">âœï¸</button><button onclick="startChat('${n.id}')">ğŸ’¬</button><button class="bdel" onclick="deleteNpc('${n.id}')">ğŸ—‘ï¸</button></div></div>`}).join('')}

function updateSelects(){
  const opts=state.npcs.map(n=>`<option value="${n.id}">${n.name}ï¼ˆ${n.realm}ï¼‰</option>`).join('');
  ['chatSelect','msgSelect','dualSelect','realmCompanion','tribCompanion'].forEach(id=>{
    const s=document.getElementById(id);if(!s)return;const v=s.value;
    const def=id==='realmCompanion'?'ç‹¬è‡ªå‰å¾€':id==='tribCompanion'?'æ— äººæŠ¤æ³•':'é€‰æ‹©å¯¹è±¡';
    s.innerHTML=`<option value="">${def}</option>`+opts;
    if(v&&state.npcs.find(n=>n.id===v))s.value=v;
  });
}

function updateRelCards(){
  const c=document.getElementById('relCards'),e=document.getElementById('relEmpty'),entries=state.npcs.filter(n=>state.relations[n.id]);
  if(!entries.length){c.innerHTML='';e.style.display='block';return}e.style.display='none';
  c.innerHTML=entries.map(n=>{const r=state.relations[n.id],preg=state.pregnancies[n.id];let st=r.type;if(preg?.active)st+=`Â·æœ‰å–œ${preg.days}å¤©`;
    return `<div class="card"><div class="cn">${n.name}</div><div class="cr">${st}</div><div style="margin-top:8px"><div style="display:flex;justify-content:space-between;font-size:10px;color:var(--dim)"><span>â¤ï¸</span><span>${r.love}/100</span></div><div class="rel-bar"><div class="rel-fill" style="width:${r.love}%"></div></div></div>${preg?.active?`<div style="margin-top:6px;font-size:10px;color:var(--green)">ğŸŒ±${preg.stage} ç¬¬${preg.days}å¤©</div>`:''}<div class="cbtns" style="margin-top:8px"><button onclick="startChat('${n.id}')">ğŸ’¬</button><button onclick="viewStatus('${n.id}')">ğŸ”®</button><button onclick="enhancedCheck('${n.id}')">ğŸ‘€</button></div></div>`}).join('')}

function updateEvents(){
  const el=document.getElementById('eventLog'),e=document.getElementById('eventEmpty');
  if(!state.events.length){el.innerHTML='';e.style.display='block';return}e.style.display='none';
  el.innerHTML=state.events.slice().reverse().map(ev=>`<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:11px"><span style="color:var(--dim)">${ev.time}</span> <span style="color:var(--gold)">[${ev.type}]</span> ${ev.text}</div>`).join('');
}
function updatePills(){
  const el=document.getElementById('pillList');
  if(!state.pills.length){el.innerHTML='æš‚æ— ';return}
  const c={};state.pills.forEach(p=>{c[p]=(c[p]||0)+1});
  el.innerHTML=Object.entries(c).map(([n,cnt])=>`<button class="abtn cyan" style="margin:2px" onclick="usePill('${n}')">${n}Ã—${cnt}</button>`).join('');
}
function updateRealmBtns(){
  const el=document.getElementById('realmBtns'),ri=REALMS.indexOf(state.player.realm);
  el.innerHTML=REALMS_DB.map(r=>{const ok=ri>=r.level;return `<button ${ok?`onclick="enterRealm('${r.name}')"`:'disabled'} title="${r.desc}">${r.name}${ok?'':'ğŸ”’'}</button>`}).join('');
}
function updateBeastCards(){
  const c=document.getElementById('beastCards'),e=document.getElementById('beastEmpty');
  if(!state.beasts.length){c.innerHTML='';e.style.display='block';return}e.style.display='none';
  c.innerHTML=state.beasts.map((b,i)=>{
    const tc=b.type==='ç¥å…½'?'var(--gold)':b.type==='å¦–å…½'?'var(--danger)':'var(--cyan)';
    const tagCls=b.type==='ç¥å…½'?'tag-o':b.type==='å¦–å…½'?'tag-r':'tag-c';
    return `<div class="card"><div class="cn" style="color:${tc}">${b.name}</div><div class="cr">${b.type} Â· æˆ˜åŠ›${b.power} Â· å¿ è¯š${b.loyalty}/100</div><div class="ctags"><span class="tag ${tagCls}">${b.type}</span><span class="tag tag-c">${b.tamed?'å·²é©¯æœ':'æœªé©¯æœ'}</span></div><div class="cbtns"><button onclick="trainBeast(${i})">ğŸ¯è®­ç»ƒ</button><button onclick="feedBeast(${i})">ğŸ’Šå–‚ä¸¹</button><button class="bdel" onclick="releaseBeast(${i})">æ”¾ç”Ÿ</button></div></div>`}).join('');
}

function addEvent(t,x){state.events.push({type:t,text:x,time:new Date().toLocaleString('zh-CN')});if(state.events.length>200)state.events.shift();save();updateEvents()}
function refreshAll(){updatePlayerUI();updateNpcCards();updateSelects();updateRelCards();updateEvents();updatePills();updateRealmBtns();updateBeastCards()}

// ========== NPCç®¡ç† ==========
function openNpcModal(id){
  document.getElementById('npcModal').classList.add('show');
  if(id){
    const n=state.npcs.find(x=>x.id===id);if(!n)return;
    document.getElementById('npcModalTitle').textContent='âœï¸ç¼–è¾‘è§’è‰²';
    document.getElementById('editNpcId').value=id;
    document.getElementById('npcName').value=n.name;
    document.getElementById('npcGender').value=n.gender;
    document.getElementById('npcRealm').value=n.realm;
    document.getElementById('npcRole').value=n.role||'';
    document.getElementById('npcPersonality').value=n.personality||'';
    document.getElementById('npcRelType').value=state.relations[id]?.type||'é™Œç”Ÿäºº';
    document.getElementById('npcRelMode').value=n.relMode||'å¯æ”»ç•¥';
    document.getElementById('npcTags').value=(n.tags||[]).join(',');
    document.getElementById('npcSysPrompt').value=n.sysPrompt||'';
  }else{
    document.getElementById('npcModalTitle').textContent='âœ¨æ–°å»ºè§’è‰²';
    document.getElementById('editNpcId').value='';
    ['npcName','npcRole','npcPersonality','npcTags','npcSysPrompt'].forEach(x=>document.getElementById(x).value='');
    document.getElementById('npcGender').value='ç”·';
    document.getElementById('npcRealm').value='é‡‘ä¸¹æœŸ';
    document.getElementById('npcRelType').value='é™Œç”Ÿäºº';
    document.getElementById('npcRelMode').value='å¯æ”»ç•¥';
  }
}
function closeNpcModal(){document.getElementById('npcModal').classList.remove('show')}

function saveNpc(){
  const name=document.getElementById('npcName').value.trim();if(!name)return alert('è¾“å…¥åå­—');
  const eid=document.getElementById('editNpcId').value;
  const d={
    id:eid||'npc_'+Date.now(),name,
    gender:document.getElementById('npcGender').value,
    realm:document.getElementById('npcRealm').value,
    role:document.getElementById('npcRole').value.trim(),
    personality:document.getElementById('npcPersonality').value.trim(),
    relMode:document.getElementById('npcRelMode').value,
    tags:document.getElementById('npcTags').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean),
    sysPrompt:document.getElementById('npcSysPrompt').value.trim()
  };
  const rt=document.getElementById('npcRelType').value;
  if(eid){const i=state.npcs.findIndex(n=>n.id===eid);if(i>=0)state.npcs[i]={...state.npcs[i],...d}}
  else{state.npcs.push(d);state.relations[d.id]={type:rt,love:rt==='é“ä¾£'?80:rt==='æš§æ˜§'?50:rt==='é’æ¢…ç«¹é©¬'?60:10};addEvent('è§’è‰²',`${name}å‡ºç°äº†`)}
  if(!state.relations[d.id])state.relations[d.id]={type:rt,love:10};
  else state.relations[d.id].type=rt;
  save();closeNpcModal();refreshAll();
}

function deleteNpc(id){
  const n=state.npcs.find(x=>x.id===id);
  if(!n||!confirm(`ç¡®å®šåˆ é™¤ã€Œ${n.name}ã€ï¼Ÿ\nèŠå¤©è®°å½•ä¹Ÿä¼šä¸€èµ·åˆ é™¤å“¦`))return;
  state.npcs=state.npcs.filter(x=>x.id!==id);
  delete state.relations[id];delete state.chatHistories[id];
  delete state.msgHistories[id];delete state.pregnancies[id];
  if(currentChatId===id){currentChatId=null;loadChat()}
  if(currentMsgId===id){currentMsgId=null;loadMsgChat()}
  save();refreshAll();addEvent('è§’è‰²',`${n.name}ç¦»å¼€äº†`);
  showToast(`${n.name}å·²åˆ é™¤`);
}

// ========== AIç”ŸæˆNPC ==========
async function aiGenerateNpc(){
  if(!state.api.url||!state.api.key)return alert('è¯·å…ˆåœ¨è®¾ç½®é‡Œé…ç½®API');
  document.getElementById('aiGenModal').classList.add('show');
  document.getElementById('aiGenResult').style.display='none';
  document.getElementById('aiGenActions').style.display='none';
  document.getElementById('aiGenHint').value='';
  aiGenTemp=null;
}

async function doAiGenerate(){
  const hint=document.getElementById('aiGenHint').value.trim();
  const btn=document.getElementById('aiGenBtn');
  const resEl=document.getElementById('aiGenResult');
  const actEl=document.getElementById('aiGenActions');
  btn.disabled=true;btn.textContent='ğŸ² ç”Ÿæˆä¸­â€¦';
  resEl.style.display='block';resEl.innerHTML='<span style="color:var(--dim)">AIæ­£åœ¨æ„æ€è§’è‰²â€¦</span>';
  actEl.style.display='none';

  const prompt=`ä½ æ˜¯ä¿®ä»™ä¸–ç•Œè§’è‰²ç”Ÿæˆå™¨ã€‚è¯·ç”Ÿæˆä¸€ä¸ªä¿®ä»™ä¸–ç•ŒNPCè§’è‰²ã€‚${hint?'ç”¨æˆ·è¦æ±‚ï¼š'+hint:'éšæœºç”Ÿæˆä¸€ä¸ªæœ‰è¶£çš„è§’è‰²ã€‚'}
è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼š
{"name":"è§’è‰²å","gender":"ç”·æˆ–å¥³","realm":"å¢ƒç•Œï¼ˆç»ƒæ°”æœŸ/ç­‘åŸºæœŸ/é‡‘ä¸¹æœŸ/å…ƒå©´æœŸ/åŒ–ç¥æœŸ/åˆä½“æœŸ/å¤§ä¹˜æœŸ/æ¸¡åŠ«æœŸ/ä»™äººä¹‹ä¸€ï¼‰","role":"èº«ä»½ï¼ˆå¦‚å‰‘ä¿®ã€ä¸¹å¸ˆã€é­”é“å°‘ä¸»ç­‰ï¼‰","personality":"è¯¦ç»†çš„æ€§æ ¼ä¸å¤–è²Œæè¿°ï¼ˆ100-200å­—ï¼Œè¦æœ‰ç‰¹è‰²ï¼‰","tags":["æ ‡ç­¾1","æ ‡ç­¾2","æ ‡ç­¾3"],"relType":"åˆå§‹å…³ç³»ï¼ˆé™Œç”Ÿäºº/åŒé—¨/é’æ¢…ç«¹é©¬/å®¿æ•Œ/æš§æ˜§ä¹‹ä¸€ï¼‰","sysPrompt":"ç»™AIçš„é¢å¤–æ‰®æ¼”æŒ‡ä»¤ï¼ˆå¯é€‰ï¼Œè®©è§’è‰²æ›´æœ‰ç‰¹è‰²ï¼‰"}
è¦æ±‚ï¼šè§’è‰²è¦æœ‰é²œæ˜ä¸ªæ€§ï¼Œä¸è¦å¤ªå¥—è·¯ã€‚`;

  try{
    const r=await fetch(getApiUrl(),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},
      body:JSON.stringify({model:state.api.model,messages:[{role:'user',content:prompt}],max_tokens:800,temperature:1.0})});
    if(!r.ok)throw new Error(r.status+' '+r.statusText);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'';
    // æå–JSON
    const jsonMatch=reply.match(/\{[\s\S]*\}/);
    if(!jsonMatch)throw new Error('AIè¿”å›æ ¼å¼å¼‚å¸¸');
    const npcData=JSON.parse(jsonMatch[0]);
    aiGenTemp=npcData;
    resEl.innerHTML=`<div style="padding:10px;background:rgba(160,112,224,.08);border:1px solid rgba(160,112,224,.15);border-radius:8px">
      <div style="font-size:14px;font-weight:bold;color:var(--cyan)">${npcData.name}</div>
      <div style="font-size:10px;color:var(--gold);margin-top:2px">${npcData.gender}Â·${npcData.realm}Â·${npcData.role||'æ•£ä¿®'}</div>
      <div style="font-size:11px;margin-top:6px;line-height:1.6">${npcData.personality||''}</div>
      <div style="margin-top:6px">${(npcData.tags||[]).map(t=>'<span class="tag tag-p">'+t+'</span>').join(' ')}</div>
      <div style="font-size:10px;color:var(--dim);margin-top:4px">å…³ç³»ï¼š${npcData.relType||'é™Œç”Ÿäºº'}</div>
    </div>`;
    actEl.style.display='block';
  }catch(e){
    resEl.innerHTML=`<span style="color:var(--danger)">ç”Ÿæˆå¤±è´¥ï¼š${e.message}</span>`;
  }
  btn.disabled=false;btn.textContent='ğŸ² ç”Ÿæˆ';
}

function acceptAiNpc(){
  if(!aiGenTemp)return;
  const d=aiGenTemp,id='npc_'+Date.now();
  const npc={id,name:d.name,gender:d.gender||'ç”·',realm:d.realm||'é‡‘ä¸¹æœŸ',role:d.role||'',personality:d.personality||'',relMode:'å¯æ”»ç•¥',tags:d.tags||[],sysPrompt:d.sysPrompt||''};
  const rt=d.relType||'é™Œç”Ÿäºº';
  state.npcs.push(npc);
  state.relations[id]={type:rt,love:rt==='é“ä¾£'?80:rt==='æš§æ˜§'?50:rt==='é’æ¢…ç«¹é©¬'?60:10};
  addEvent('è§’è‰²',`${npc.name}å‡ºç°äº†ï¼ˆAIç”Ÿæˆï¼‰`);
  save();refreshAll();
  document.getElementById('aiGenModal').classList.remove('show');
  showToast(`âœ¨ ${npc.name}åŠ å…¥äº†ä½ çš„ä¸–ç•Œï¼`);
  screenFlash('var(--purple)',`${npc.name} é™ä¸´ï¼`);
  aiGenTemp=null;
}

function editAiNpc(){
  if(!aiGenTemp)return;
  document.getElementById('aiGenModal').classList.remove('show');
  openNpcModal();
  const d=aiGenTemp;
  document.getElementById('npcName').value=d.name||'';
  document.getElementById('npcGender').value=d.gender||'ç”·';
  document.getElementById('npcRealm').value=d.realm||'é‡‘ä¸¹æœŸ';
  document.getElementById('npcRole').value=d.role||'';
  document.getElementById('npcPersonality').value=d.personality||'';
  document.getElementById('npcRelType').value=d.relType||'é™Œç”Ÿäºº';
  document.getElementById('npcTags').value=(d.tags||[]).join(',');
  document.getElementById('npcSysPrompt').value=d.sysPrompt||'';
  aiGenTemp=null;
}

// ========== AIè°ƒç”¨ ==========
let currentChatId=null,currentMsgId=null;
function startChat(id){currentChatId=id;document.getElementById('chatSelect').value=id;switchPage('interact');loadChat()}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*(.*?)\*/g,'<em style="color:var(--pink)">$1</em>').replace(/ã€(.*?)ã€‘/g,'<span style="color:var(--gold);font-size:10px">ã€$1ã€‘</span>')}

function loadChat(){
  const box=document.getElementById('msgBox'),npc=state.npcs.find(n=>n.id===currentChatId),info=document.getElementById('chatInfo');
  if(!npc){info.textContent='';box.innerHTML='<div class="msg sys">é€‰æ‹©NPCå¼€å§‹å¯¹è¯</div>';return}
  const rel=state.relations[npc.id]||{};info.textContent=`${npc.realm}Â·${rel.type||'?'}Â·â¤ï¸${rel.love||0}`;
  const h=state.chatHistories[currentChatId]||[];
  box.innerHTML=h.length?h.filter(m=>m.role!=='system').map(m=>`<div class="msg ${m.role==='user'?'user':'ai'}"><div class="ms">${m.role==='user'?state.player.name:npc.name}</div>${esc(m.content)}</div>`).join(''):`<div class="msg sys">ä¸ã€Œ${npc.name}ã€çš„æ•…äº‹å¼€å§‹â€¦</div>`;
  box.scrollTop=box.scrollHeight;
}

function loadMsgChat(){
  const box=document.getElementById('msgMsgBox'),npc=state.npcs.find(n=>n.id===currentMsgId),info=document.getElementById('msgInfo');
  if(!npc){info.textContent='è¿œç¨‹ä¼ è®¯';box.innerHTML='<div class="msg sys">ğŸ“¨é€‰æ‹©ä¼ è®¯å¯¹è±¡</div>';return}
  info.textContent=`ä¼ è®¯â†’${npc.name}`;
  const h=state.msgHistories[currentMsgId]||[];
  box.innerHTML=h.length?h.filter(m=>m.role!=='system').map(m=>`<div class="msg ${m.role==='user'?'user':'ai msg-remote'}"><div class="ms">${m.role==='user'?state.player.name:npc.name}</div>${esc(m.content)}</div>`).join(''):`<div class="msg sys">ğŸ“¨ä¸ã€Œ${npc.name}ã€ä¼ è®¯â€¦</div>`;
  box.scrollTop=box.scrollHeight;
}

function parseReply(npcId,reply){
  const lm=reply.match(/ã€å¥½æ„Ÿ([+-]\d+)ã€‘/);
  if(lm){const d=parseInt(lm[1]),rel=state.relations[npcId];
    if(rel){
      const old=rel.love;
      rel.love=Math.max(0,Math.min(100,rel.love+d));
      if(d>0)floatNum(`â¤ï¸+${d}`,'var(--pink)',window.innerWidth/2,window.innerHeight*0.3);
      else if(d<0)floatNum(`ğŸ’”${d}`,'var(--danger)',window.innerWidth/2,window.innerHeight*0.3);
      if(rel.love>=90&&rel.type!=='é“ä¾£'){rel.type='é“ä¾£';addEvent('å…³ç³»',`${state.npcs.find(n=>n.id===npcId)?.name}ä¸ä½ ç»“ä¸ºé“ä¾£ï¼`);screenFlash('var(--pink)','ğŸ’• ç»“ä¸ºé“ä¾£ï¼')}
      else if(rel.love>=60&&['é™Œç”Ÿäºº','åŒé—¨','é’æ¢…ç«¹é©¬'].includes(rel.type))rel.type='æš§æ˜§';
    }
  }
  if(reply.includes('ã€èµ¶æ¥ã€‘'))addEvent('äº‹ä»¶',`${state.npcs.find(n=>n.id===npcId)?.name}æ­£èµ¶æ¥ï¼`);
}

async function callAI(npc,history,mode,box,onDone){
  if(!state.api.url||!state.api.key)return alert('è¯·å…ˆé…ç½®API');
  const msgs=[{role:'system',content:buildSys(npc,mode)},...history.slice(-20)];
  const ld=document.createElement('div');
  ld.className='msg ai'+(mode==='remote'?' msg-remote':'');
  ld.innerHTML=`<div class="ms">${npc.name}</div><span style="color:var(--dim)">å›åº”ä¸­â€¦</span>`;
  box.appendChild(ld);box.scrollTop=box.scrollHeight;
  try{
    const r=await fetch(getApiUrl(),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},
      body:JSON.stringify({model:state.api.model,messages:msgs,max_tokens:parseInt(state.api.maxTokens)||2048,temperature:.85})});
    if(!r.ok)throw new Error(r.status+' '+r.statusText);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'ï¼ˆæ— å›åº”ï¼‰';
    ld.innerHTML=`<div class="ms">${npc.name}</div>${esc(reply)}`;
    parseReply(npc.id,reply);if(onDone)onDone(reply);save();
  }catch(e){ld.innerHTML=`<div class="ms">ç³»ç»Ÿ</div><span style="color:var(--danger)">å¤±è´¥ï¼š${e.message}</span>`}
  box.scrollTop=box.scrollHeight;refreshAll();
}

async function callAIModal(npc,mode,el){
  if(!state.api.url||!state.api.key)return alert('è¯·å…ˆé…ç½®API');
  el.innerHTML='<span style="color:var(--dim)">AIæ€è€ƒä¸­â€¦</span>';
  const prompt=mode==='status'?'æè¿°ä½ æ­¤åˆ»çš„çŠ¶æ€å’Œå†…å¿ƒã€‚':mode==='npc-check'?`*${npc.name}çªç„¶æŸ¥å²—*`:`*${state.player.name}æ¥æŸ¥å²—*`;
  const msgs=[{role:'system',content:buildSys(npc,mode)},{role:'user',content:prompt}];
  try{
    const r=await fetch(getApiUrl(),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},
      body:JSON.stringify({model:state.api.model,messages:msgs,max_tokens:parseInt(state.api.maxTokens)||2048,temperature:.85})});
    if(!r.ok)throw new Error(r.status);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'ï¼ˆæ— å›åº”ï¼‰';
    el.innerHTML=esc(reply);parseReply(npc.id,reply);save();refreshAll();
  }catch(e){el.innerHTML=`<span style="color:var(--danger)">å¤±è´¥ï¼š${e.message}</span>`}
}

// ========== å‘é€ï¼ˆä¿®å¤bugï¼šsendingé”ï¼‰ ==========
async function sendChat(text){
  if(!currentChatId)return alert('é€‰æ‹©NPC');
  if(sending)return; // é˜²é‡å¤
  const npc=state.npcs.find(n=>n.id===currentChatId);if(!npc)return;
  sending=true;
  const box=document.getElementById('msgBox');
  const btn=document.getElementById('sendBtn');
  btn.disabled=true;
  if(!state.chatHistories[currentChatId])state.chatHistories[currentChatId]=[];
  state.chatHistories[currentChatId].push({role:'user',content:text});
  box.innerHTML+=`<div class="msg user"><div class="ms">${state.player.name}</div>${esc(text)}</div>`;
  box.scrollTop=box.scrollHeight;
  state.lastTalkTo=currentChatId;save();
  await callAI(npc,state.chatHistories[currentChatId],'face',box,reply=>{
    state.chatHistories[currentChatId].push({role:'assistant',content:reply});
  });
  btn.disabled=false;
  sending=false;
  maybeJealousy();
}

async function sendRemote(text){
  if(!currentMsgId)return alert('é€‰æ‹©ä¼ è®¯å¯¹è±¡');
  if(sending)return;
  const npc=state.npcs.find(n=>n.id===currentMsgId);if(!npc)return;
  sending=true;
  const box=document.getElementById('msgMsgBox');
  const btn=document.getElementById('msgSendBtn');
  btn.disabled=true;
  if(!state.msgHistories[currentMsgId])state.msgHistories[currentMsgId]=[];
  state.msgHistories[currentMsgId].push({role:'user',content:text});
  box.innerHTML+=`<div class="msg user"><div class="ms">${state.player.name}</div>${esc(text)}</div>`;
  box.scrollTop=box.scrollHeight;
  await callAI(npc,state.msgHistories[currentMsgId],'remote',box,reply=>{
    state.msgHistories[currentMsgId].push({role:'assistant',content:reply});
  });
  btn.disabled=false;
  sending=false;
}

// ========== å†…å¿ƒ/æŸ¥å²— ==========
async function viewStatus(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  document.getElementById('statusNpcName').textContent=npc.name;
  const el=document.getElementById('statusContent');
  const rel=state.relations[id]||{type:'?',love:0},preg=state.pregnancies[id];
  let base=`<div style="margin-bottom:10px;padding:8px;background:rgba(92,224,216,.05);border-radius:8px;font-size:11px">â¤ï¸ å¥½æ„Ÿï¼š<b style="color:var(--pink)">${rel.love}/100</b>ï¼ˆ${rel.type}ï¼‰`;
  if(preg?.active)base+=`<br>ğŸŒ± ${preg.stage} ç¬¬${preg.days}å¤©`;
  base+=`</div><div id="statusAIContent">åŠ è½½ä¸­â€¦</div>`;
  el.innerHTML=base;document.getElementById('statusModal').classList.add('show');
  await callAIModal(npc,'status',document.getElementById('statusAIContent'));
}

function maybeJealousy(){
  const jealous=state.npcs.filter(n=>n.id!==currentChatId&&state.relations[n.id]&&state.relations[n.id].love>=50&&['æš§æ˜§','é“ä¾£'].includes(state.relations[n.id].type));
  jealous.forEach(n=>{if(Math.random()<(state.relations[n.id].love>=80?.25:.1))setTimeout(()=>npcCheckUser(n.id),2000+Math.random()*3000)});
}

async function npcCheckUser(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  const tt=state.npcs.find(n=>n.id===currentChatId);
  addEvent('æŸ¥å²—',`${npc.name}åƒé†‹æŸ¥å²—ï¼${tt?'å‘ç°ä½ å’Œ'+tt.name+'èŠå¤©':''}`);
  showToast(`ğŸ˜¤ ${npc.name}åƒé†‹äº†ï¼`,()=>{document.getElementById('checkModal').classList.add('show')});
  document.getElementById('checkTitle').textContent=`ğŸ˜¤ ${npc.name}æŸ¥å²—ï¼`;
  const el=document.getElementById('checkContent');el.innerHTML='åŠ è½½ä¸­â€¦';
  document.getElementById('checkModal').classList.add('show');
  await callAIModal(npc,'npc-check',el);
}

// ========== NPCè‡ªä¸»è¡Œä¸º ==========
function npcAutonomyTick(){
  state.npcs.forEach(npc=>{
    const rel=state.relations[npc.id];if(!rel)return;
    // é«˜å¥½æ„ŸNPCä¸»åŠ¨ä¼ è®¯
    if(rel.love>=50&&Math.random()<0.6){
      const msgs=[
        `${state.player.name}ï¼Œä»Šæ—¥å¯æœ‰ç©ºé—²ï¼Ÿ`,
        `æ–¹æ‰ä¿®ç‚¼æ—¶æƒ³èµ·ä½ äº†â€¦`,
        `æˆ‘ç‚¼äº†äº›ä¸¹è¯ï¼Œè¦ä¸è¦æ¥å–ï¼Ÿ`,
        rel.love>=80?`æƒ³ä½ äº†â€¦ä»€ä¹ˆæ—¶å€™æ¥çœ‹æˆ‘ï¼Ÿ`:`è¿‘æ¥å¯å¥½ï¼Ÿ`,
        `ä»Šæ—¥å¤©æ°”ç”šå¥½ï¼Œè¦ä¸è¦ä¸€èµ·å‡ºå»èµ°èµ°ï¼Ÿ`,
        `æˆ‘å‘ç°äº†ä¸€å¤„çµæ³‰ï¼Œè¦ä¸€èµ·å»çœ‹çœ‹å—ï¼Ÿ`
      ];
      const msg=msgs[Math.floor(Math.random()*msgs.length)];
      if(!state.msgHistories[npc.id])state.msgHistories[npc.id]=[];
      state.msgHistories[npc.id].push({role:'assistant',content:msg});
      showToast(`ğŸ“¨ ${npc.name}ï¼š${msg.slice(0,20)}â€¦`,()=>{currentMsgId=npc.id;document.getElementById('msgSelect').value=npc.id;switchPage('interact');loadMsgChat()});
      document.getElementById('notifChat').style.display='block';
      addEvent('ä¼ è®¯',`${npc.name}ä¸»åŠ¨ä¼ è®¯`);save();
    }
    // NPCä¹‹é—´äº‰é£åƒé†‹
    if(state.npcs.length>=2&&Math.random()<0.04){
      const others=state.npcs.filter(n=>n.id!==npc.id&&(state.relations[n.id]?.love||0)>=50);
      if(others.length&&rel.love>=60){
        const target=others[Math.floor(Math.random()*others.length)];
        addEvent('ä¿®ç½—åœº',`${npc.name}å’Œ${target.name}å› ä½ èµ·äº†äº‰æ‰§ï¼`);
        rel.love=Math.max(0,rel.love-2);
        state.relations[target.id].love=Math.max(0,state.relations[target.id].love-2);
        showToast(`âš¡ ${npc.name}å’Œ${target.name}åµèµ·æ¥äº†ï¼`);
        save();refreshAll();
      }
    }
  });
}

// ========== éšæœºäº‹ä»¶ç³»ç»Ÿ ==========
function triggerRandomEvent(){
  if(document.getElementById('eventModal').classList.contains('show'))return;
  // NPCæ¥è®¿äº‹ä»¶
  if(Math.random()<0.3){
    const candidates=state.npcs.filter(n=>(state.relations[n.id]?.love||0)>=30);
    if(candidates.length){
      const npc=candidates[Math.floor(Math.random()*candidates.length)];
      const rel=state.relations[npc.id];
      showEventModal({
        title:`ğŸ’• ${npc.name}æ¥äº†`,
        desc:`${npc.name}çªç„¶å‡ºç°åœ¨ä½ é¢å‰ï¼Œ${rel.love>=70?'è„¸é¢Šå¾®çº¢ï¼Œä¼¼ä¹æœ‰è¯æƒ³è¯´':'ç¥è‰²æ·¡ç„¶åœ°çœ‹ç€ä½ '}ã€‚`,
        choices:[
          {text:'ğŸ¤— æ‹¥å…¥æ€€ä¸­',action:()=>{rel.love=Math.min(100,rel.love+5);save();refreshAll();floatNum('â¤ï¸+5','var(--pink)',window.innerWidth/2,window.innerHeight*0.3);startChat(npc.id)}},
          {text:'ğŸ’¬ èŠèŠå¤©',action:()=>startChat(npc.id)},
          {text:'ğŸ™„ ç°åœ¨æœ‰ç‚¹å¿™â€¦',action:()=>{rel.love=Math.max(0,rel.love-3);save();refreshAll();floatNum('ğŸ’”-3','var(--danger)',window.innerWidth/2,window.innerHeight*0.3)}}
        ]
      });return;
    }
  }
  // æ™®é€šéšæœºäº‹ä»¶
  const evt=RANDOM_EVENTS[Math.floor(Math.random()*RANDOM_EVENTS.length)];
  showEventModal(evt);
}

function showEventModal(evt){
  const modal=document.getElementById('eventModal');
  const content=document.getElementById('eventModalContent');
  document.getElementById('eventModalTitle').textContent=evt.title;
  let html=`<p style="font-size:12px;color:var(--text);margin-bottom:14px;line-height:1.6">${evt.desc}</p>`;
  if(evt.choices[0]?.action){
    // ç®€å•é€‰é¡¹ï¼ˆNPCæ¥è®¿ç­‰ï¼‰
    html+=evt.choices.map(c=>`<button class="event-choice" onclick="this.parentNode.querySelectorAll('button').forEach(b=>b.disabled=true);(${c.action.toString()})();setTimeout(()=>document.getElementById('eventModal').classList.remove('show'),500)">${c.text}</button>`).join('');
  }else{
    // å¸¦æ¦‚ç‡çš„é€‰é¡¹
    html+=evt.choices.map((c,i)=>`<button class="event-choice" onclick="resolveRandomEvent(${i})">
      ${c.text}
      ${c.cost?`<div class="ec-cost">${Object.entries(c.cost).map(([k,v])=>k+(v>0?'+':'')+v).join(' ')}</div>`:''}
    </button>`).join('');
  }
  html+='<div id="eventResult" style="margin-top:12px;display:none"></div>';
  content.innerHTML=html;
  modal.classList.add('show');
  modal._evt=evt;
}

function resolveRandomEvent(idx){
  const modal=document.getElementById('eventModal');
  const evt=modal._evt;if(!evt)return;
  const c=evt.choices[idx];
  const resEl=document.getElementById('eventResult');
  resEl.style.display='block';
  // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
  modal.querySelectorAll('.event-choice').forEach(b=>b.disabled=true);
  // æ‰£è´¹
  const p=state.player;
  if(c.cost){Object.entries(c.cost).forEach(([k,v])=>{if(k==='hp')p.hp=Math.max(1,p.hp+v);if(k==='mp')p.mp=Math.max(0,p.mp+v)})}
  // åˆ¤å®š
  const success=Math.random()<(c.chance||0.5);
  if(success&&c.reward){
    let txt='âœ¨ æˆåŠŸï¼';
    if(c.reward.exp){p.exp+=c.reward.exp;txt+=` +${c.reward.exp}ä¿®ä¸º`}
    if(c.reward.mp){p.mp=Math.min(p.maxMp,p.mp+c.reward.mp);txt+=` +${c.reward.mp}çµåŠ›`}
    if(c.reward.pill){state.pills.push(c.reward.pill);txt+=` è·å¾—${c.reward.pill}`}
    if(c.reward.love){
      const loving=state.npcs.filter(n=>(state.relations[n.id]?.love||0)>=30);
      if(loving.length){const ln=loving[Math.floor(Math.random()*loving.length)];state.relations[ln.id].love=Math.min(100,state.relations[ln.id].love+c.reward.love);txt+=` ${ln.name}å¥½æ„Ÿ+${c.reward.love}`}
    }
    if(c.reward.beast){
      const td=BEAST_TYPES[0];const bn=td.names[Math.floor(Math.random()*td.names.length)];
      const pw=td.power[0]+Math.floor(Math.random()*(td.power[1]-td.power[0]));
      state.beasts.push({name:bn,type:td.type,power:pw,loyalty:50,tamed:true});
      txt+=` è·å¾—çµå…½ã€Œ${bn}ã€ï¼`;
    }
    resEl.innerHTML=`<div style="color:var(--green)">${txt}</div>`;
    addEvent('å¥‡é‡',txt);
    screenFlash('var(--green)','');
    checkBreakthrough(resEl);
  }else if(!success&&c.failCost){
    let txt='ğŸ’¥ å¤±è´¥â€¦';
    Object.entries(c.failCost).forEach(([k,v])=>{
      if(k==='hp'){p.hp=Math.max(1,p.hp+v);txt+=` ${v}æ°”è¡€`}
      if(k==='mp'){p.mp=Math.max(0,p.mp+v);txt+=` ${v}çµåŠ›`}
      if(k==='exp'){p.exp=Math.max(0,p.exp+v);txt+=` ${v}ä¿®ä¸º`}
    });
    resEl.innerHTML=`<div style="color:var(--danger)">${txt}</div>`;
    addEvent('äº‹ä»¶',txt);
  }else if(!success){
    resEl.innerHTML=`<div style="color:var(--dim)">æ²¡ä»€ä¹ˆç‰¹åˆ«çš„äº‹å‘ç”Ÿã€‚</div>`;
  }else{
    resEl.innerHTML=`<div style="color:var(--dim)">å¹³å®‰æ— äº‹ã€‚</div>`;
  }
  save();refreshAll();
  setTimeout(()=>modal.classList.remove('show'),2000);
}

// ========== çµå…½ ==========
function catchBeast(){
  const p=state.player,ri=REALMS.indexOf(p.realm);
  if(p.mp<15){alert('çµåŠ›ä¸è¶³ï¼ˆéœ€15ï¼‰');return}
  p.mp-=15;
  const resEl=document.getElementById('beastResult');resEl.style.display='block';
  const roll=Math.random();
  let typeData;
  if(roll<0.15&&ri>=4)typeData=BEAST_TYPES[2];
  else if(roll<0.45&&ri>=2)typeData=BEAST_TYPES[1];
  else typeData=BEAST_TYPES[0];
  const bname=typeData.names[Math.floor(Math.random()*typeData.names.length)];
  const power=typeData.power[0]+Math.floor(Math.random()*(typeData.power[1]-typeData.power[0]));
  const tameChance=typeData.tame+ri*0.05;
  if(Math.random()<tameChance){
    const beast={name:bname,type:typeData.type,power,loyalty:typeData.type==='ç¥å…½'?60:typeData.type==='å¦–å…½'?20:50,tamed:typeData.type!=='å¦–å…½'};
    state.beasts.push(beast);
    resEl.innerHTML=`ğŸ‰ æ•è·æˆåŠŸï¼<b style="color:${typeData.color}">${bname}</b>ï¼ˆ${typeData.type}ï¼‰æˆ˜åŠ›${power}`;
    addEvent('çµå…½',`æ•è·äº†${typeData.type}ã€Œ${bname}ã€ï¼`);
    screenFlash(typeData.color,`${bname} æ”¶æœï¼`);
  }else{
    resEl.innerHTML=`ğŸ˜¢ ${typeData.type}ã€Œ${bname}ã€é€ƒè·‘äº†â€¦${typeData.type==='å¦–å…½'?'è¿˜è¢«å’¬äº†ä¸€å£ï¼':''}`;
    if(typeData.type==='å¦–å…½'){p.hp=Math.max(1,p.hp-15);resEl.innerHTML+=' (-15æ°”è¡€)'}
  }
  save();refreshAll();
}

function trainBeast(i){
  const b=state.beasts[i];if(!b)return;
  const p=state.player;if(p.mp<10){alert('çµåŠ›ä¸è¶³');return}
  p.mp-=10;
  if(b.type==='å¦–å…½'&&!b.tamed){
    if(Math.random()<0.3){b.tamed=true;b.loyalty=30;addEvent('çµå…½',`å¦–å…½ã€Œ${b.name}ã€è¢«é©¯æœäº†ï¼`);showToast(`${b.name}è¢«é©¯æœäº†ï¼`);screenFlash('var(--orange)','')}
    else{p.hp=Math.max(1,p.hp-10);showToast(`${b.name}æš´èºåæŠ—ï¼-10æ°”è¡€`)}
  }else{
    const gain=Math.floor(Math.random()*5)+1;
    b.power+=gain;b.loyalty=Math.min(100,b.loyalty+5);
    showToast(`${b.name}è®­ç»ƒå®Œæˆï¼æˆ˜åŠ›+${gain} å¿ è¯š+5`);
  }
  save();refreshAll();
}

function feedBeast(i){
  const b=state.beasts[i];if(!b)return;
  if(!state.pills.length){alert('æ²¡æœ‰ä¸¹è¯');return}
  const pill=state.pills.shift();
  b.power+=10;b.loyalty=Math.min(100,b.loyalty+10);
  showToast(`ç»™${b.name}å–‚äº†${pill}ï¼Œæˆ˜åŠ›+10 å¿ è¯š+10`);
  save();refreshAll();updatePills();
}

function releaseBeast(i){
  const b=state.beasts[i];if(!b||!confirm(`æ”¾ç”Ÿã€Œ${b.name}ã€ï¼Ÿ`))return;
  state.beasts.splice(i,1);addEvent('çµå…½',`æ”¾ç”Ÿäº†${b.name}`);save();refreshAll();
}

// ========== ä¿®ç‚¼ ==========
function doCult(type){
  const p=state.player,ri=REALMS.indexOf(p.realm);
  let resEl=document.getElementById('res-'+type);
  if(!resEl)return;resEl.style.display='block';

  if(type==='meditate'){
    if(p.mp<10){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€10ï¼‰';return}
    p.mp-=10;const gain=10+ri*5+Math.floor(Math.random()*20);p.exp+=gain;
    resEl.textContent=`ğŸ§˜ æ¶ˆè€—10çµåŠ›ï¼Œè·å¾—${gain}ä¿®ä¸º`;
    floatNum(`+${gain}ä¿®ä¸º`,'var(--gold)',window.innerWidth/2,window.innerHeight*0.4);
    checkBreakthrough(resEl);addEvent('ä¿®ç‚¼','è·å¾—'+gain+'ä¿®ä¸º');
  }
  else if(type==='alchemy'){
    if(p.mp<15){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€15ï¼‰';return}
    p.mp-=15;const pill=PILLS_DB[Math.floor(Math.random()*PILLS_DB.length)];
    if(Math.random()<(pill.rate+ri*0.05)){
      state.pills.push(pill.name);
      resEl.textContent=`âš—ï¸ æˆåŠŸï¼è·å¾—ã€Œ${pill.name}ã€`;
      addEvent('ç‚¼ä¸¹',`ç‚¼åˆ¶${pill.name}`);
      screenFlash('var(--cyan)','');
    }else{
      resEl.textContent='âš—ï¸ ç‚¼ä¸¹å¤±è´¥ğŸ’¥';addEvent('ç‚¼ä¸¹','å¤±è´¥');
    }
    updatePills();
  }
  else if(type==='dual'){
    const tid=document.getElementById('dualSelect').value;if(!tid){resEl.textContent='é€‰æ‹©å¯¹è±¡';return}
    const npc=state.npcs.find(n=>n.id===tid);if(!npc)return;
    if(p.mp<20){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€20ï¼‰';return}
    p.mp-=20;const rel=state.relations[tid]||{love:0};
    const gain=20+ri*8+Math.floor(rel.love/5);p.exp+=gain;rel.love=Math.min(100,rel.love+5);
    resEl.textContent=`ğŸ’ ä¸${npc.name}åŒä¿®ï¼Œ+${gain}ä¿®ä¸º +5å¥½æ„Ÿ`;
    floatNum(`+${gain}ä¿®ä¸º`,'var(--gold)',window.innerWidth*0.4,window.innerHeight*0.4);
    floatNum('â¤ï¸+5','var(--pink)',window.innerWidth*0.6,window.innerHeight*0.4);
    checkBreakthrough(resEl);addEvent('åŒä¿®',`ä¸${npc.name}åŒä¿®`);
  }
  else if(type==='study'){
    if(p.mp<10){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€10ï¼‰';return}
    p.mp-=10;
    if(Math.random()<.15+ri*.02){
      const gain=30+ri*10;p.exp+=gain;
      resEl.textContent=`ğŸ“– å‚æ‚Ÿæœ‰æˆï¼+${gain}ä¿®ä¸º`;
      addEvent('å‚æ‚Ÿ','æœ‰æˆ');screenFlash('var(--gold)','');
      floatNum(`+${gain}ä¿®ä¸º`,'var(--gold)',window.innerWidth/2,window.innerHeight*0.4);
    }else{resEl.textContent='ğŸ“– æœªèƒ½é¢†æ‚Ÿâ€¦';addEvent('å‚æ‚Ÿ','å¤±è´¥')}
  }
  else if(type==='tribulation'){doTribulation(resEl);return}
  save();refreshAll();
}

function checkBreakthrough(resEl){
  const p=state.player,ri=REALMS.indexOf(p.realm);
  if(p.exp>=p.maxExp){
    p.exp-=p.maxExp;const ni=Math.min(ri+1,REALMS.length-1);
    if(ni>ri){
      p.realm=REALMS[ni];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);
      resEl.textContent+=`\nğŸ‰ çªç ´åˆ°${p.realm}ï¼`;
      addEvent('çªç ´',`çªç ´åˆ°${p.realm}ï¼`);
      screenFlash('var(--gold)',`ğŸ‰ çªç ´ï¼${p.realm}`);
    }
  }
}

// ========== æ¸¡åŠ« ==========
async function doTribulation(resEl){
  const p=state.player,ri=REALMS.indexOf(p.realm);
  if(ri<3){resEl.textContent='é‡‘ä¸¹æœŸä»¥ä¸‹æ— éœ€æ¸¡åŠ«';return}
  if(p.exp<p.maxExp*0.8){resEl.textContent='ä¿®ä¸ºä¸è¶³ï¼ˆéœ€80%ä»¥ä¸Šï¼‰';return}
  if(p.mp<30){resEl.textContent='çµåŠ›ä¸è¶³ï¼ˆéœ€30ï¼‰';return}
  p.mp-=30;
  const compId=document.getElementById('tribCompanion').value;
  const comp=compId?state.npcs.find(n=>n.id===compId):null;
  const rel=comp?state.relations[comp.id]:null;
  const beastHelp=state.beasts.filter(b=>b.tamed&&b.loyalty>=50);
  resEl.innerHTML='';resEl.style.display='block';
  function log(t){resEl.innerHTML+=t+'<br>'}
  log(`âš¡ å¤©åŠ«é™ä¸´ï¼${p.name}å¼€å§‹æ¸¡åŠ«â€¦`);
  screenFlash('var(--purple)','âš¡ å¤©åŠ«é™ä¸´');
  if(comp)log(`ğŸ’• ${comp.name}åœ¨æ—æŠ¤æ³•`);
  if(beastHelp.length)log(`ğŸ¾ ${beastHelp.map(b=>b.name).join('ã€')}å®ˆæŠ¤åœ¨ä¾§`);
  addEvent('æ¸¡åŠ«',`${p.name}å¼€å§‹æ¸¡åŠ«ï¼${comp?comp.name+'æŠ¤æ³•':''}`);
  const thunders=3+Math.floor(ri/2);
  let survived=true,companionBlocked=false;
  for(let i=0;i<thunders;i++){
    await new Promise(r=>setTimeout(r,600));
    const dmg=20+ri*10+Math.floor(Math.random()*30);
    log(`\nâš¡ ç¬¬${i+1}é“å¤©é›·ï¼å¨åŠ›${dmg}`);
    if(comp&&rel&&!companionBlocked){
      const blockChance=rel.love>=80?0.6:rel.love>=60?0.3:0.1;
      if(Math.random()<blockChance){
        companionBlocked=true;
        log(`ğŸ’• <b style="color:var(--pink)">${comp.name}èˆèº«ä¸ºä½ æŒ¡ä¸‹å¤©é›·ï¼</b>`);
        rel.love=Math.min(100,rel.love+15);
        addEvent('æ¸¡åŠ«',`${comp.name}èˆèº«æŒ¡é›·ï¼å¥½æ„Ÿ+15`);
        screenFlash('var(--pink)','');
        continue;
      }
    }
    let beastBlocked=false;
    for(const b of beastHelp){
      if(b.loyalty>=70&&Math.random()<0.3){
        log(`ğŸ¾ ${b.name}å†²å‡ºæŒ¡é›·ï¼`);b.loyalty=Math.max(0,b.loyalty-10);b.power=Math.max(1,b.power-5);beastBlocked=true;break;
      }
    }
    if(beastBlocked)continue;
    p.hp-=dmg;
    log(`ğŸ’¥ æ‰¿å—${dmg}ç‚¹é›·ä¼¤ï¼å‰©ä½™æ°”è¡€${Math.max(0,p.hp)}`);
    if(p.hp<=0){
      survived=false;
      log(`\n<b style="color:var(--danger)">âŒ æ¸¡åŠ«å¤±è´¥ï¼é‡ä¼¤â€¦</b>`);
      p.hp=1;p.exp=0;addEvent('æ¸¡åŠ«','æ¸¡åŠ«å¤±è´¥ï¼');
      screenFlash('var(--danger)','');
      if(comp&&rel){rel.love=Math.min(100,rel.love+5);log(`${comp.name}å°†ä½ æ•‘èµ·â€¦`)}
      break;
    }
  }
  if(survived){
    log(`\n<b style="color:var(--gold)">ğŸ‰ æ¸¡åŠ«æˆåŠŸï¼å¤©åœ°å…±é¸£ï¼</b>`);
    screenFlash('var(--gold)','ğŸ‰ æ¸¡åŠ«æˆåŠŸï¼');
    const ni=Math.min(ri+1,REALMS.length-1);
    if(ni>ri){
      p.realm=REALMS[ni];p.maxHp+=80;p.hp=p.maxHp;p.maxMp+=50;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*2);p.exp=0;
      log(`çªç ´åˆ° <b style="color:var(--gold)">${p.realm}</b>ï¼`);
      addEvent('çªç ´',`æ¸¡åŠ«çªç ´åˆ°${p.realm}ï¼`);
    }
    beastHelp.forEach(b=>{b.power+=5;b.loyalty=Math.min(100,b.loyalty+5)});
  }
  save();refreshAll();
}

function usePill(name){
  const idx=state.pills.indexOf(name);if(idx<0)return;
  const pill=PILLS_DB.find(p=>p.name===name);if(!pill)return;
  state.pills.splice(idx,1);const p=state.player,resEl=document.getElementById('res-pill');resEl.style.display='block';
  if(pill.effect==='hp'){p.hp=Math.min(p.maxHp,p.hp+pill.val);resEl.textContent=`ğŸ’Š ${name}ï¼Œ+${pill.val}æ°”è¡€`;floatNum(`+${pill.val}æ°”è¡€`,'var(--green)',window.innerWidth/2,window.innerHeight*0.4)}
  else if(pill.effect==='mp'){p.mp=Math.min(p.maxMp,p.mp+pill.val);resEl.textContent=`ğŸ’Š ${name}ï¼Œ+${pill.val}çµåŠ›`;floatNum(`+${pill.val}çµåŠ›`,'var(--cyan)',window.innerWidth/2,window.innerHeight*0.4)}
  else if(pill.effect==='exp'){p.exp+=pill.val;resEl.textContent=`ğŸ’Š ${name}ï¼Œ+${pill.val}ä¿®ä¸º`;checkBreakthrough(resEl)}
  else if(pill.effect==='breakthrough'){
    const ri=REALMS.indexOf(p.realm);
    if(Math.random()<.3&&ri<REALMS.length-1){
      p.realm=REALMS[ri+1];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);
      resEl.textContent=`ğŸ’Š çªç ´åˆ°${p.realm}ï¼`;addEvent('çªç ´','ç ´å¢ƒä¸¹çªç ´ï¼');
      screenFlash('var(--gold)',`çªç ´ï¼${p.realm}`);
    }else resEl.textContent='ğŸ’Š æœªèƒ½çªç ´'
  }
  else if(pill.effect==='love'){resEl.textContent='ğŸ’Š åˆæ¬¢æ•£è¯·åœ¨å¯¹è¯ä¸­å–‚ä¸¹ä½¿ç”¨';state.pills.push(name)}
  save();refreshAll();updatePills();
}

// ========== ç§˜å¢ƒï¼ˆå¸¦æˆ˜æ–—é€‰æ‹©ï¼‰ ==========
async function enterRealm(name){
  const realm=REALMS_DB.find(r=>r.name===name);if(!realm)return;
  const compId=document.getElementById('realmCompanion').value;
  const comp=compId?state.npcs.find(n=>n.id===compId):null;
  if(name==='åŒä¿®ç§˜å¢ƒ'&&!comp){alert('é¡»æºä¼´ä¾£ï¼');return}
  const log=document.getElementById('realmLog');log.style.display='block';log.innerHTML='';
  const p=state.player,ri=REALMS.indexOf(p.realm);
  function addLog(t){log.innerHTML+=`<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.03)">${t}</div>`;log.scrollTop=log.scrollHeight}
  addLog(`ğŸŒ€ è¿›å…¥ã€Œ${name}ã€${comp?'ï¼ŒåŒä¼´ï¼š'+comp.name:''}â€¦`);
  addEvent('ç§˜å¢ƒ',`è¿›å…¥${name}${comp?'ï¼ˆæº'+comp.name+'ï¼‰':''}`);
  const stages=3+Math.floor(Math.random()*3);
  for(let i=0;i<stages;i++){
    await new Promise(r=>setTimeout(r,800));
    const roll=Math.random();
    if(roll<.25){
      // æˆ˜æ–—é­é‡ - ç»™ç©å®¶é€‰æ‹©
      const enemyPower=10+realm.level*15+Math.floor(Math.random()*20);
      const enemyName=['å¦–å…½','é­”ä¿®','é‚ªçµ','å¹»å…½'][Math.floor(Math.random()*4)];
      addLog(`âš”ï¸ ç¬¬${i+1}å±‚ï¼šé­é‡${enemyName}ï¼ˆæˆ˜åŠ›${enemyPower}ï¼‰ï¼`);
      const beastHelper=state.beasts.find(b=>b.tamed&&b.loyalty>=40);
      const choice=await showBattleChoice(enemyName,beastHelper,log);
      if(choice==='attack'){
        const dmg=10+ri*8+Math.floor(Math.random()*15);
        const eDmg=Math.floor(enemyPower*0.3+Math.random()*10);
        p.hp=Math.max(1,p.hp-eDmg);
        addLog(`ğŸ—¡ï¸ ä½ å‡ºæ‰‹é€ æˆ${dmg}ä¼¤å®³ï¼ä½†å—åˆ°${eDmg}åå‡»`);
        if(comp){const rel=state.relations[comp.id];if(rel)rel.love=Math.min(100,rel.love+2)}
        p.exp+=15+realm.level*5;
      }else if(choice==='skill'){
        if(p.mp>=15){p.mp-=15;addLog(`âœ¨ æœ¯æ³•æ”»å‡»ï¼è½»æ¾å‡»è´¥`);p.exp+=25+realm.level*8}
        else{addLog('çµåŠ›ä¸è¶³ï¼Œåªèƒ½ç¡¬æ‹¼ï¼');p.hp=Math.max(1,p.hp-Math.floor(enemyPower*0.4))}
      }else if(choice==='beast'&&beastHelper){
        addLog(`ğŸ¾ ${beastHelper.name}å‡ºå‡»ï¼`);beastHelper.power+=1;p.exp+=20+realm.level*5;
      }else if(choice==='flee'){
        if(Math.random()<0.6){addLog('ğŸƒ é€ƒè·‘æˆåŠŸï¼');continue}
        else{const eDmg=Math.floor(enemyPower*0.5);p.hp=Math.max(1,p.hp-eDmg);addLog(`é€ƒè·‘å¤±è´¥ï¼è¢«è¿½å‡» -${eDmg}æ°”è¡€`)}
      }
    }else if(roll<.5){
      const reward=realm.rewards[Math.floor(Math.random()*realm.rewards.length)];
      const eg=15+realm.level*10+Math.floor(Math.random()*20);p.exp+=eg;
      addLog(`âœ¨ ç¬¬${i+1}å±‚ï¼šå‘ç°${reward}ï¼+${eg}ä¿®ä¸º`);
      floatNum(`+${eg}ä¿®ä¸º`,'var(--gold)',window.innerWidth/2,window.innerHeight*0.3);
      if(name==='ä¸‡å…½å±±'&&Math.random()<.4){
        const td=BEAST_TYPES[Math.floor(Math.random()*BEAST_TYPES.length)];
        const bn=td.names[Math.floor(Math.random()*td.names.length)];
        if(Math.random()<td.tame+ri*.05){
          const pw=td.power[0]+Math.floor(Math.random()*(td.power[1]-td.power[0]));
          state.beasts.push({name:bn,type:td.type,power:pw,loyalty:td.type==='ç¥å…½'?60:td.type==='å¦–å…½'?20:50,tamed:td.type!=='å¦–å…½'});
          addLog(`ğŸ¾ æ•è·äº†${td.type}ã€Œ${bn}ã€ï¼`);addEvent('çµå…½',`ç§˜å¢ƒä¸­æ•è·${bn}ï¼`);
        }else addLog(`ğŸ¾ é‡åˆ°${td.type}ã€Œ${bn}ã€ä½†é€ƒè·‘äº†`);
      }
    }else if(roll<.75&&comp){
      const rel=state.relations[comp.id];if(rel)rel.love=Math.min(100,rel.love+5);
      addLog(`ğŸ’• ç¬¬${i+1}å±‚ï¼šä¸${comp.name}äº²å¯†äº’åŠ¨ +5å¥½æ„Ÿ`);
      floatNum('â¤ï¸+5','var(--pink)',window.innerWidth/2,window.innerHeight*0.3);
    }else{
      p.mp=Math.min(p.maxMp,p.mp+15);addLog(`ğŸŒ¿ ç¬¬${i+1}å±‚ï¼šçµæ³‰ +15çµåŠ›`);
    }
    if(p.exp>=p.maxExp){
      p.exp-=p.maxExp;const ni=Math.min(ri+1,REALMS.length-1);
      if(ni>REALMS.indexOf(p.realm)){
        p.realm=REALMS[ni];p.maxHp+=50;p.hp=p.maxHp;p.maxMp+=30;p.mp=p.maxMp;p.maxExp=Math.floor(p.maxExp*1.8);
        addLog(`ğŸ‰ çªç ´åˆ°${p.realm}ï¼`);addEvent('çªç ´','ç§˜å¢ƒçªç ´ï¼');
        screenFlash('var(--gold)',`çªç ´ï¼${p.realm}`);
      }
    }
    save();refreshAll();
  }
  await new Promise(r=>setTimeout(r,500));
  addLog(`ğŸ æ¢ç´¢å®Œæ¯•ï¼${comp?comp.name+'åŒå½’':'å®‰å…¨è¿”å›'}`);
  if(comp&&state.api.url&&state.api.key){
    addLog(`ğŸ’¬ ${comp.name}æœ‰è¯è¯´â€¦`);
    await callAI(comp,[{role:'user',content:`æˆ‘ä»¬é—¯å®Œ${name}äº†ï¼Œæ„Ÿæƒ³ï¼Ÿ`}],'realm',{
      appendChild(el){addLog(el.innerHTML)},scrollTop:0,set scrollHeight(v){}
    },reply=>{
      if(!state.chatHistories[comp.id])state.chatHistories[comp.id]=[];
      state.chatHistories[comp.id].push({role:'user',content:`ï¼ˆç§˜å¢ƒå½’æ¥ï¼‰é—¯å®Œ${name}ã€‚`},{role:'assistant',content:reply});
    });
  }
  save();refreshAll();
}

function showBattleChoice(enemyName,beast,logEl){
  return new Promise(resolve=>{
    const el=document.createElement('div');el.className='battle-choices';
    const btns=[
      ['attack','ğŸ—¡ï¸ æ”»å‡»'],
      ['skill','âœ¨ æœ¯æ³•(-15çµåŠ›)'],
      beast?['beast',`ğŸ¾ ${beast.name}å‡ºå‡»`]:null,
      ['flee','ğŸƒ é€ƒè·‘']
    ].filter(Boolean);
    btns.forEach(([val,label])=>{
      const b=document.createElement('button');b.textContent=label;
      b.onclick=()=>{el.remove();resolve(val)};
      el.appendChild(b);
    });
    logEl.appendChild(el);logEl.scrollTop=99999;
  });
}

// ========== è®¾ç½® ==========
function loadSettings(){
  document.getElementById('apiUrl').value=state.api.url||'';
  document.getElementById('apiKey').value=state.api.key||'';
  document.getElementById('apiModel').value=state.api.model||'gpt-4o';
  document.getElementById('apiMaxTokens').value=state.api.maxTokens||2048;
  document.getElementById('pcName').value=state.player.name||'';
  document.getElementById('pcGender').value=state.player.gender||'å¥³';
  document.getElementById('pcRealm').value=state.player.realm||'å‡¡äºº';
  document.getElementById('pcDesc').value=state.player.desc||'';
  document.getElementById('worldSetting').value=state.worldSetting||'';
}
function saveSettings(){
  state.api.url=document.getElementById('apiUrl').value.trim();
  state.api.key=document.getElementById('apiKey').value.trim();
  state.api.model=document.getElementById('apiModel').value.trim()||'gpt-4o';
  state.api.maxTokens=parseInt(document.getElementById('apiMaxTokens').value)||2048;
  state.player.name=document.getElementById('pcName').value.trim()||'æ— åä»™å­';
  state.player.gender=document.getElementById('pcGender').value;
  state.player.realm=document.getElementById('pcRealm').value;
  state.player.desc=document.getElementById('pcDesc').value.trim();
  state.worldSetting=document.getElementById('worldSetting').value.trim();
  save();refreshAll();
  const m=document.getElementById('saveMsg');m.textContent='âœ…å·²ä¿å­˜';setTimeout(()=>m.textContent='',2000);
}

// ========== é¡µé¢åˆ‡æ¢ ==========
function switchPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  document.getElementById('pg-'+name)?.classList.add('active');
  document.querySelector(`.nb[data-page="${name}"]`)?.classList.add('active');
  if(name==='interact')document.getElementById('notifChat').style.display='none';
}

// ========== äº‹ä»¶ç»‘å®š ==========
document.querySelectorAll('.subtab').forEach(btn=>{btn.addEventListener('click',function(){
  const parent=this.dataset.parent,sub=this.dataset.sub;
  const page=document.getElementById('pg-'+parent);if(!page)return;
  page.querySelectorAll('.subtab').forEach(t=>t.classList.remove('active'));
  page.querySelectorAll('.subpage').forEach(s=>s.classList.remove('active'));
  this.classList.add('active');
  document.getElementById('sub-'+sub)?.classList.add('active');
})});

document.querySelectorAll('.nb').forEach(btn=>{btn.addEventListener('click',()=>switchPage(btn.dataset.page))});
document.getElementById('chatSelect').addEventListener('change',function(){if(this.value){currentChatId=this.value;loadChat()}});
document.getElementById('msgSelect').addEventListener('change',function(){if(this.value){currentMsgId=this.value;loadMsgChat()}});

document.getElementById('sendBtn').addEventListener('click',()=>{
  const i=document.getElementById('chatInput'),t=i.value.trim();
  if(!t||sending)return;i.value='';i.style.height='auto';sendChat(t);
});
document.getElementById('msgSendBtn').addEventListener('click',()=>{
  const i=document.getElementById('msgInput'),t=i.value.trim();
  if(!t||sending)return;i.value='';i.style.height='auto';sendRemote(t);
});
document.getElementById('chatInput').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('sendBtn').click()}});
document.getElementById('msgInput').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('msgSendBtn').click()}});
[document.getElementById('chatInput'),document.getElementById('msgInput')].forEach(el=>{if(el)el.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,90)+'px'})});

// å¿«æ·åŠ¨ä½œæŒ‰é’®
document.querySelectorAll('[data-act]').forEach(btn=>{btn.addEventListener('click',()=>{
  if(!currentChatId)return alert('é€‰æ‹©NPC');
  const npc=state.npcs.find(n=>n.id===currentChatId);if(!npc)return;
  const act=btn.dataset.act;
  const map={
    'æ’’å¨‡':`*æ‹‰ä½${npc.name}çš„è¡£è¢–ï¼Œä»°å¤´çœ‹ç€å¯¹æ–¹* å“¼ï¼Œä½ éƒ½ä¸ç†æˆ‘â€¦`,
    'ç‰µæ‰‹':`*æ‚„æ‚„ä¼¸å‡ºæ‰‹ï¼Œç‰µä½${npc.name}çš„æ‰‹* â€¦èµ°å§ã€‚`,
    'ä¾å':`*è½»è½»é åœ¨${npc.name}è‚©ä¸Š* å°±è®©æˆ‘é ä¸€ä¼šå„¿â€¦`,
    'é€èŠ±':`*ä»èº«åæ‹¿å‡ºä¸€æœµçµèŠ±é€’è¿‡å»* é€ä½ çš„~`,
    'äº²äº²':`*è¸®èµ·è„šå°–ï¼Œåœ¨${npc.name}è„¸ä¸Šè½»è½»ä¸€å»* â€¦â€¦å˜¿å˜¿ã€‚`,
    'åˆ‡ç£‹':`*æ‹”å‡ºçµå‰‘* ${npc.name}ï¼Œæ¥åˆ‡ç£‹ä¸€ä¸‹ï¼Ÿ`,
    'å–‚ä¸¹è¯':`*æ‹¿å‡ºä¸€é¢—ä¸¹è¯é€’åˆ°${npc.name}å˜´è¾¹* ä¹–ï¼Œåƒè¯~`,
    'æŸ¥çœ‹çŠ¶æ€':`*çµè¯†è½»è½»æ¢å‘${npc.name}* è®©æˆ‘çœ‹çœ‹ä½ çš„çŠ¶æ€~`
  };
  if(act==='å–‚ä¸¹è¯'&&state.pills.length>0){state.pills.shift();save();updatePills()}
  sendChat(map[act]||act);
})});

document.querySelectorAll('[data-msg-act]').forEach(btn=>{btn.addEventListener('click',()=>{
  if(!currentMsgId)return alert('é€‰æ‹©ä¼ è®¯å¯¹è±¡');
  const npc=state.npcs.find(n=>n.id===currentMsgId);if(!npc)return;
  const act=btn.dataset.msgAct;
  const map={
    'æƒ³ä½ äº†':`${npc.name}â€¦æƒ³ä½ äº†ï¼Œä½ åœ¨åšä»€ä¹ˆå‘€ï¼Ÿ`,
    'åœ¨å¹²å˜›':`${npc.name}ï½ä½ ç°åœ¨åœ¨å¹²å˜›å‘€ï¼Ÿ`,
    'å¿«æ¥æ‰¾æˆ‘':`${npc.name}ï¼Œå¿«æ¥æ‰¾æˆ‘å˜›ï¼`,
    'ä¸€èµ·é—¯ç§˜å¢ƒå§':`${npc.name}ï¼Œæˆ‘å‘ç°äº†ä¸€å¤„ç§˜å¢ƒï¼Œä¸€èµ·å»æ¢æ¢ï¼Ÿ`
  };
  sendRemote(map[act]||act);
})});

// å¼¹çª—å…³é—­
document.querySelectorAll('.modal-mask').forEach(m=>{m.addEventListener('click',function(e){if(e.target===this)this.classList.remove('show')})});

// ========== NPCç¤¾äº¤ç½‘ç³»ç»Ÿ ==========
const RANDOM_NAMES_MALE=['æ²ˆæ¸…è¾','é¡¾é•¿æ­Œ','è§æ— è¡','è£´æ¸Š','æ¥šå¤œè¾°','æ¸©å¦‚ç‰','å‡Œéœ„','ç™½å­å¢¨','å¶çŸ¥ç§‹','è‹æ…•ç™½','æ±Ÿæ™šåŸ','é™†ä¹æ¸Š','è°¢æ— æœŸ','æŸ³éšé£','å®‹æ˜æ¾ˆ'];
const RANDOM_NAMES_FEMALE=['äº‘ç»¾ç»¾','æŸ³å¦‚çƒŸ','è‹æŒ½æœˆ','æ²ˆæ˜Ÿè½','é¡¾æ¸…æ¬¢','èŠ±åƒéª¨','å‡¤ä¹','ç™½æµ…','æ´›ç’ƒ','å§œé›¨æ™´','æ—å©‰å„¿','æ…•å®¹ç´«è‹±','ä¸Šå®˜å©‰å„¿','è§è–°å„¿','çº³å…°å«£ç„¶'];
const FRIEND_ACTIVITIES=['å–èŒ¶','åˆ‡ç£‹å‰‘æ³•','ä¸€èµ·ç‚¼ä¸¹','é€›åŠå¸‚','è®¨è®ºåŠŸæ³•','èµèŠ±','ä¸‹æ£‹','ä¸€èµ·ä¿®ç‚¼','é—²èŠ','å“é…’'];
const AMBIGUOUS_ACTIVITIES=['æœˆä¸‹æ•£æ­¥','å¹¶è‚©çœ‹æ˜Ÿæ˜Ÿ','äº’å–‚çµæœ','é åœ¨è‚©ä¸Šå°æ†©','ç‰µæ‰‹é€›å¤œå¸‚','å¯¹è§†å‘å‘†','æ•´ç†è¡£é¢†','æ“¦æ‹­å˜´è§’'];

function ensureSocialCircle(npcId){
  if(!state.socialNet)state.socialNet={};
  if(state.socialNet[npcId])return state.socialNet[npcId];
  // å…ˆç»™ä¸ªç©ºçš„ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨
  state.socialNet[npcId]={friends:[],rivals:[],lastGossip:0,generated:false};
  save();
  return state.socialNet[npcId];
}

async function aiGenerateSocialCircle(npcId){
  const social=ensureSocialCircle(npcId);
  if(social.generated&&social.friends.length)return social;
  if(!state.api.url||!state.api.key)return social;
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return social;

  const prompt=`ä½ æ˜¯ä¿®ä»™ä¸–ç•Œè®¾å®šç”Ÿæˆå™¨ã€‚è¯·ä¸ºè§’è‰²ã€Œ${npc.name}ã€ï¼ˆ${npc.gender}Â·${npc.realm}Â·${npc.role||'æ•£ä¿®'}Â·æ€§æ ¼ï¼š${npc.personality?.slice(0,50)||'æœªçŸ¥'}ï¼‰ç”Ÿæˆ2-4ä¸ªç¤¾äº¤åœˆå¥½å‹ã€‚
è¦æ±‚ï¼š
- åå­—è¦æœ‰ä»™ä¾ é£æ ¼ï¼Œä¸è¦å¤ªå¸¸è§
- æ¯ä¸ªå¥½å‹è¦æœ‰é²œæ˜ç‰¹ç‚¹
- å…¶ä¸­å¯ä»¥æœ‰1ä¸ªè·Ÿ${npc.name}å…³ç³»æš§æ˜§çš„ï¼ˆå¼‚æ€§ä¸ºä¸»ï¼‰
- ç®€çŸ­æè¿°å¤–è²Œå’Œæ€§æ ¼ç‰¹ç‚¹

ä¸¥æ ¼æŒ‰JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼š
[{"name":"åå­—","gender":"ç”·æˆ–å¥³","realm":"å¢ƒç•Œ","relation":"å¥½å‹æˆ–æš§æ˜§","personality":"ä¸€å¥è¯å¤–è²Œæ€§æ ¼ï¼ˆ20å­—å†…ï¼‰","closeness":äº²å¯†åº¦æ•°å­—20åˆ°80}]`;

  try{
    const r=await fetch(getApiUrl(),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},
      body:JSON.stringify({model:state.api.model,messages:[{role:'user',content:prompt}],max_tokens:500,temperature:1.0})});
    if(!r.ok)throw new Error(r.status);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'';
    const jsonMatch=reply.match(/\[[\s\S]*\]/);
    if(jsonMatch){
      const friends=JSON.parse(jsonMatch[0]);
      social.friends=friends.map(f=>({
        name:f.name||'æ— å',
        gender:f.gender||'ç”·',
        realm:f.realm||'é‡‘ä¸¹æœŸ',
        relation:f.relation||'å¥½å‹',
        personality:f.personality||'',
        closeness:f.closeness||50
      }));
      social.generated=true;
      save();
    }
  }catch(e){
    console.log('ç”Ÿæˆç¤¾äº¤åœˆå¤±è´¥:',e);
    // å¤±è´¥äº†å°±ç”¨ç®€å•çš„å¤‡ç”¨
    if(!social.friends.length){
      social.friends=[
        {name:'æŸä¿®å£«',gender:npc.gender==='å¥³'?'ç”·':'å¥³',realm:'é‡‘ä¸¹æœŸ',relation:'å¥½å‹',personality:'æ™®é€šä¿®å£«',closeness:40}
      ];
      save();
    }
  }
  return social;
}

function generateNpcScene(npcId){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return null;
  const social=ensureSocialCircle(npcId);
  const rel=state.relations[npcId]||{love:0,type:'é™Œç”Ÿäºº'};
  const roll=Math.random();
  if(roll<0.3||!social.friends.length){
    const soloActs=['ç‹¬è‡ªä¿®ç‚¼','åœ¨æ´åºœçœ‹ä¹¦','å¯¹ç€æœˆäº®å‘å‘†','åœ¨ç‚¼ä¸¹','æ•´ç†æ³•å™¨',
      rel.love>=60?'çœ‹ç€ä½ é€çš„çµèŠ±å‘å‘†':'',
      rel.love>=70?'ç¿»çœ‹å’Œä½ çš„ä¼ è®¯è®°å½•':'',
      rel.love>=80?'æŠ±ç€ä½ ç•™ä¸‹çš„å¤–è¡£å…¥ç¡':''].filter(Boolean);
    return {type:'solo',desc:soloActs[Math.floor(Math.random()*soloActs.length)]};
  }
  if(roll<0.7){
    const friend=social.friends[Math.floor(Math.random()*social.friends.length)];
    const act=FRIEND_ACTIVITIES[Math.floor(Math.random()*FRIEND_ACTIVITIES.length)];
    return {type:'friend',friend,activity:act,desc:`æ­£åœ¨å’Œ${friend.name}ï¼ˆ${friend.gender}Â·${friend.realm}Â·${friend.relation}${friend.personality?'Â·'+friend.personality:''}ï¼‰${act}`};
  }
  const ambFriends=social.friends.filter(f=>f.relation==='æš§æ˜§');
  if(ambFriends.length&&roll<0.85){
    const friend=ambFriends[Math.floor(Math.random()*ambFriends.length)];
    const act=AMBIGUOUS_ACTIVITIES[Math.floor(Math.random()*AMBIGUOUS_ACTIVITIES.length)];
    return {type:'ambiguous',friend,activity:act,desc:`æ­£åœ¨å’Œ${friend.name}ï¼ˆ${friend.gender}Â·${friend.personality||''}ï¼‰${act}`,suspicious:true};
  }
  if(roll<0.95&&social.friends.length){
    // è¢«ç¤¾äº¤åœˆå¤–çš„äººæ­è®ªï¼Œç”¨å¥½å‹çš„å¼‚æ€§åå­—å˜ä½“
    const stranger=npc.gender==='å¥³'?'æŸç”·ä¿®å£«':'æŸå¥³ä¿®å£«';
    return {type:'approached',stranger,desc:`è¢«${stranger}æ­è®ªä¸­`,suspicious:true};
  }
  return {type:'solo',desc:'åœ¨æ´åºœä¿®ç‚¼'};
}

async function enhancedCheck(id){
  const npc=state.npcs.find(n=>n.id===id);if(!npc)return;
  const rel=state.relations[id]||{love:0};

  document.getElementById('checkTitle').textContent=`ğŸ” å·çœ‹${npc.name}`;
  const el=document.getElementById('checkContent');
  document.getElementById('checkModal').classList.add('show');
  el.innerHTML='<div style="color:var(--dim);font-size:11px">çµè¯†æ¢å‡ºä¸­â€¦</div>';

  // å…ˆç¡®ä¿ç¤¾äº¤åœˆå·²ç”Ÿæˆ
  const social=ensureSocialCircle(id);
  if(!social.generated||!social.friends.length){
    el.innerHTML='<div style="color:var(--dim);font-size:11px">æ­£åœ¨æ¢æŸ¥ç¤¾äº¤åœˆâ€¦</div>';
    await aiGenerateSocialCircle(id);
  }

  const scene=generateNpcScene(id);

  // ç”¨AIè¯¦ç»†æå†™åœºæ™¯
  let scenePrompt='';
  if(scene.type==='ambiguous'){
    scenePrompt=`ï¼ˆç¬¬ä¸‰äººç§°ï¼Œ200å­—ï¼‰æå†™${npc.name}æ­£åœ¨å’Œ${scene.friend.name}ï¼ˆ${scene.friend.gender}Â·${scene.friend.personality||''}ï¼‰${scene.activity}çš„åœºæ™¯ã€‚è¦æœ‰ç¯å¢ƒæå†™ã€ä¸¤äººçš„ç¥æ€ã€åŠ¨ä½œç»†èŠ‚ã€æš§æ˜§æ°›å›´ã€‚${scene.friend.name}å¯¹${npc.name}æ˜æ˜¾æœ‰å¥½æ„Ÿã€‚`;
  }else if(scene.type==='approached'){
    scenePrompt=`ï¼ˆç¬¬ä¸‰äººç§°ï¼Œ200å­—ï¼‰æå†™${npc.name}æ­£åœ¨è¢«ä¸€ä¸ªå«${scene.stranger}çš„ä¿®å£«æ­è®ªçš„åœºæ™¯ã€‚è¦æœ‰ç¯å¢ƒæå†™ã€${scene.stranger}çš„å¤–è²Œä¸¾æ­¢ã€${npc.name}çš„ç¥æ€ååº”ã€‚æ ¹æ®${npc.name}çš„æ€§æ ¼ï¼ˆå¥½æ„Ÿ${rel.love}ï¼‰å†³å®štaæ˜¯å†·æ·¡æ‹’ç»è¿˜æ˜¯ç¤¼è²Œåº”å¯¹ã€‚`;
  }else if(scene.type==='friend'){
    scenePrompt=`ï¼ˆç¬¬ä¸‰äººç§°ï¼Œ200å­—ï¼‰æå†™${npc.name}æ­£åœ¨å’Œå¥½å‹${scene.friend.name}ï¼ˆ${scene.friend.gender}Â·${scene.friend.personality||''}ï¼‰${scene.activity}çš„åœºæ™¯ã€‚è¦æœ‰ç¯å¢ƒæå†™ã€ä¸¤äººçš„å¯¹è¯ã€ç¥æ€ã€‚æ°”æ°›è½»æ¾å‹å¥½ã€‚`;
  }else{
    scenePrompt=`ï¼ˆç¬¬ä¸‰äººç§°ï¼Œ200å­—ï¼‰æå†™${npc.name}ç‹¬å¤„æ—¶${scene.desc}çš„åœºæ™¯ã€‚è¦æœ‰ç¯å¢ƒæå†™ã€ç¥æ€ã€å†…å¿ƒæ´»åŠ¨ã€‚${rel.love>=60?'taå¿ƒé‡Œæƒ³ç€'+state.player.name:''}`;
  }

  // è°ƒAIç”Ÿæˆè¯¦ç»†åœºæ™¯
  let detailedScene='';
  if(state.api.url&&state.api.key){
    try{
      const msgs=[{role:'system',content:buildSys(npc,'status')},{role:'user',content:scenePrompt}];
      const r=await fetch(getApiUrl(),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},
        body:JSON.stringify({model:state.api.model,messages:msgs,max_tokens:600,temperature:.9})});
      if(r.ok){
        const d=await r.json();
        detailedScene=d.choices?.[0]?.message?.content||'';
      }
    }catch(e){console.log('åœºæ™¯ç”Ÿæˆå¤±è´¥:',e)}
  }

  // æ˜¾ç¤ºåœºæ™¯
  let sceneHtml=`<div style="padding:12px;background:rgba(160,112,224,.06);border:1px solid rgba(160,112,224,.12);border-radius:8px;margin-bottom:12px">`;
  sceneHtml+=`<div style="font-size:11px;color:var(--dim);margin-bottom:6px">ä½ æ‚„æ‚„æ¢å‡ºçµè¯†â€¦</div>`;
  if(detailedScene){
    sceneHtml+=`<div style="font-size:12px;line-height:1.8;color:var(--text)">${esc(detailedScene)}</div>`;
  }else{
    sceneHtml+=`<div style="font-size:13px;color:var(--text)">${npc.name}${scene.desc}</div>`;
  }
  if(scene.suspicious){
    sceneHtml+=`<div style="margin-top:8px;color:var(--danger);font-size:11px">âš ï¸ çœ‹èµ·æ¥æœ‰ç‚¹å¯ç–‘â€¦</div>`;
  }
  sceneHtml+=`</div>`;

  // é€‰é¡¹
  let choicesHtml='<div style="display:flex;flex-direction:column;gap:6px">';
  if(scene.type==='ambiguous'||scene.type==='approached'){
    const targetName=scene.friend?.name||scene.stranger;
    choicesHtml+=`<button class="event-choice" onclick="checkConfront('${id}','${targetName}')">ğŸ˜¤ å†²è¿‡å»è´¨é—®</button>`;
    choicesHtml+=`<button class="event-choice" onclick="checkWatch('${id}','${targetName}')">ğŸ‘€ ç»§ç»­å·çœ‹</button>`;
    choicesHtml+=`<button class="event-choice" onclick="checkLeave('${id}')">ğŸ˜¢ é»˜é»˜ç¦»å¼€</button>`;
  }else if(scene.type==='friend'){
    choicesHtml+=`<button class="event-choice" onclick="checkJoin('${id}','${scene.friend.name}')">ğŸ‘‹ è¿‡å»æ‰“æ‹›å‘¼</button>`;
    choicesHtml+=`<button class="event-choice" onclick="checkWatch('${id}','${scene.friend.name}')">ğŸ‘€ ç»§ç»­å·çœ‹</button>`;
    choicesHtml+=`<button class="event-choice" onclick="checkLeave('${id}')">ğŸš¶ ä¸æ‰“æ‰°äº†</button>`;
  }else{
    choicesHtml+=`<button class="event-choice" onclick="checkSurprise('${id}')">ğŸ‰ çªç„¶å‡ºç°å“ta</button>`;
    choicesHtml+=`<button class="event-choice" onclick="checkWatch('${id}','')">ğŸ‘€ ç»§ç»­å·çœ‹</button>`;
    choicesHtml+=`<button class="event-choice" onclick="checkLeave('${id}')">ğŸš¶ ä¸æ‰“æ‰°äº†</button>`;
  }
  choicesHtml+='</div>';

  el.innerHTML=sceneHtml+choicesHtml+'<div id="checkAIResult" style="margin-top:12px"></div>';
}

async function checkConfront(npcId,rivalName){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return;
  const rel=state.relations[npcId];
  const el=document.getElementById('checkAIResult');
  document.querySelectorAll('#checkContent .event-choice').forEach(b=>b.disabled=true);
  addEvent('ä¿®ç½—åœº',`ä½ å†²è¿‡å»è´¨é—®${npc.name}å’Œ${rivalName}çš„å…³ç³»ï¼`);
  const prompt=`*${state.player.name}çªç„¶å‡ºç°ï¼Œçœ‹åˆ°ä½ å’Œ${rivalName}åœ¨ä¸€èµ·ï¼Œè¡¨æƒ…ä¸å¤ªå¥½çœ‹*\n"${npc.name}ï¼Œä½ åœ¨å¹²ä»€ä¹ˆï¼Ÿè¿™ä¸ª${rivalName}æ˜¯è°ï¼Ÿ"\nï¼ˆè¯·æ ¹æ®å¥½æ„Ÿåº¦${rel.love}å’Œä½ çš„æ€§æ ¼å›åº”ã€‚å¥½æ„Ÿé«˜åˆ™è§£é‡Šå®‰æ…°ï¼Œå¥½æ„Ÿä½åˆ™å¯èƒ½ä¸è€çƒ¦ã€‚è¦æå†™${rivalName}çš„ååº”ã€‚ï¼‰`;
  if(!state.chatHistories[npcId])state.chatHistories[npcId]=[];
  state.chatHistories[npcId].push({role:'user',content:prompt});
  await callAIModal(npc,'face',el);
  if(rel.love>=70){rel.love=Math.min(100,rel.love+3);floatNum('â¤ï¸+3ï¼ˆè§£é‡Šæ¸…æ¥šäº†ï¼‰','var(--green)',window.innerWidth/2,window.innerHeight*0.3)}
  else if(rel.love>=40){floatNum('ğŸ˜… æœ‰ç‚¹å°´å°¬','var(--orange)',window.innerWidth/2,window.innerHeight*0.3)}
  else{rel.love=Math.max(0,rel.love-5);floatNum('ğŸ’”-5ï¼ˆå«Œä½ å¤šç®¡é—²äº‹ï¼‰','var(--danger)',window.innerWidth/2,window.innerHeight*0.3)}
  save();refreshAll();
}

async function checkWatch(npcId,targetName){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return;
  const el=document.getElementById('checkAIResult');
  document.querySelectorAll('#checkContent .event-choice').forEach(b=>b.disabled=true);
  el.innerHTML='<div style="color:var(--dim)">ç»§ç»­å·çœ‹ä¸­â€¦</div>';

  const social=state.socialNet?.[npcId];
  const friendInfo=social?.friends?.find(f=>f.name===targetName);
  const friendDesc=friendInfo?`ï¼ˆ${friendInfo.gender}Â·${friendInfo.personality||''}Â·ä¸${npc.name}${friendInfo.relation}ï¼‰`:'';

  const prompt=targetName?
    `ï¼ˆç¬¬ä¸‰äººç§°ï¼Œ300å­—ï¼Œè¦éå¸¸è¯¦ç»†ï¼‰ä½ ç»§ç»­å·çœ‹${npc.name}å’Œ${targetName}${friendDesc}ã€‚æå†™æ¥ä¸‹æ¥çš„äº’åŠ¨ï¼šå¯¹è¯å†…å®¹ã€è¡¨æƒ…å˜åŒ–ã€è‚¢ä½“åŠ¨ä½œã€æ°›å›´ã€‚${friendInfo?.relation==='æš§æ˜§'?targetName+'å¯¹'+npc.name+'æœ‰æ˜æ˜¾çš„æš§æ˜§ä¸¾åŠ¨ï¼Œæå†™'+npc.name+'çš„å¾®å¦™ååº”ã€‚':'ä¸¤äººå…³ç³»æ­£å¸¸ï¼Œä½†è¦æœ‰ç”ŸåŠ¨çš„äº’åŠ¨ç»†èŠ‚ã€‚'}`:
    `ï¼ˆç¬¬ä¸‰äººç§°ï¼Œ300å­—ï¼Œè¦éå¸¸è¯¦ç»†ï¼‰ä½ ç»§ç»­å·çœ‹${npc.name}ç‹¬å¤„ã€‚æå†™taçš„åŠ¨ä½œã€è¡¨æƒ…ã€å†…å¿ƒç‹¬ç™½ã€‚${state.relations[npcId]?.love>=50?'taä¸ç»æ„é—´æƒ³èµ·äº†'+state.player.name+'ï¼Œç¥è‰²æœ‰äº†å¾®å¦™å˜åŒ–ã€‚':''}`;

  const msgs=[{role:'system',content:buildSys(npc,'status')},{role:'user',content:prompt}];
  try{
    const r=await fetch(getApiUrl(),{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.api.key},
      body:JSON.stringify({model:state.api.model,messages:msgs,max_tokens:800,temperature:.9})});
    if(!r.ok)throw new Error(r.status);
    const d=await r.json(),reply=d.choices?.[0]?.message?.content||'ï¼ˆçœ‹ä¸æ¸…äº†â€¦ï¼‰';
    el.innerHTML=`<div style="font-size:12px;line-height:1.8">${esc(reply)}</div>`;
    parseReply(npcId,reply);save();refreshAll();
  }catch(e){el.innerHTML=`<span style="color:var(--danger)">çµè¯†è¢«å¹²æ‰°äº†ï¼š${e.message}</span>`}
}

async function checkJoin(npcId,friendName){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return;
  const rel=state.relations[npcId];
  const el=document.getElementById('checkAIResult');
  document.querySelectorAll('#checkContent .event-choice').forEach(b=>b.disabled=true);
  const prompt=`*${state.player.name}èµ°è¿‡æ¥æ‰“æ‹›å‘¼* "å—¨~ä½ ä»¬åœ¨å¹²å˜›å‘€ï¼Ÿ"\nï¼ˆ${npc.name}çœ‹åˆ°${state.player.name}æ¥äº†ï¼Œæ ¹æ®å¥½æ„Ÿåº¦${rel.love}ååº”ã€‚åŒæ—¶æå†™${friendName}çš„ååº”ã€‚ï¼‰`;
  if(!state.chatHistories[npcId])state.chatHistories[npcId]=[];
  state.chatHistories[npcId].push({role:'user',content:prompt});
  await callAIModal(npc,'face',el);
  rel.love=Math.min(100,rel.love+2);
  floatNum('â¤ï¸+2','var(--pink)',window.innerWidth/2,window.innerHeight*0.3);
  save();refreshAll();
}

async function checkSurprise(npcId){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return;
  const rel=state.relations[npcId];
  const el=document.getElementById('checkAIResult');
  document.querySelectorAll('#checkContent .event-choice').forEach(b=>b.disabled=true);
  const prompt=`*${state.player.name}çªç„¶ä»èƒŒåå‡ºç°ï¼Œæ‚ä½${npc.name}çš„çœ¼ç›* "çŒœçŒœæˆ‘æ˜¯è°ï½"`;
  if(!state.chatHistories[npcId])state.chatHistories[npcId]=[];
  state.chatHistories[npcId].push({role:'user',content:prompt});
  await callAIModal(npc,'face',el);
  if(rel.love>=50){rel.love=Math.min(100,rel.love+3);floatNum('â¤ï¸+3','var(--pink)',window.innerWidth/2,window.innerHeight*0.3)}
  else{rel.love=Math.max(0,rel.love-2);floatNum('ğŸ’”-2ï¼ˆè¢«å“åˆ°äº†ï¼‰','var(--danger)',window.innerWidth/2,window.innerHeight*0.3)}
  save();refreshAll();
}

function checkLeave(npcId){
  const el=document.getElementById('checkAIResult');
  document.querySelectorAll('#checkContent .event-choice').forEach(b=>b.disabled=true);
  el.innerHTML='<div style="color:var(--dim);font-size:11px;padding:8px">ä½ é»˜é»˜æ”¶å›çµè¯†ï¼Œè½¬èº«ç¦»å¼€äº†â€¦</div>';
  addEvent('æŸ¥å²—','ä½ å·çœ‹äº†ä¸€çœ¼å°±èµ°äº†');
}

// ========== æƒ…æ•Œç³»ç»Ÿ ==========
const RIVAL_EVENTS=[
  {title:'ğŸ’ æœ‰äººé€èŠ±',template:(npc,rival)=>`ä½ æ”¶åˆ°æ¶ˆæ¯ï¼šæœ‰ä¸ªå«${rival}çš„${npc.gender==='å¥³'?'ç”·':'å¥³'}ä¿®å£«ç»™${npc.name}é€äº†ä¸€æŸçµèŠ±ï¼`},
  {title:'ğŸ’Œ æƒ…ä¹¦',template:(npc,rival)=>`${npc.name}æ”¶åˆ°äº†${rival}çš„è¡¨ç™½ä¿¡ï¼æ®è¯´å†™å¾—å¾ˆè‚‰éº»â€¦`},
  {title:'ğŸµ é‚€çº¦',template:(npc,rival)=>`${rival}é‚€è¯·${npc.name}å»å“èŒ¶ï¼Œ${npc.name}ä¼¼ä¹åœ¨çŠ¹è±«è¦ä¸è¦å»â€¦`},
  {title:'ğŸŒ™ å¤œè®¿',template:(npc,rival)=>`æ·±å¤œï¼Œ${rival}å‡ºç°åœ¨${npc.name}çš„æ´åºœé—¨å£â€¦`},
  {title:'ğŸ’ª è‹±é›„æ•‘ç¾',template:(npc,rival)=>`${npc.name}åœ¨å¤–é‡é™©ï¼Œ${rival}æ°å¥½è·¯è¿‡å‡ºæ‰‹ç›¸æ•‘ï¼`},
  {title:'ğŸ é‡ç¤¼',template:(npc,rival)=>`${rival}é€äº†${npc.name}ä¸€ä»¶çè´µæ³•å™¨ï¼Œæ®è¯´ä»·å€¼è¿åŸâ€¦`}
];

function triggerRivalEvent(){
  if(!state.npcs.length)return;
  const candidates=state.npcs.filter(n=>{
    const rel=state.relations[n.id];
    return rel&&rel.love<85;
  });
  if(!candidates.length)return;
  const npc=candidates[Math.floor(Math.random()*candidates.length)];
  const rel=state.relations[npc.id];
  const social=ensureSocialCircle(npc.id);
  const rivalPool=npc.gender==='å¥³'?RANDOM_NAMES_MALE:RANDOM_NAMES_FEMALE;
  let rivalName;
  const ambFriend=social.friends.find(f=>f.relation==='æš§æ˜§');
  if(ambFriend&&Math.random()<0.6){
    rivalName=ambFriend.name;
  }else{
    rivalName=rivalPool[Math.floor(Math.random()*rivalPool.length)];
  }
  const evt=RIVAL_EVENTS[Math.floor(Math.random()*RIVAL_EVENTS.length)];
  const desc=evt.template(npc,rivalName);
  if(!social.rivals.includes(rivalName))social.rivals.push(rivalName);
  save();
  showEventModal({
    title:`âš¡ ${evt.title}`,
    desc:desc,
    choices:[
      {text:'ğŸ˜¤ ç«‹åˆ»å»æ‰¾taï¼',action:()=>{rivalConfront(npc.id,rivalName)}},
      {text:`ğŸ“¨ ä¼ è®¯é—®${npc.name}`,action:()=>{rivalAsk(npc.id,rivalName)}},
      {text:'ğŸ˜’ è£…ä½œä¸çŸ¥é“',action:()=>{
        if(rel.love>=50&&Math.random()<0.3){
          rel.love=Math.max(0,rel.love-3);
          floatNum('ğŸ’”-3ï¼ˆtaæœ‰ç‚¹å¤±æœ›ä½ ä¸åœ¨æ„ï¼‰','var(--danger)',window.innerWidth/2,window.innerHeight*0.3);
        }
        addEvent('æƒ…æ•Œ',`ä½ æ— è§†äº†${rivalName}å¯¹${npc.name}çš„è¿½æ±‚`);
        save();refreshAll();
      }}
    ]
  });
}

async function rivalConfront(npcId,rivalName){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return;
  const rel=state.relations[npcId];
  addEvent('ä¿®ç½—åœº',`ä½ å»æ‰¾${rivalName}ç†è®ºï¼`);
  startChat(npcId);
  const confrontText=`*ä½ æ‰¾åˆ°${npc.name}ï¼Œå‘ç°${rivalName}ä¹Ÿåœ¨ã€‚ä½ èµ°ä¸Šå‰ï¼ŒæŒ¡åœ¨${npc.name}é¢å‰ï¼Œå†·å†·çœ‹ç€${rivalName}*\n"${rivalName}æ˜¯å§ï¼Ÿç¦»${npc.name}è¿œç‚¹ã€‚"`;
  await sendChat(confrontText);
  if(rel.love>=60){
    rel.love=Math.min(100,rel.love+5);
    floatNum('â¤ï¸+5ï¼ˆè¢«ä½ æŠ¤ä½å¾ˆå¼€å¿ƒï¼‰','var(--pink)',window.innerWidth/2,window.innerHeight*0.3);
    screenFlash('var(--pink)','');
  }else if(rel.love>=30){
    rel.love=Math.min(100,rel.love+2);
    floatNum('â¤ï¸+2ï¼ˆæœ‰ç‚¹æ„å¤–ï¼‰','var(--pink)',window.innerWidth/2,window.innerHeight*0.3);
  }else{
    floatNum('ğŸ˜…ï¼ˆè§‰å¾—ä½ è«åå…¶å¦™ï¼‰','var(--orange)',window.innerWidth/2,window.innerHeight*0.3);
  }
  save();refreshAll();
}

async function rivalAsk(npcId,rivalName){
  const npc=state.npcs.find(n=>n.id===npcId);if(!npc)return;
  currentMsgId=npcId;
  document.getElementById('msgSelect').value=npcId;
  switchPage('interact');
  document.querySelector('[data-sub="msg"]').click();
  loadMsgChat();
  const askText=`${npc.name}â€¦æˆ‘å¬è¯´${rivalName}å¯¹ä½ â€¦ä½ ä»¬ä»€ä¹ˆå…³ç³»ï¼Ÿ`;
  await sendRemote(askText);
}

// ========== NPCå…«å¦ç³»ç»Ÿ ==========
function npcGossipTick(){
  if(state.npcs.length<2)return;
  state.npcs.forEach(npc=>{
    const rel=state.relations[npc.id];if(!rel||rel.love<40)return;
    if(Math.random()>0.2)return;
    const others=state.npcs.filter(n=>n.id!==npc.id&&(state.relations[n.id]?.love||0)>=30);
    if(!others.length)return;
    const other=others[Math.floor(Math.random()*others.length)];
    const otherRel=state.relations[other.id];
    const gossips=[
      `${npc.name}ä¼ è®¯é—®ä½ ï¼š"ä½ å’Œ${other.name}â€¦æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"`,
      `${npc.name}è¯´ï¼š"æˆ‘ä»Šå¤©ç¢°åˆ°${other.name}äº†ï¼Œtaé—®äº†å¥½å¤šå…³äºä½ çš„äº‹â€¦"`,
      `${npc.name}é…¸æºœæºœåœ°è¯´ï¼š"å¬è¯´ä½ æœ€è¿‘å’Œ${other.name}èµ°å¾—å¾ˆè¿‘ï¼Ÿ"`,
      rel.love>=70?`${npc.name}å°å£°è¯´ï¼š"${other.name}æ˜¯ä¸æ˜¯ä¹Ÿå–œæ¬¢ä½ â€¦æˆ‘æœ‰ç‚¹ä¸å®‰ã€‚"`:'',
      otherRel.love>=60?`${npc.name}è¯´ï¼š"${other.name}å¥½åƒå¯¹ä½ æœ‰æ„æ€ï¼Œä½ çŸ¥é“å—ï¼Ÿ"`:'',
    ].filter(Boolean);
    if(!gossips.length)return;
    const msg=gossips[Math.floor(Math.random()*gossips.length)];
    if(!state.msgHistories[npc.id])state.msgHistories[npc.id]=[];
    state.msgHistories[npc.id].push({role:'assistant',content:msg});
    showToast(`ğŸ“¨ ${npc.name}ï¼š${msg.slice(0,25)}â€¦`,()=>{
      currentMsgId=npc.id;
      document.getElementById('msgSelect').value=npc.id;
      switchPage('interact');
      document.querySelector('[data-sub="msg"]').click();
      loadMsgChat();
    });
    document.getElementById('notifChat').style.display='block';
    addEvent('å…«å¦',msg);
    save();
  });
}

// ========== NPCå¥½æ„Ÿè¡°å‡ ==========
function loveDecayTick(){
  state.npcs.forEach(npc=>{
    const rel=state.relations[npc.id];if(!rel)return;
    if(rel.love>50&&state.lastTalkTo!==npc.id){
      if(Math.random()<0.15){
        rel.love=Math.max(40,rel.love-1);
      }
    }
  });
  save();refreshAll();
}

// ========== å®šæ—¶å™¨ ==========
setInterval(()=>{
  if(state.player.mp<state.player.maxMp){
    state.player.mp=Math.min(state.player.maxMp,state.player.mp+5);
    save();updatePlayerUI();
  }
},30000);

setInterval(()=>{
  npcAutonomyTick();
  npcGossipTick();
  loveDecayTick();
},3600000);

setInterval(()=>{
  if(Math.random()<0.3&&state.npcs.length>0){
    if(Math.random()<0.3){
      triggerRivalEvent();
    }else{
      triggerRandomEvent();
    }
  }
},90000);

// ========== åˆå§‹åŒ– ==========
loadSettings();
refreshAll();
state.npcs.forEach(n=>ensureSocialCircle(n.id));
</script>
</body>
</html>